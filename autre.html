<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Espace secretary - hybrilink</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<!-- PWA Meta Tags -->
  <meta name="application-name" content="TheoVêt">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="TheoVêt">
  <meta name="description" content="Solution complète de gestion de commerce de vêtements">
  <meta name="format-detection" content="telephone=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="msapplication-TileColor" content="#3498db">
  <meta name="msapplication-tap-highlight" content="no">
  <meta name="theme-color" content="#3498db">



<!-- Service Worker et mise à jour -->
    <meta name="version" content="2.1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">



  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" href="icon-192x192.png">
  <link rel="apple-touch-icon" sizes="192x192" href="icon-192x192.png">
  <link rel="apple-touch-icon" sizes="72x72" href="icon-72x72.png">
  <link rel="apple-touch-icon" sizes="167x167" href="icon-167x167.png">

  <!-- Manifest -->
  <link rel="manifest" href="manifest.json">

  <!-- Styles et Bibliothèques -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<!-- Scripts de mise à jour -->
<script src="update-system.js"></script>
    
    <style>
        :root {
            --primary: #3498db; --secondary: #2c3e50; --success: #27ae60;
            --danger: #e74c3c; --warning: #f39c12; --info: #1abc9c;
            --light: #ecf0f1; --dark: #34495e;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background-color: #f5f6fa; }
        .hidden { display: none !important; }
        
        /* --- Styles Communs --- */
        .app-container { display: flex; min-height: 100vh; }
        .sidebar { width: 250px; background: white; box-shadow: 2px 0 10px rgba(0,0,0,0.08); flex-shrink: 0; transition: transform 0.3s ease; }
        .sidebar.collapsed { transform: translateX(-100%); }
        .nav-menu { list-style: none; padding: 1rem 0; margin: 0; }
        .nav-menu li a { display: flex; align-items: center; gap: 12px; padding: 14px 20px; color: var(--dark); text-decoration: none; font-weight: 500; }
        .nav-menu li a.active, .nav-menu li a:hover { background: #eaf5fc; color: var(--primary); }
        .main-content { flex: 1; display: flex; flex-direction: column; }
        .app-header { background: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
        .content-area { padding: 2rem; }
        .page { display: none; }
        .page.active { display: block; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: 500; color: white; }
        .btn-primary { background: var(--primary); }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        .btn-warning { background: var(--warning); }
        .btn-info { background: var(--info); }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .card { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 1.5rem; }
        .form-row { display: flex; gap: 1rem; }
        .alert { padding: 1rem; border-radius: 5px; margin-bottom: 1rem; }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-error { background: #f8d7da; color: #721c24; }
        .alert-info { background: #d1ecf1; color: #0c5460; }
        
        /* --- Styles spécifiques --- */
        .photo-upload { text-align: center; margin: 1rem 0; }
        .photo-preview { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); margin: 0 auto 1rem; display: block; }
        .photo-placeholder { width: 120px; height: 120px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; color: #999; }
        .file-input { display: none; }
        .upload-btn { background: var(--info); color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; }
        .currency-input-group { position: relative; }
        .currency-symbol { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #666; font-weight: bold; }
        .currency-input { padding-left: 25px; }
        .currency-display { font-weight: bold; color: var(--success); }
        
        /* --- Tabs --- */
        .tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 1.5rem; }
        .tab { padding: 10px 20px; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab.active { border-bottom: 2px solid var(--primary); color: var(--primary); font-weight: 500; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* --- Table styles --- */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; font-weight: 600; }
        tr:hover { background-color: #f8f9fa; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 500; }
        .badge-success { background-color: var(--success); color: white; }
        .badge-warning { background-color: var(--warning); color: white; }
        .badge-danger { background-color: var(--danger); color: white; }
        .badge-info { background-color: var(--info); color: white; }
        .action-buttons { display: flex; gap: 0.5rem; }
        .action-buttons button { padding: 6px 12px; font-size: 0.85rem; }
        
        /* --- Modal styles --- */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 2rem; border-radius: 10px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .close-modal { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; }
        
        /* --- Styles pour le communiqué --- */
        .communique-preview { background: white; padding: 2rem; border: 1px solid #ddd; font-family: 'Times New Roman', serif; }
        .communique-header { text-align: center; margin-bottom: 2rem; }
        .communique-logo { max-width: 150px; margin-bottom: 1rem; }
        .communique-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem; }
        .communique-date { text-align: right; margin-bottom: 2rem; font-style: italic; }
        .communique-content { line-height: 1.6; }
        .communique-signature { margin-top: 3rem; text-align: right; }
        .signature-line { border-top: 1px solid #000; margin-top: 3rem; width: 300px; margin-left: auto; }
        
        /* --- Styles pour les mois multiples --- */
        .months-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 0.5rem; margin: 1rem 0; }
        .month-checkbox { display: flex; align-items: center; gap: 0.5rem; }
        
        /* --- Menu toggle pour mobile --- */
        .menu-toggle { display: none; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--dark); }
        
        @media (max-width: 768px) {
            .menu-toggle { display: block; }
            .sidebar { position: fixed; z-index: 1000; height: 100%; }
            .main-content { margin-left: 0; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <nav class="sidebar">
            <div style="padding: 1.5rem; text-align: center; border-bottom: 1px solid #eee;">
                <i class="fas fa-cogs" style="font-size: 2rem; color: var(--primary);"></i>
                <h3 style="margin-top: 0.5rem;">Gestion Personnelle</h3>
            </div>
            <ul class="nav-menu">
                <li><a href="#" class="active" data-page="workers"><i class="fas fa-hard-hat fa-fw"></i> Personnels Ouvriers</a></li>
                <li><a href="#" data-page="communication"><i class="fas fa-bullhorn fa-fw"></i> Communication</a></li>
                <li><a href="#" data-page="salaries"><i class="fas fa-money-check-alt fa-fw"></i> Paiement Salaires</a></li>
                <li><a href="#" data-page="archive"><i class="fas fa-archive fa-fw"></i> Archives</a></li>
                <button class="back-btn" onclick="window.location.href='index.html'" style='font-size:15; background-color:#333;'>
                <i class="fas fa-arrow-left"></i>
                Retour au Portail
            </button>
            </ul>
        </nav>
        <div class="main-content">
            <header class="app-header">
                <button class="menu-toggle" id="menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h2 id="page-title">Personnels Ouvriers</h2>
            </header>
            <main class="content-area">
                <div id="global-alert" class="alert hidden"></div>

                <!-- Page: Personnels Ouvriers -->
                <div id="workers-page" class="page active">
                    <div class="card">
                        <h4>Créer un nouveau personnel ouvrier</h4>
                        <form id="worker-form">
                            <!-- Photo de profil -->
                            <div class="photo-upload">
                                <div class="photo-placeholder" id="worker-photo-preview">
                                    <i class="fas fa-user"></i>
                                </div>
                                <input type="file" id="worker-photo" class="file-input" accept="image/*">
                                <button type="button" class="upload-btn" onclick="document.getElementById('worker-photo').click()">
                                    <i class="fas fa-upload"></i> Choisir une photo
                                </button>
                            </div>

                            <div class="form-row">
                                <div class="form-group" style="flex: 2;">
                                    <label>Nom Complet *</label>
                                    <input type="text" id="worker-name" class="form-control" required>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Date de Naissance *</label>
                                    <input type="date" id="worker-birthdate" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Lieu de Naissance *</label>
                                    <input type="text" id="worker-birthplace" class="form-control" required>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Sexe *</label>
                                    <select id="worker-gender" class="form-control" required>
                                        <option value="">Sélectionner</option>
                                        <option value="M">Masculin</option>
                                        <option value="F">Féminin</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Adresse de Résidence *</label>
                                <input type="text" id="worker-address" class="form-control" required>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Numéro de Téléphone *</label>
                                    <input type="tel" id="worker-phone" class="form-control" required>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Fonction *</label>
                                    <select id="worker-function" class="form-control" required>
                                        <option value="">Sélectionner</option>
                                        <option value="Agent de service">Agent de service</option>
                                        <option value="Gardien">Gardien</option>
                                        <option value="Cuisinier">Cuisinier</option>
                                        <option value="Secrétaire">Secrétaire</option>
                                        <option value="Autre">Autre</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Description / Commentaires</label>
                                <textarea id="worker-description" class="form-control" rows="3" placeholder="Informations supplémentaires..."></textarea>
                            </div>
                            
                            <button type="submit" class="btn btn-primary" id="worker-submit-btn">
                                Créer le Personnel
                            </button>
                        </form>
                        
                        <div id="worker-success" class="alert alert-success hidden" style="margin-top: 1rem;">
                            <h4>Personnel créé avec succès !</h4>
                            <p><strong>Matricule:</strong> <span id="worker-matricule"></span></p>
                            <p><strong>Nom:</strong> <span id="worker-fullname"></span></p>
                            <p><strong>Fonction:</strong> <span id="worker-function-display"></span></p>
                            <button class="btn btn-success" onclick="printWorkerCard()">
                                <i class="fas fa-print"></i> Imprimer la Carte
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h4>Liste des personnels ouvriers</h4>
                        <div class="search-box" style="margin-bottom: 1rem;">
                            <input type="text" id="worker-search" class="form-control" placeholder="Rechercher par matricule, nom ou fonction...">
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Matricule</th>
                                        <th>Photo</th>
                                        <th>Nom</th>
                                        <th>Fonction</th>
                                        <th>Téléphone</th>
                                        <th>Date d'embauche</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="workers-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Page: Communication -->
                <div id="communication-page" class="page">
                    <div class="card">
                        <h4>Créer un communiqué de paiement</h4>
                        <form id="communique-form">
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Type de frais *</label>
                                    <select id="communique-fee-type" class="form-control" required>
                                        <option value="">Sélectionner</option>
                                        <option value="Frais scolaires">Frais scolaires</option>
                                        <option value="Frais de l'état">Frais de l'état</option>
                                        <option value="visite">Visite</option>
                                        <option value="achat pull">Achat pull</option>
                                        <option value="Frais d'inscription">Frais d'inscription</option>
                                        <option value="Autres">Autres (spécifier ci-dessous)</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Autres frais (si autre)</label>
                                    <input type="text" id="communique-other-fee" class="form-control" placeholder="Spécifiez le type de frais">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Date limite de paiement *</label>
                                    <input type="date" id="communique-deadline" class="form-control" required>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Année scolaire *</label>
                                    <select id="communique-school-year" class="form-control" required>
                                        <option value="">Sélectionner</option>
                                        <option value="2023-2024">2023-2024</option>
                                        <option value="2024-2025">2024-2025</option>
                                        <option value="2025-2026">2025-2026</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Mois concerné *</label>
                                    <select id="communique-month" class="form-control" required>
                                        <option value="">Sélectionner</option>
                                        <option value="janvier">Janvier</option>
                                        <option value="février">Février</option>
                                        <option value="mars">Mars</option>
                                        <option value="avril">Avril</option>
                                        <option value="mai">Mai</option>
                                        <option value="juin">Juin</option>
                                        <option value="juillet">Juillet</option>
                                        <option value="août">Août</option>
                                        <option value="septembre">Septembre</option>
                                        <option value="octobre">Octobre</option>
                                        <option value="novembre">Novembre</option>
                                        <option value="décembre">Décembre</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Montant du frais ($) *</label>
                                    <div class="currency-input-group">
                                        <span class="currency-symbol">$</span>
                                        <input type="number" id="communique-amount" class="form-control currency-input" step="0.01" min="0" required>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Classes concernées *</label>
                                <div id="communique-classes-container" class="months-container">
                                    <!-- Les classes seront chargées dynamiquement -->
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Message personnalisé (optionnel)</label>
                                <textarea id="communique-message" class="form-control" rows="3" placeholder="Ajouter un message personnalisé..."></textarea>
                            </div>
                            
                            <button type="button" class="btn btn-info" onclick="previewCommunique()">
                                <i class="fas fa-eye"></i> Prévisualiser
                            </button>
                            <button type="submit" class="btn btn-primary">
                                Publier aux parents
                            </button>
                        </form>
                    </div>
                    
                    <div class="card hidden" id="communique-preview-card">
                        <h4>Prévisualisation du communiqué</h4>
                        <div id="communique-preview-content" class="communique-preview">
                            <!-- Contenu généré dynamiquement -->
                        </div>
                        <div style="text-align: center; margin-top: 1rem;">
                            <button class="btn btn-success" onclick="printCommunique()">
                                <i class="fas fa-print"></i> Imprimer le Communiqué
                            </button>
                            <button class="btn btn-secondary" onclick="closePreview()">
                                Retour à l'édition
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Page: Paiement Salaires -->
                <div id="salaries-page" class="page">
                    <div class="tabs">
                        <div class="tab active" data-tab="teachers">Paiement Enseignants</div>
                        <div class="tab" data-tab="workers">Paiement Personnels</div>
                    </div>
                    
                    <!-- Onglet: Paiement Enseignants -->
                    <div id="teachers-tab" class="tab-content active">
                        <div class="card">
                            <h4>Paiement des salaires - Enseignants</h4>
                            <form id="teacher-salary-form">
                                <div class="form-row">
                                    <div class="form-group" style="flex: 1;">
                                        <label>Mois à payer *</label>
                                        <select id="teacher-salary-month" class="form-control" required>
                                            <option value="">Sélectionner</option>
                                            <option value="janvier">Janvier</option>
                                            <option value="février">Février</option>
                                            <option value="mars">Mars</option>
                                            <option value="avril">Avril</option>
                                            <option value="mai">Mai</option>
                                            <option value="juin">Juin</option>
                                            <option value="juillet">Juillet</option>
                                            <option value="août">Août</option>
                                            <option value="septembre">Septembre</option>
                                            <option value="octobre">Octobre</option>
                                            <option value="novembre">Novembre</option>
                                            <option value="décembre">Décembre</option>
                                        </select>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label>Matricule enseignant *</label>
                                        <input type="text" id="teacher-matricule" class="form-control" placeholder="Ex: ENS001" required>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <button type="button" class="btn btn-info" style="margin-top: 28px;" onclick="findTeacher()">
                                            Rechercher
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="teacher-info" class="hidden" style="background: #f8f9fa; padding: 1rem; border-radius: 5px; margin: 1rem 0;">
                                    <h5>Informations de l'enseignant</h5>
                                    <div class="form-row">
                                        <div class="form-group" style="flex: 2;">
                                            <label>Nom complet</label>
                                            <input type="text" id="teacher-found-name" class="form-control" readonly>
                                        </div>
                                        <div class="form-group" style="flex: 1;">
                                            <label>Type</label>
                                            <input type="text" id="teacher-found-type" class="form-control" readonly>
                                        </div>
                                        <div class="form-group" style="flex: 1;">
                                            <label>Classes</label>
                                            <input type="text" id="teacher-found-classes" class="form-control" readonly>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group" style="flex: 1;">
                                        <label>Montant du salaire ($) *</label>
                                        <div class="currency-input-group">
                                            <span class="currency-symbol">$</span>
                                            <input type="number" id="teacher-salary-amount" class="form-control currency-input" step="0.01" min="0" required>
                                        </div>
                                    </div>
                                    <div class="form-group" style="flex: 2;">
                                        <label>Description (optionnel)</label>
                                        <input type="text" id="teacher-salary-description" class="form-control" placeholder="Ex: Salaire régulier + prime">
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">
                                    Valider le paiement
                                </button>
                            </form>
                        </div>
                        
                        <div class="card">
                            <h4>Historique des paiements - Enseignants</h4>
                            <div class="search-box" style="margin-bottom: 1rem;">
                                <input type="text" id="teacher-salary-search" class="form-control" placeholder="Rechercher par matricule ou nom...">
                            </div>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Matricule</th>
                                            <th>Nom</th>
                                            <th>Mois</th>
                                            <th>Montant</th>
                                            <th>Statut</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="teacher-salaries-table-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Onglet: Paiement Personnels -->
                    <div id="workers-tab" class="tab-content">
                        <div class="card">
                            <h4>Paiement des salaires - Personnels Ouvriers</h4>
                            <form id="worker-salary-form">
                                <div class="form-row">
                                    <div class="form-group" style="flex: 1;">
                                        <label>Mois à payer *</label>
                                        <select id="worker-salary-month" class="form-control" required>
                                            <option value="">Sélectionner</option>
                                            <option value="janvier">Janvier</option>
                                            <option value="février">Février</option>
                                            <option value="mars">Mars</option>
                                            <option value="avril">Avril</option>
                                            <option value="mai">Mai</option>
                                            <option value="juin">Juin</option>
                                            <option value="juillet">Juillet</option>
                                            <option value="août">Août</option>
                                            <option value="septembre">Septembre</option>
                                            <option value="octobre">Octobre</option>
                                            <option value="novembre">Novembre</option>
                                            <option value="décembre">Décembre</option>
                                        </select>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label>Matricule personnel *</label>
                                        <input type="text" id="worker-salary-matricule" class="form-control" placeholder="Ex: PER001" required>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <button type="button" class="btn btn-info" style="margin-top: 28px;" onclick="findWorkerForSalary()">
                                            Rechercher
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="worker-salary-info" class="hidden" style="background: #f8f9fa; padding: 1rem; border-radius: 5px; margin: 1rem 0;">
                                    <h5>Informations du personnel</h5>
                                    <div class="form-row">
                                        <div class="form-group" style="flex: 2;">
                                            <label>Nom complet</label>
                                            <input type="text" id="worker-found-name" class="form-control" readonly>
                                        </div>
                                        <div class="form-group" style="flex: 1;">
                                            <label>Fonction</label>
                                            <input type="text" id="worker-found-function" class="form-control" readonly>
                                        </div>
                                        <div class="form-group" style="flex: 1;">
                                            <label>Téléphone</label>
                                            <input type="text" id="worker-found-phone" class="form-control" readonly>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group" style="flex: 1;">
                                        <label>Montant du salaire ($) *</label>
                                        <div class="currency-input-group">
                                            <span class="currency-symbol">$</span>
                                            <input type="number" id="worker-salary-amount" class="form-control currency-input" step="0.01" min="0" required>
                                        </div>
                                    </div>
                                    <div class="form-group" style="flex: 2;">
                                        <label>Description (optionnel)</label>
                                        <input type="text" id="worker-salary-description" class="form-control" placeholder="Ex: Salaire régulier">
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">
                                    Valider le paiement
                                </button>
                            </form>
                        </div>
                        
                        <div class="card">
                            <h4>Historique des paiements - Personnels</h4>
                            <div class="search-box" style="margin-bottom: 1rem;">
                                <input type="text" id="worker-salary-search" class="form-control" placeholder="Rechercher par matricule ou nom...">
                            </div>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Matricule</th>
                                            <th>Nom</th>
                                            <th>Mois</th>
                                            <th>Montant</th>
                                            <th>Statut</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="worker-salaries-table-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page: Archives -->
                <div id="archive-page" class="page">
                    <div class="card">
                        <h4>Archives - Communiqués publiés</h4>
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label>Filtrer par type de frais</label>
                                <select id="archive-fee-filter" class="form-control">
                                    <option value="">Tous les frais</option>
                                    <option value="Frais scolaires">Frais scolaires</option>
                                    <option value="Frais de l'état">Frais de l'état</option>
                                    <option value="visite">Visite</option>
                                    <option value="achat pull">Achat pull</option>
                                    <option value="Frais d'inscription">Frais d'inscription</option>
                                </select>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label>Filtrer par mois</label>
                                <select id="archive-month-filter" class="form-control">
                                    <option value="">Tous les mois</option>
                                    <option value="janvier">Janvier</option>
                                    <option value="février">Février</option>
                                    <option value="mars">Mars</option>
                                    <option value="avril">Avril</option>
                                    <option value="mai">Mai</option>
                                    <option value="juin">Juin</option>
                                    <option value="juillet">Juillet</option>
                                    <option value="août">Août</option>
                                    <option value="septembre">Septembre</option>
                                    <option value="octobre">Octobre</option>
                                    <option value="novembre">Novembre</option>
                                    <option value="décembre">Décembre</option>
                                </select>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label>Filtrer par année scolaire</label>
                                <select id="archive-year-filter" class="form-control">
                                    <option value="">Toutes les années</option>
                                    <option value="2023-2024">2023-2024</option>
                                    <option value="2024-2025">2024-2025</option>
                                    <option value="2025-2026">2025-2026</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Type de frais</th>
                                        <th>Mois</th>
                                        <th>Année scolaire</th>
                                        <th>Classes concernées</th>
                                        <th>Montant</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="archive-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h4>Archives - Paiements de salaires</h4>
                        <div class="tabs">
                            <div class="tab active" data-tab="archive-teachers">Enseignants</div>
                            <div class="tab" data-tab="archive-workers">Personnels</div>
                        </div>
                        
                        <div id="archive-teachers-tab" class="tab-content active">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Matricule</th>
                                            <th>Nom</th>
                                            <th>Mois</th>
                                            <th>Montant</th>
                                            <th>Type</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="archive-teachers-table-body"></tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div id="archive-workers-tab" class="tab-content">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Matricule</th>
                                            <th>Nom</th>
                                            <th>Mois</th>
                                            <th>Montant</th>
                                            <th>Fonction</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="archive-workers-table-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal pour l'impression de bordereau -->
                <div id="salary-receipt-modal" class="modal hidden">
                    <div class="modal-content" style="max-width: 700px;">
                        <div class="modal-header">
                            <h3>Bordereau de paiement de salaire</h3>
                            <button class="close-modal">&times;</button>
                        </div>
                        <div id="salary-receipt-content">
                            <!-- Contenu généré dynamiquement -->
                        </div>
                        <div style="text-align: center; margin-top: 1rem;">
                            <button id="print-salary-receipt-btn" class="btn btn-primary">Imprimer le bordereau</button>
                            <button id="back-salary-receipt-btn" class="btn btn-secondary">Retour</button>
                        </div>
                    </div>
                </div>

                <!-- Modal pour la carte du personnel -->
                <div id="worker-card-modal" class="modal hidden">
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="modal-header">
                            <h3>Carte d'identification du personnel</h3>
                            <button class="close-modal">&times;</button>
                        </div>
                        <div id="worker-card-content">
                            <!-- Contenu généré dynamiquement -->
                        </div>
                        <div style="text-align: center; margin-top: 1rem;">
                            <button id="print-worker-card-btn" class="btn btn-primary">Imprimer la carte</button>
                            <button id="back-worker-card-btn" class="btn btn-secondary">Fermer</button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

<!-- Modal pour la modification du personnel -->
<div id="edit-worker-modal" class="modal hidden">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h3>Modifier les informations du personnel</h3>
            <button class="close-modal">&times;</button>
        </div>
        <form id="edit-worker-form">
            <input type="hidden" id="edit-worker-matricule">
            
            <!-- Photo de profil -->
            <div class="photo-upload">
                <div class="photo-placeholder" id="edit-worker-photo-preview">
                    <i class="fas fa-user"></i>
                </div>
                <input type="file" id="edit-worker-photo" class="file-input" accept="image/*">
                <button type="button" class="upload-btn" onclick="document.getElementById('edit-worker-photo').click()">
                    <i class="fas fa-upload"></i> Changer la photo
                </button>
            </div>

            <div class="form-row">
                <div class="form-group" style="flex: 2;">
                    <label>Nom Complet *</label>
                    <input type="text" id="edit-worker-name" class="form-control" required>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Date de Naissance *</label>
                    <input type="date" id="edit-worker-birthdate" class="form-control" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group" style="flex: 1;">
                    <label>Lieu de Naissance *</label>
                    <input type="text" id="edit-worker-birthplace" class="form-control" required>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Sexe *</label>
                    <select id="edit-worker-gender" class="form-control" required>
                        <option value="">Sélectionner</option>
                        <option value="M">Masculin</option>
                        <option value="F">Féminin</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label>Adresse de Résidence *</label>
                <input type="text" id="edit-worker-address" class="form-control" required>
            </div>
            
            <div class="form-row">
                <div class="form-group" style="flex: 1;">
                    <label>Numéro de Téléphone *</label>
                    <input type="tel" id="edit-worker-phone" class="form-control" required>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Fonction *</label>
                    <select id="edit-worker-function" class="form-control" required>
                        <option value="">Sélectionner</option>
                        <option value="Agent de service">Agent de service</option>
                        <option value="Gardien">Gardien</option>
                        <option value="Cuisinier">Cuisinier</option>
                        <option value="Secrétaire">Secrétaire</option>
                        <option value="Autre">Autre</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group" style="flex: 1;">
                    <label>Statut *</label>
                    <select id="edit-worker-status" class="form-control" required>
                        <option value="active">Actif</option>
                        <option value="inactive">Inactif</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 2;">
                    <label>Date d'embauche</label>
                    <input type="date" id="edit-worker-hireddate" class="form-control">
                </div>
            </div>
            
            <div class="form-group">
                <label>Description / Commentaires</label>
                <textarea id="edit-worker-description" class="form-control" rows="3" placeholder="Informations supplémentaires..."></textarea>
            </div>
            
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button type="submit" class="btn btn-primary" id="edit-worker-submit-btn">
                    <i class="fas fa-save"></i> Enregistrer les modifications
                </button>
                <button type="button" class="btn btn-danger" id="delete-worker-btn">
                    <i class="fas fa-trash"></i> Supprimer le personnel
                </button>
                <button type="button" class="btn btn-secondary" id="cancel-edit-btn">
                    Annuler
                </button>
            </div>
        </form>
    </div>
</div>

    <script type="module">
        // 1. INITIALISATION DE FIREBASE
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, query, where, addDoc, serverTimestamp, doc, updateDoc, setDoc, getDoc, orderBy } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        // CONFIGURATION FIREBASE (identique à index.html)
        const firebaseConfig = {
            apiKey: "AIzaSyBn7VIddclO7KtrXb5sibCr9SjVLjOy-qI",
            authDomain: "theo1d.firebaseapp.com",
            projectId: "theo1d",
            storageBucket: "theo1d.firebasestorage.app",
            messagingSenderId: "269629842962",
            appId: "1:269629842962:web:a80a12b04448fe1e595acb",
            measurementId: "G-TNSG1XFMDZ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // 2. CONFIGURATION CLOUDINARY
        const CLOUDINARY_CONFIG = {
            cloudName: 'diwn8sxtn',
            uploadPreset: 'cs_lacolombe'
        };

        // 3. FONCTION UPLOAD CLOUDINARY
        async function uploadToCloudinary(file, folder = 'cs-lacolombe') {
            if (!file) return null;
            
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const formData = new FormData();
                        formData.append('file', file);
                        formData.append('upload_preset', CLOUDINARY_CONFIG.uploadPreset);
                        formData.append('folder', folder);
                        
                        const response = await fetch(
                            `https://api.cloudinary.com/v1_1/${CLOUDINARY_CONFIG.cloudName}/image/upload`,
                            { 
                                method: 'POST', 
                                body: formData 
                            }
                        );
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        resolve(data.secure_url);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error('Erreur de lecture du fichier'));
                reader.readAsDataURL(file);
            });
        }

        // 4. VARIABLES GLOBALES
        let currentUser = null;
        let workerPhotoFile = null;
        let editWorkerPhotoFile = null;
        let lastCreatedWorker = null;
        let lastCreatedSalary = null;

        // 5. GESTION DE L'AUTHENTIFICATION
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                initializeAppData();
            } else {
                // Redirection vers la page de connexion si non authentifié
                window.location.href = 'index.html';
            }
        });

        // 6. FONCTIONS UTILITAIRES
        function showAlert(message, type = 'info') {
            const alertBox = document.getElementById('global-alert');
            alertBox.textContent = message;
            alertBox.className = `alert alert-${type}`;
            alertBox.classList.remove('hidden');
            setTimeout(() => alertBox.classList.add('hidden'), 6000);
        }

        function formatDate(date) {
            if (!date) return 'Non définie';
            const d = date.toDate ? date.toDate() : new Date(date);
            return d.toLocaleDateString('fr-FR', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // 7. INITIALISATION DES DONNÉES
        function initializeAppData() {
            loadWorkersList();
            loadClassesForCommunique();
            loadTeacherSalaries();
            loadWorkerSalaries();
            loadCommuniqueArchives();
            loadSalaryArchives();
        }

        // 8. GESTION DES PHOTOS
        document.getElementById('worker-photo').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    showAlert("La photo ne doit pas dépasser 5MB", "error");
                    return;
                }
                if (!file.type.startsWith('image/')) {
                    showAlert("Veuillez sélectionner une image valide", "error");
                    return;
                }
                workerPhotoFile = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('worker-photo-preview').innerHTML = `<img src="${e.target.result}" class="photo-preview">`;
                }
                reader.readAsDataURL(file);
            }
        });

        // 9. CRÉATION DE PERSONNEL OUVRIER
        document.getElementById('worker-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fullName = document.getElementById('worker-name').value;
            const birthdate = document.getElementById('worker-birthdate').value;
            const birthplace = document.getElementById('worker-birthplace').value;
            const gender = document.getElementById('worker-gender').value;
            const address = document.getElementById('worker-address').value;
            const phone = document.getElementById('worker-phone').value;
            const workerFunction = document.getElementById('worker-function').value;
            const description = document.getElementById('worker-description').value;
            
            // Validation
            if (!fullName || !birthdate || !birthplace || !gender || !address || !phone || !workerFunction) {
                showAlert("Veuillez remplir tous les champs obligatoires (*)", "error");
                return;
            }
            
            const submitBtn = document.getElementById('worker-submit-btn');
            const originalText = submitBtn.textContent;
            
            try {
                submitBtn.textContent = 'Création en cours...';
                submitBtn.disabled = true;
                
                // Générer le matricule
                const workersSnap = await getDocs(collection(db, 'workers'));
                const workerCount = workersSnap.size + 1;
                const matricule = `PER${workerCount.toString().padStart(3, '0')}`;
                
                // Uploader la photo
                let photoURL = null;
                if (workerPhotoFile) {
                    try {
                        photoURL = await uploadToCloudinary(workerPhotoFile, `workers/${matricule}`);
                    } catch (uploadError) {
                        console.error("Erreur upload photo:", uploadError);
                    }
                }
                
                // Créer le personnel dans Firestore
                const workerData = {
                    matricule,
                    fullName,
                    birthdate,
                    birthplace,
                    gender,
                    address,
                    phone,
                    function: workerFunction,
                    description,
                    photoURL,
                    status: 'active',
                    hiredDate: new Date().toISOString().split('T')[0],
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                };
                
                const workerRef = doc(db, 'workers', matricule);
                await setDoc(workerRef, workerData);
                
                // Sauvegarder pour l'affichage
                lastCreatedWorker = { ...workerData, id: matricule };
                
                // Afficher le message de succès
                document.getElementById('worker-matricule').textContent = matricule;
                document.getElementById('worker-fullname').textContent = fullName;
                document.getElementById('worker-function-display').textContent = workerFunction;
                document.getElementById('worker-success').classList.remove('hidden');
                
                showAlert(`Personnel créé avec succès ! Matricule: ${matricule}`, 'success');
                
                // Réinitialiser le formulaire
                document.getElementById('worker-form').reset();
                workerPhotoFile = null;
                document.getElementById('worker-photo-preview').innerHTML = '<i class="fas fa-user"></i>';
                
                // Recharger la liste
                loadWorkersList();
                
            } catch (error) {
                console.error('Erreur création personnel:', error);
                showAlert('Erreur lors de la création: ' + error.message, 'error');
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        // 10. CHARGEMENT DE LA LISTE DES PERSONNELS
        async function loadWorkersList() {
            const tableBody = document.getElementById('workers-table-body');
            tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Chargement...</td></tr>';
            
            try {
                const workersSnap = await getDocs(collection(db, 'workers'));
                
                if (workersSnap.empty) {
                    tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Aucun personnel inscrit.</td></tr>';
                    return;
                }
                
                let html = '';
                workersSnap.forEach(doc => {
                    const data = doc.data();
                    
                    const photoHTML = data.photoURL 
                        ? `<img src="${data.photoURL}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">`
                        : '<div style="width: 40px; height: 40px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center;"><i class="fas fa-user"></i></div>';
                    
                    const statusBadge = data.status === 'active' 
                        ? '<span class="badge badge-success">Actif</span>' 
                        : '<span class="badge badge-danger">Inactif</span>';
                    
                    html += `
                        <tr>
                            <td>${data.matricule}</td>
                            <td>${photoHTML}</td>
                            <td>${data.fullName}</td>
                            <td>${data.function}</td>
                            <td>${data.phone}</td>
                            <td>${data.hiredDate}</td>
                            <td>${statusBadge}</td>
                            <td class="action-buttons">
                                <button class="btn btn-primary" onclick="viewWorkerDetails('${data.matricule}')">Détails</button>
                                <button class="btn btn-warning" onclick="editWorker('${data.matricule}')">Modifier</button>
                            </td>
                        </tr>
                    `;
                });
                
                tableBody.innerHTML = html;
                
                // Recherche
                document.getElementById('worker-search').addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const rows = tableBody.querySelectorAll('tr');
                    
                    rows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        row.style.display = text.includes(searchTerm) ? '' : 'none';
                    });
                });
                
            } catch (error) {
                console.error("Erreur chargement personnel:", error);
                tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Erreur de chargement</td></tr>';
            }
        }

        // 11. CHARGEMENT DES CLASSES POUR LE COMMUNIQUÉ
        async function loadClassesForCommunique() {
            const container = document.getElementById('communique-classes-container');
            container.innerHTML = 'Chargement des classes...';
            
            try {
                // Classes secondaires
                const classesSnap = await getDocs(collection(db, 'classes'));
                // Classes primaires
                const primaryClassesSnap = await getDocs(collection(db, 'primary_classes'));
                // Classes maternelles
                const kindergartenClassesSnap = await getDocs(collection(db, 'kindergarten_classes'));
                
                let html = '';
                
                classesSnap.forEach(doc => {
                    const data = doc.data();
                    html += `
                        <div class="month-checkbox">
                            <input type="checkbox" id="class-${doc.id}" value="${data.name}" class="class-checkbox">
                            <label for="class-${doc.id}">${data.name} (Sec)</label>
                        </div>
                    `;
                });
                
                primaryClassesSnap.forEach(doc => {
                    const data = doc.data();
                    html += `
                        <div class="month-checkbox">
                            <input type="checkbox" id="primary-class-${doc.id}" value="${data.name}" class="class-checkbox">
                            <label for="primary-class-${doc.id}">${data.name} (Prim)</label>
                        </div>
                    `;
                });
                
                kindergartenClassesSnap.forEach(doc => {
                    const data = doc.data();
                    html += `
                        <div class="month-checkbox">
                            <input type="checkbox" id="kindergarten-class-${doc.id}" value="${data.name}" class="class-checkbox">
                            <label for="kindergarten-class-${doc.id}">${data.name} (Mat)</label>
                        </div>
                    `;
                });
                
                container.innerHTML = html || '<p>Aucune classe disponible</p>';
                
            } catch (error) {
                console.error("Erreur chargement classes:", error);
                container.innerHTML = 'Erreur de chargement';
            }
        }

        // 12. PRÉVISUALISATION DU COMMUNIQUÉ
        window.previewCommunique = function() {
            const feeType = document.getElementById('communique-fee-type').value;
            const otherFee = document.getElementById('communique-other-fee').value;
            const deadline = document.getElementById('communique-deadline').value;
            const schoolYear = document.getElementById('communique-school-year').value;
            const month = document.getElementById('communique-month').value;
            const amount = document.getElementById('communique-amount').value;
            const message = document.getElementById('communique-message').value;
            
            // Récupérer les classes sélectionnées
            const selectedClasses = [];
            document.querySelectorAll('#communique-classes-container .class-checkbox:checked').forEach(checkbox => {
                selectedClasses.push(checkbox.value);
            });
            
            if (!feeType || !deadline || !schoolYear || !month || !amount || selectedClasses.length === 0) {
                showAlert("Veuillez remplir tous les champs obligatoires et sélectionner au moins une classe", "error");
                return;
            }
            
            const finalFeeType = feeType === 'Autres' ? otherFee : feeType;
            
            // Formatage de la date
            const deadlineDate = new Date(deadline);
            const formattedDeadline = deadlineDate.toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: 'long',
                year: 'numeric'
            });
            
            const today = new Date();
            const formattedToday = today.toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: 'long',
                year: 'numeric'
            });
            
            // Construction du communiqué
            const communiqueHTML = `
                <div class="communique-header">
                    <img src="R.png" alt="Logo CS la Colombe" class="communique-logo">
                    <div class="communique-title">COMMUNIQUE DE PAIEMENT</div>
                    <div>Complexe Scolaire la Colombe</div>
                    <div>Lubumbashi, République Démocratique du Congo</div>
                    <div>Tél: +243 XXX XXX XXX</div>
                </div>
                
                <div class="communique-date">
                    Lubumbashi, le ${formattedToday}
                </div>
                
                <div class="communique-content">
                    <p><strong>Objet :</strong> Rappel concernant le paiement des frais de <strong>${finalFeeType}</strong></p>
                    
                    <p>À l'attention des parents de l'élève <strong>[Nom de l'élève]</strong><br>
                    Matricule: <strong>[Matricule de l'élève]</strong><br>
                    Inscrit dans la classe de <strong>[Classe de l'élève]</strong></p>
                    
                    <p>Cher(s) parent(s), tuteur(s) légal(aux),</p>
                    
                    <p>L'établissement <strong>Complexe Scolaire la Colombe</strong> vous adresse ce communiqué concernant le règlement des frais de <strong>${finalFeeType}</strong> pour l'année scolaire <strong>${schoolYear}</strong>.</p>
                    
                    <p>Nous vous rappelons que la date limite pour le paiement du solde des frais de <strong>${finalFeeType}</strong> pour le mois de <strong>${month}</strong> est fixée au <strong>${formattedDeadline}</strong>.</p>
                    
                    <p><strong>Détail des montants dus :</strong></p>
                    
                    <ul>
                        <li>Frais de ${finalFeeType.toLowerCase()} : <strong>$${parseFloat(amount).toFixed(2)}</strong></li>
                    </ul>
                    
                    ${message ? `<p><strong>Message additionnel :</strong> ${message}</p>` : ''}
                    
                    <p>Nous vous remercions de votre compréhension et de votre collaboration.</p>
                    
                    <p><strong>Classes concernées par ce communiqué :</strong> ${selectedClasses.join(', ')}</p>
                    
                    <p>Bonne collaboration,<br>
                    La Direction</p>
                </div>
                
                <div class="communique-signature">
                    <p>Le Directeur</p>
                    <div class="signature-line"></div>
                </div>
            `;
            
            document.getElementById('communique-preview-content').innerHTML = communiqueHTML;
            document.getElementById('communique-preview-card').classList.remove('hidden');
            document.getElementById('communique-form').style.display = 'none';
        };

        // 13. IMPRESSION DU COMMUNIQUÉ
        window.printCommunique = function() {
            const communiqueContent = document.getElementById('communique-preview-content').innerHTML;
            const printWindow = window.open('', '_blank');
            
            const printHTML = `
                <!DOCTYPE html>
                <html>
                    <head>
                        <title>Communiqué de paiement - CS la Colombe</title>
                        <style>
                            body { 
                                font-family: 'Times New Roman', serif; 
                                margin: 40px; 
                                font-size: 14px;
                                line-height: 1.6;
                            }
                            .communique-header { 
                                text-align: center; 
                                margin-bottom: 30px; 
                            }
                            .communique-logo { 
                                max-width: 120px; 
                                margin-bottom: 10px; 
                            }
                            .communique-title { 
                                font-size: 18px; 
                                font-weight: bold; 
                                margin: 10px 0; 
                                text-decoration: underline;
                            }
                            .communique-date { 
                                text-align: right; 
                                margin-bottom: 30px; 
                                font-style: italic; 
                            }
                            .communique-content { 
                                margin-bottom: 50px; 
                            }
                            .communique-signature { 
                                margin-top: 100px; 
                                text-align: right; 
                            }
                            .signature-line { 
                                border-top: 1px solid #000; 
                                margin-top: 50px; 
                                width: 250px; 
                                margin-left: auto; 
                            }
                            strong { font-weight: bold; }
                            ul { padding-left: 20px; }
                            @media print {
                                body { margin: 20px; }
                            }
                        </style>
                    </head>
                    <body>
                        ${communiqueContent}
                        <script>
                            window.onload = function() {
                                window.print();
                                setTimeout(function() {
                                    window.close();
                                }, 1000);
                            }
                        <\/script>
                    </body>
                </html>
            `;
            
            printWindow.document.write(printHTML);
            printWindow.document.close();
        };

        // 14. FERMETURE DE LA PRÉVISUALISATION
        window.closePreview = function() {
            document.getElementById('communique-preview-card').classList.add('hidden');
            document.getElementById('communique-form').style.display = 'block';
        };

        // 15. PUBLICATION DU COMMUNIQUÉ
        document.getElementById('communique-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const feeType = document.getElementById('communique-fee-type').value;
            const otherFee = document.getElementById('communique-other-fee').value;
            const deadline = document.getElementById('communique-deadline').value;
            const schoolYear = document.getElementById('communique-school-year').value;
            const month = document.getElementById('communique-month').value;
            const amount = parseFloat(document.getElementById('communique-amount').value);
            const message = document.getElementById('communique-message').value;
            
            // Récupérer les classes sélectionnées
            const selectedClasses = [];
            document.querySelectorAll('#communique-classes-container .class-checkbox:checked').forEach(checkbox => {
                selectedClasses.push(checkbox.value);
            });
            
            if (!feeType || !deadline || !schoolYear || !month || !amount || selectedClasses.length === 0) {
                showAlert("Veuillez remplir tous les champs obligatoires", "error");
                return;
            }
            
            const finalFeeType = feeType === 'Autres' ? otherFee : feeType;
            
            try {
                // Enregistrer le communiqué
                const communiqueData = {
                    feeType: finalFeeType,
                    deadline,
                    schoolYear,
                    month,
                    amount,
                    classes: selectedClasses,
                    message,
                    publishedBy: currentUser.uid,
                    publishedAt: serverTimestamp(),
                    status: 'published'
                };
                
                await addDoc(collection(db, 'communiques'), communiqueData);
                
                // Trouver les élèves non payés pour ces classes
                const unpaidStudents = await findUnpaidStudents(finalFeeType, month, selectedClasses);
                
                // Envoyer le communiqué aux parents concernés
                await sendCommuniqueToParents(communiqueData, unpaidStudents);
                
                showAlert(`Communiqué publié avec succès ! ${unpaidStudents.length} parent(s) concerné(s).`, 'success');
                
                // Réinitialiser le formulaire
                document.getElementById('communique-form').reset();
                document.querySelectorAll('#communique-classes-container .class-checkbox').forEach(checkbox => {
                    checkbox.checked = false;
                });
                
                // Recharger les archives
                loadCommuniqueArchives();
                
            } catch (error) {
                console.error('Erreur publication communiqué:', error);
                showAlert('Erreur lors de la publication: ' + error.message, 'error');
            }
        });

        // 16. TROUVER LES ÉLÈVES NON PAYÉS
        async function findUnpaidStudents(feeType, month, classes) {
            const unpaidStudents = [];
            
            try {
                // Rechercher dans les élèves secondaires
                const secondaryStudents = await getDocs(query(collection(db, 'students'), where('status', '==', 'active')));
                
                for (const studentDoc of secondaryStudents.docs) {
                    const studentData = studentDoc.data();
                    
                    // Vérifier si l'élève est dans une classe concernée
                    if (classes.includes(studentData.class)) {
                        // Vérifier si l'élève a déjà payé ce frais pour ce mois
                        const paymentQuery = query(
                            collection(db, 'payments'),
                            where('studentId', '==', studentData.matricule),
                            where('paymentType', '==', feeType),
                            where('month', '==', month)
                        );
                        
                        const paymentSnap = await getDocs(paymentQuery);
                        
                        if (paymentSnap.empty) {
                            unpaidStudents.push({
                                id: studentDoc.id,
                                matricule: studentData.matricule,
                                fullName: studentData.fullName,
                                class: studentData.class,
                                parentPhone: studentData.parentPhone,
                                parentName: studentData.parentName,
                                studentType: 'secondary'
                            });
                        }
                    }
                }
                
                // Rechercher dans les élèves primaires
                const primaryStudents = await getDocs(query(collection(db, 'primary_students'), where('status', '==', 'active')));
                
                for (const studentDoc of primaryStudents.docs) {
                    const studentData = studentDoc.data();
                    
                    if (classes.includes(studentData.class)) {
                        const paymentQuery = query(
                            collection(db, 'payments'),
                            where('studentId', '==', studentData.matricule),
                            where('paymentType', '==', feeType),
                            where('month', '==', month)
                        );
                        
                        const paymentSnap = await getDocs(paymentQuery);
                        
                        if (paymentSnap.empty) {
                            unpaidStudents.push({
                                id: studentDoc.id,
                                matricule: studentData.matricule,
                                fullName: studentData.fullName,
                                class: studentData.class,
                                parentPhone: studentData.parentPhone,
                                parentName: studentData.parentName,
                                studentType: 'primary'
                            });
                        }
                    }
                }
                
            } catch (error) {
                console.error('Erreur recherche élèves non payés:', error);
            }
            
            return unpaidStudents;
        }
// 15. PUBLICATION DU COMMUNIQUÉ - MODIFIÉE
document.getElementById('communique-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const feeType = document.getElementById('communique-fee-type').value;
    const otherFee = document.getElementById('communique-other-fee').value;
    const deadline = document.getElementById('communique-deadline').value;
    const schoolYear = document.getElementById('communique-school-year').value;
    const month = document.getElementById('communique-month').value;
    const amount = parseFloat(document.getElementById('communique-amount').value);
    const message = document.getElementById('communique-message').value;
    
    // Récupérer les classes sélectionnées
    const selectedClasses = [];
    document.querySelectorAll('#communique-classes-container .class-checkbox:checked').forEach(checkbox => {
        selectedClasses.push(checkbox.value);
    });
    
    if (!feeType || !deadline || !schoolYear || !month || !amount || selectedClasses.length === 0) {
        showAlert("Veuillez remplir tous les champs obligatoires", "error");
        return;
    }
    
    const finalFeeType = feeType === 'Autres' ? otherFee : feeType;
    
    try {
        // 1. Enregistrer le communiqué principal
        const communiqueData = {
            feeType: finalFeeType,
            deadline,
            schoolYear,
            month,
            amount,
            classes: selectedClasses,
            message,
            publishedBy: currentUser.uid,
            publishedAt: serverTimestamp(),
            status: 'published'
        };
        
        // Ajouter avec un ID personnalisé pour référence facile
        const communiqueId = `comm_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        const communiqueRef = doc(db, 'parent_communiques', communiqueId);
        
        await setDoc(communiqueRef, communiqueData);
        
        // 2. Trouver tous les parents concernés par les classes sélectionnées
        const concernedParents = await findParentsForClasses(selectedClasses);
        
        // 3. Pour chaque parent, créer une relation parent-communiqué
        for (const parent of concernedParents) {
            const relationId = `${parent.matricule}_${communiqueId}`;
            const relationRef = doc(db, 'parent_communique_relations', relationId);
            
            await setDoc(relationRef, {
                parentId: parent.matricule,
                parentName: parent.fullName,
                communiqueId: communiqueId,
                studentIds: parent.childrenMatricules || [],
                studentNames: parent.childrenNames || [],
                studentClasses: parent.childrenClasses || [],
                status: 'pending', // 'pending', 'paid', 'overdue'
                createdAt: serverTimestamp(),
                expirationDate: new Date(new Date().getTime() + 30 * 24 * 60 * 60 * 1000), // 30 jours
                feeType: finalFeeType,
                amount: amount,
                month: month,
                deadline: deadline
            });
            
            // 4. Pour chaque enfant, créer une relation élève-communiqué
            for (let i = 0; i < parent.childrenMatricules.length; i++) {
                const studentRelationId = `${parent.childrenMatricules[i]}_${communiqueId}`;
                const studentRelationRef = doc(db, 'student_communique_relations', studentRelationId);
                
                await setDoc(studentRelationRef, {
                    studentId: parent.childrenMatricules[i],
                    studentName: parent.childrenNames[i],
                    studentClass: parent.childrenClasses[i],
                    parentId: parent.matricule,
                    parentName: parent.fullName,
                    communiqueId: communiqueId,
                    feeType: finalFeeType,
                    amount: amount,
                    month: month,
                    deadline: deadline,
                    status: 'pending',
                    createdAt: serverTimestamp()
                });
            }
        }
        
        showAlert(`Communiqué publié avec succès ! ${concernedParents.length} parent(s) concerné(s).`, 'success');
        
        // 5. Réinitialiser le formulaire
        document.getElementById('communique-form').reset();
        document.querySelectorAll('#communique-classes-container .class-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });
        
        // 6. Recharger les archives
        loadCommuniqueArchives();
        
    } catch (error) {
        console.error('Erreur publication communiqué:', error);
        showAlert('Erreur lors de la publication: ' + error.message, 'error');
    }
});

// Fonction pour trouver les parents concernés par les classes
async function findParentsForClasses(classes) {
    const concernedParents = [];
    const parentMap = new Map(); // Pour éviter les doublons
    
    try {
        // Rechercher dans les élèves secondaires
        for (const className of classes) {
            const studentsQuery = query(
                collection(db, 'students'),
                where('class', '==', className),
                where('status', '==', 'active')
            );
            
            const studentsSnap = await getDocs(studentsQuery);
            
            for (const studentDoc of studentsSnap.docs) {
                const studentData = studentDoc.data();
                
                if (studentData.parentId) {
                    if (!parentMap.has(studentData.parentId)) {
                        // Récupérer les informations du parent
                        const parentDoc = await getDoc(doc(db, 'parents', studentData.parentId));
                        
                        if (parentDoc.exists()) {
                            const parentData = parentDoc.data();
                            parentMap.set(studentData.parentId, {
                                matricule: studentData.parentId,
                                fullName: parentData.fullName || 'Parent inconnu',
                                childrenMatricules: [studentData.matricule],
                                childrenNames: [studentData.fullName],
                                childrenClasses: [studentData.class]
                            });
                        }
                    } else {
                        // Ajouter l'enfant supplémentaire au parent existant
                        const parent = parentMap.get(studentData.parentId);
                        parent.childrenMatricules.push(studentData.matricule);
                        parent.childrenNames.push(studentData.fullName);
                        parent.childrenClasses.push(studentData.class);
                    }
                }
            }
        }
        
        // Rechercher dans les élèves primaires
        for (const className of classes) {
            const studentsQuery = query(
                collection(db, 'primary_students'),
                where('class', '==', className),
                where('status', '==', 'active')
            );
            
            const studentsSnap = await getDocs(studentsQuery);
            
            for (const studentDoc of studentsSnap.docs) {
                const studentData = studentDoc.data();
                
                if (studentData.parentId) {
                    if (!parentMap.has(studentData.parentId)) {
                        const parentDoc = await getDoc(doc(db, 'parents', studentData.parentId));
                        
                        if (parentDoc.exists()) {
                            const parentData = parentDoc.data();
                            parentMap.set(studentData.parentId, {
                                matricule: studentData.parentId,
                                fullName: parentData.fullName || 'Parent inconnu',
                                childrenMatricules: [studentData.matricule],
                                childrenNames: [studentData.fullName],
                                childrenClasses: [studentData.class]
                            });
                        }
                    } else {
                        const parent = parentMap.get(studentData.parentId);
                        parent.childrenMatricules.push(studentData.matricule);
                        parent.childrenNames.push(studentData.fullName);
                        parent.childrenClasses.push(studentData.class);
                    }
                }
            }
        }
        
        // Rechercher dans les élèves maternelles
        for (const className of classes) {
            const studentsQuery = query(
                collection(db, 'kindergarten_students'),
                where('class', '==', className),
                where('status', '==', 'active')
            );
            
            const studentsSnap = await getDocs(studentsQuery);
            
            for (const studentDoc of studentsSnap.docs) {
                const studentData = studentDoc.data();
                
                if (studentData.parentId) {
                    if (!parentMap.has(studentData.parentId)) {
                        const parentDoc = await getDoc(doc(db, 'parents', studentData.parentId));
                        
                        if (parentDoc.exists()) {
                            const parentData = parentDoc.data();
                            parentMap.set(studentData.parentId, {
                                matricule: studentData.parentId,
                                fullName: parentData.fullName || 'Parent inconnu',
                                childrenMatricules: [studentData.matricule],
                                childrenNames: [studentData.fullName],
                                childrenClasses: [studentData.class]
                            });
                        }
                    } else {
                        const parent = parentMap.get(studentData.parentId);
                        parent.childrenMatricules.push(studentData.matricule);
                        parent.childrenNames.push(studentData.fullName);
                        parent.childrenClasses.push(studentData.class);
                    }
                }
            }
        }
        
        // Convertir la Map en Array
        parentMap.forEach(parent => {
            concernedParents.push(parent);
        });
        
    } catch (error) {
        console.error('Erreur recherche parents:', error);
    }
    
    return concernedParents;
}

        // 17. ENVOYER LE COMMUNIQUÉ AUX PARENTS
        async function sendCommuniqueToParents(communiqueData, unpaidStudents) {
            try {
                // Enregistrer l'envoi pour chaque parent
                for (const student of unpaidStudents) {
                    const notificationData = {
                        communiqueData: {
                            feeType: communiqueData.feeType,
                            deadline: communiqueData.deadline,
                            month: communiqueData.month,
                            amount: communiqueData.amount,
                            message: communiqueData.message
                        },
                        studentInfo: student,
                        sentAt: serverTimestamp(),
                        status: 'sent'
                    };
                    
                    await addDoc(collection(db, 'communique_notifications'), notificationData);
                }
                
                // Ici, vous pourriez ajouter l'envoi de SMS ou d'emails
                // Pour l'instant, on se contente de l'enregistrement
                
            } catch (error) {
                console.error('Erreur envoi communiqué:', error);
            }
        }

        // 18. RECHERCHE D'ENSEIGNANT POUR PAIEMENT
        window.findTeacher = async function() {
            const matricule = document.getElementById('teacher-matricule').value.trim();
            
            if (!matricule) {
                showAlert("Veuillez entrer un matricule", "error");
                return;
            }
            
            try {
                // Chercher dans les enseignants secondaires
                let teacherDoc = await getDoc(doc(db, 'teachers', matricule));
                let teacherType = 'secondary';
                
                // Si pas trouvé, chercher dans les primaires
                if (!teacherDoc.exists()) {
                    teacherDoc = await getDoc(doc(db, 'primary_teachers', matricule));
                    teacherType = 'primary';
                }
                
                // Si pas trouvé, chercher dans les maternelles
                if (!teacherDoc.exists()) {
                    teacherDoc = await getDoc(doc(db, 'kindergarten_teachers', matricule));
                    teacherType = 'kindergarten';
                }
                
                if (!teacherDoc.exists()) {
                    showAlert("Aucun enseignant trouvé avec ce matricule", "error");
                    document.getElementById('teacher-info').classList.add('hidden');
                    return;
                }
                
                const teacherData = teacherDoc.data();
                
                // Afficher les informations
                document.getElementById('teacher-found-name').value = teacherData.fullName;
                document.getElementById('teacher-found-type').value = teacherType === 'secondary' ? 'Secondaire' : 
                                                                    teacherType === 'primary' ? 'Primaire' : 'Maternelle';
                document.getElementById('teacher-found-classes').value = teacherData.classes ? teacherData.classes.join(', ') : 'Aucune';
                document.getElementById('teacher-info').classList.remove('hidden');
                
                // Vérifier si déjà payé pour ce mois
                const month = document.getElementById('teacher-salary-month').value;
                if (month) {
                    await checkTeacherSalaryPayment(matricule, month);
                }
                
            } catch (error) {
                console.error('Erreur recherche enseignant:', error);
                showAlert('Erreur lors de la recherche: ' + error.message, 'error');
            }
        };

        // 19. VÉRIFIER SI L'ENSEIGNANT EST DÉJÀ PAYÉ
        async function checkTeacherSalaryPayment(teacherMatricule, month) {
            try {
                const salaryQuery = query(
                    collection(db, 'teacher_salaries'),
                    where('teacherMatricule', '==', teacherMatricule),
                    where('month', '==', month)
                );
                
                const salarySnap = await getDocs(salaryQuery);
                
                if (!salarySnap.empty) {
                    showAlert(`Attention: Cet enseignant a déjà été payé pour le mois de ${month}`, 'warning');
                }
            } catch (error) {
                console.error('Erreur vérification paiement:', error);
            }
        }

        // 20. PAIEMENT DES SALAIRES ENSEIGNANTS
        document.getElementById('teacher-salary-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const month = document.getElementById('teacher-salary-month').value;
            const teacherMatricule = document.getElementById('teacher-matricule').value;
            const amount = parseFloat(document.getElementById('teacher-salary-amount').value);
            const description = document.getElementById('teacher-salary-description').value;
            
            if (!month || !teacherMatricule || !amount) {
                showAlert("Veuillez remplir tous les champs obligatoires", "error");
                return;
            }
            
            try {
                // Vérifier que l'enseignant existe
                let teacherDoc = await getDoc(doc(db, 'teachers', teacherMatricule));
                let teacherType = 'secondary';
                
                if (!teacherDoc.exists()) {
                    teacherDoc = await getDoc(doc(db, 'primary_teachers', teacherMatricule));
                    teacherType = 'primary';
                }
                
                if (!teacherDoc.exists()) {
                    teacherDoc = await getDoc(doc(db, 'kindergarten_teachers', teacherMatricule));
                    teacherType = 'kindergarten';
                }
                
                if (!teacherDoc.exists()) {
                    showAlert("Enseignant non trouvé", "error");
                    return;
                }
                
                const teacherData = teacherDoc.data();
                
                // Vérifier si déjà payé pour ce mois
                const salaryQuery = query(
                    collection(db, 'teacher_salaries'),
                    where('teacherMatricule', '==', teacherMatricule),
                    where('month', '==', month)
                );
                
                const salarySnap = await getDocs(salaryQuery);
                
                if (!salarySnap.empty) {
                    showAlert(`Cet enseignant a déjà été payé pour le mois de ${month}`, 'error');
                    return;
                }
                
                // Créer le paiement
                const salaryData = {
                    teacherMatricule,
                    teacherName: teacherData.fullName,
                    teacherType,
                    month,
                    amount,
                    description,
                    paidBy: currentUser.uid,
                    paidAt: serverTimestamp(),
                    status: 'paid'
                };
                
                const salaryRef = await addDoc(collection(db, 'teacher_salaries'), salaryData);
                
                // Sauvegarder pour l'impression
                lastCreatedSalary = { ...salaryData, id: salaryRef.id, type: 'teacher' };
                
                // Générer le bordereau
                await generateSalaryReceipt(
                    teacherData.fullName,
                    teacherMatricule,
                    month,
                    amount,
                    description,
                    'ENSEIGNANT'
                );
                
                showAlert(`Salaire payé avec succès pour ${teacherData.fullName}`, 'success');
                
                // Réinitialiser le formulaire
                document.getElementById('teacher-salary-form').reset();
                document.getElementById('teacher-info').classList.add('hidden');
                
                // Recharger les listes
                loadTeacherSalaries();
                loadSalaryArchives();
                
            } catch (error) {
                console.error('Erreur paiement salaire:', error);
                showAlert('Erreur lors du paiement: ' + error.message, 'error');
            }
        });

        // 21. CHARGEMENT DES SALAIRES ENSEIGNANTS
        async function loadTeacherSalaries() {
            const tableBody = document.getElementById('teacher-salaries-table-body');
            tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Chargement...</td></tr>';
            
            try {
                const salariesSnap = await getDocs(query(collection(db, 'teacher_salaries'), orderBy('paidAt', 'desc')));
                
                if (salariesSnap.empty) {
                    tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Aucun paiement enregistré.</td></tr>';
                    return;
                }
                
                let html = '';
                salariesSnap.forEach(doc => {
                    const data = doc.data();
                    
                    const statusBadge = data.status === 'paid' 
                        ? '<span class="badge badge-success">Payé</span>' 
                        : '<span class="badge badge-warning">En attente</span>';
                    
                    html += `
                        <tr>
                            <td>${formatDate(data.paidAt)}</td>
                            <td>${data.teacherMatricule}</td>
                            <td>${data.teacherName}</td>
                            <td>${data.month}</td>
                            <td class="currency-display">$${data.amount.toFixed(2)}</td>
                            <td>${statusBadge}</td>
                            <td class="action-buttons">
                                <button class="btn btn-primary" onclick="viewSalaryDetails('${doc.id}', 'teacher')">Détails</button>
                                <button class="btn btn-success" onclick="printSalaryReceipt('${doc.id}', 'teacher')">Reçu</button>
                            </td>
                        </tr>
                    `;
                });
                
                tableBody.innerHTML = html;
                
                // Recherche
                document.getElementById('teacher-salary-search').addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const rows = tableBody.querySelectorAll('tr');
                    
                    rows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        row.style.display = text.includes(searchTerm) ? '' : 'none';
                    });
                });
                
            } catch (error) {
                console.error("Erreur chargement salaires enseignants:", error);
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Erreur de chargement</td></tr>';
            }
        }

        // 22. RECHERCHE DE PERSONNEL POUR PAIEMENT
        window.findWorkerForSalary = async function() {
            const matricule = document.getElementById('worker-salary-matricule').value.trim();
            
            if (!matricule) {
                showAlert("Veuillez entrer un matricule", "error");
                return;
            }
            
            try {
                const workerDoc = await getDoc(doc(db, 'workers', matricule));
                
                if (!workerDoc.exists()) {
                    showAlert("Aucun personnel trouvé avec ce matricule", "error");
                    document.getElementById('worker-salary-info').classList.add('hidden');
                    return;
                }
                
                const workerData = workerDoc.data();
                
                // Afficher les informations
                document.getElementById('worker-found-name').value = workerData.fullName;
                document.getElementById('worker-found-function').value = workerData.function;
                document.getElementById('worker-found-phone').value = workerData.phone;
                document.getElementById('worker-salary-info').classList.remove('hidden');
                
                // Vérifier si déjà payé pour ce mois
                const month = document.getElementById('worker-salary-month').value;
                if (month) {
                    await checkWorkerSalaryPayment(matricule, month);
                }
                
            } catch (error) {
                console.error('Erreur recherche personnel:', error);
                showAlert('Erreur lors de la recherche: ' + error.message, 'error');
            }
        };

        // 23. VÉRIFIER SI LE PERSONNEL EST DÉJÀ PAYÉ
        async function checkWorkerSalaryPayment(workerMatricule, month) {
            try {
                const salaryQuery = query(
                    collection(db, 'worker_salaries'),
                    where('workerMatricule', '==', workerMatricule),
                    where('month', '==', month)
                );
                
                const salarySnap = await getDocs(salaryQuery);
                
                if (!salarySnap.empty) {
                    showAlert(`Attention: Ce personnel a déjà été payé pour le mois de ${month}`, 'warning');
                }
            } catch (error) {
                console.error('Erreur vérification paiement:', error);
            }
        }

        // 24. PAIEMENT DES SALAIRES PERSONNELS
        document.getElementById('worker-salary-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const month = document.getElementById('worker-salary-month').value;
            const workerMatricule = document.getElementById('worker-salary-matricule').value;
            const amount = parseFloat(document.getElementById('worker-salary-amount').value);
            const description = document.getElementById('worker-salary-description').value;
            
            if (!month || !workerMatricule || !amount) {
                showAlert("Veuillez remplir tous les champs obligatoires", "error");
                return;
            }
            
            try {
                // Vérifier que le personnel existe
                const workerDoc = await getDoc(doc(db, 'workers', workerMatricule));
                
                if (!workerDoc.exists()) {
                    showAlert("Personnel non trouvé", "error");
                    return;
                }
                
                const workerData = workerDoc.data();
                
                // Vérifier si déjà payé pour ce mois
                const salaryQuery = query(
                    collection(db, 'worker_salaries'),
                    where('workerMatricule', '==', workerMatricule),
                    where('month', '==', month)
                );
                
                const salarySnap = await getDocs(salaryQuery);
                
                if (!salarySnap.empty) {
                    showAlert(`Ce personnel a déjà été payé pour le mois de ${month}`, 'error');
                    return;
                }
                
                // Créer le paiement
                const salaryData = {
                    workerMatricule,
                    workerName: workerData.fullName,
                    workerFunction: workerData.function,
                    month,
                    amount,
                    description,
                    paidBy: currentUser.uid,
                    paidAt: serverTimestamp(),
                    status: 'paid'
                };
                
                const salaryRef = await addDoc(collection(db, 'worker_salaries'), salaryData);
                
                // Sauvegarder pour l'impression
                lastCreatedSalary = { ...salaryData, id: salaryRef.id, type: 'worker' };
                
                // Générer le bordereau
                await generateSalaryReceipt(
                    workerData.fullName,
                    workerMatricule,
                    month,
                    amount,
                    description,
                    'PERSONNEL'
                );
                
                showAlert(`Salaire payé avec succès pour ${workerData.fullName}`, 'success');
                
                // Réinitialiser le formulaire
                document.getElementById('worker-salary-form').reset();
                document.getElementById('worker-salary-info').classList.add('hidden');
                
                // Recharger les listes
                loadWorkerSalaries();
                loadSalaryArchives();
                
            } catch (error) {
                console.error('Erreur paiement salaire:', error);
                showAlert('Erreur lors du paiement: ' + error.message, 'error');
            }
        });

        // 25. CHARGEMENT DES SALAIRES PERSONNELS
        async function loadWorkerSalaries() {
            const tableBody = document.getElementById('worker-salaries-table-body');
            tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Chargement...</td></tr>';
            
            try {
                const salariesSnap = await getDocs(query(collection(db, 'worker_salaries'), orderBy('paidAt', 'desc')));
                
                if (salariesSnap.empty) {
                    tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Aucun paiement enregistré.</td></tr>';
                    return;
                }
                
                let html = '';
                salariesSnap.forEach(doc => {
                    const data = doc.data();
                    
                    const statusBadge = data.status === 'paid' 
                        ? '<span class="badge badge-success">Payé</span>' 
                        : '<span class="badge badge-warning">En attente</span>';
                    
                    html += `
                        <tr>
                            <td>${formatDate(data.paidAt)}</td>
                            <td>${data.workerMatricule}</td>
                            <td>${data.workerName}</td>
                            <td>${data.month}</td>
                            <td class="currency-display">$${data.amount.toFixed(2)}</td>
                            <td>${statusBadge}</td>
                            <td class="action-buttons">
                                <button class="btn btn-primary" onclick="viewSalaryDetails('${doc.id}', 'worker')">Détails</button>
                                <button class="btn btn-success" onclick="printSalaryReceipt('${doc.id}', 'worker')">Reçu</button>
                            </td>
                        </tr>
                    `;
                });
                
                tableBody.innerHTML = html;
                
                // Recherche
                document.getElementById('worker-salary-search').addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const rows = tableBody.querySelectorAll('tr');
                    
                    rows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        row.style.display = text.includes(searchTerm) ? '' : 'none';
                    });
                });
                
            } catch (error) {
                console.error("Erreur chargement salaires personnels:", error);
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Erreur de chargement</td></tr>';
            }
        }

        // 26. GÉNÉRATION DU REÇU DE SALAIRE
        async function generateSalaryReceipt(name, matricule, month, amount, description, type) {
            const receiptContent = document.getElementById('salary-receipt-content');
            
            const today = new Date();
            const formattedDate = today.toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: 'long',
                year: 'numeric'
            });
            
            const receiptHTML = `
                <div class="communique-preview">
                    <div class="communique-header">
                        <img src="R.png" alt="Logo CS la Colombe" class="communique-logo">
                        <div class="communique-title">BORDEREAU DE PAIEMENT DE SALAIRE</div>
                        <div>Complexe Scolaire la Colombe</div>
                        <div>Lubumbashi, République Démocratique du Congo</div>
                    </div>
                    
                    <div class="communique-date">
                        Lubumbashi, le ${formattedDate}
                    </div>
                    
                    <div class="communique-content">
                        <p>Je soussigné(e), <strong>${currentUser.email}</strong>, certifie avoir effectué le paiement suivant :</p>
                        
                        <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd; width: 30%;"><strong>Bénéficiaire :</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${name}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Matricule :</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${matricule}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Type :</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${type}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Mois :</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${month}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Montant :</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;" class="currency-display"><strong>$${amount.toFixed(2)}</strong></td>
                            </tr>
                            ${description ? `
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;"><strong>Description :</strong></td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${description}</td>
                            </tr>
                            ` : ''}
                        </table>
                        
                        <p>Le paiement a été effectué en bonne et due forme.</p>
                    </div>
                    
                    <div class="communique-signature">
                        <p>Le Secrétaire</p>
                        <div class="signature-line"></div>
                    </div>
                </div>
            `;
            
            receiptContent.innerHTML = receiptHTML;
            document.getElementById('salary-receipt-modal').classList.remove('hidden');
        }

        // 27. IMPRESSION DU REÇU DE SALAIRE
        document.getElementById('print-salary-receipt-btn').addEventListener('click', () => {
            const receiptContent = document.getElementById('salary-receipt-content').innerHTML;
            const printWindow = window.open('', '_blank');
            
            const printHTML = `
                <!DOCTYPE html>
                <html>
                    <head>
                        <title>Bordereau de paiement - CS la Colombe</title>
                        <style>
                            body { 
                                font-family: Arial, sans-serif; 
                                margin: 30px; 
                                font-size: 12px;
                            }
                            .communique-preview { 
                                border: 1px solid #ddd; 
                                padding: 20px; 
                            }
                            .communique-header { 
                                text-align: center; 
                                margin-bottom: 20px; 
                            }
                            .communique-logo { 
                                max-width: 100px; 
                                margin-bottom: 10px; 
                            }
                            .communique-title { 
                                font-size: 16px; 
                                font-weight: bold; 
                                margin: 10px 0; 
                            }
                            .communique-date { 
                                text-align: right; 
                                margin-bottom: 20px; 
                            }
                            table { 
                                width: 100%; 
                                border-collapse: collapse; 
                                margin: 20px 0; 
                            }
                            td { 
                                padding: 8px; 
                                border: 1px solid #ddd; 
                            }
                            .communique-signature { 
                                margin-top: 50px; 
                                text-align: right; 
                            }
                            .signature-line { 
                                border-top: 1px solid #000; 
                                margin-top: 30px; 
                                width: 250px; 
                                margin-left: auto; 
                            }
                            .currency-display { 
                                font-weight: bold; 
                                color: #27ae60; 
                            }
                            @media print {
                                body { margin: 10px; }
                                .communique-preview { border: none; }
                            }
                        </style>
                    </head>
                    <body>
                        ${receiptContent}
                        <script>
                            window.onload = function() {
                                window.print();
                                setTimeout(function() {
                                    window.close();
                                }, 1000);
                            }
                        <\/script>
                    </body>
                </html>
            `;
            
            printWindow.document.write(printHTML);
            printWindow.document.close();
        });

        // 28. BOUTON RETOUR POUR LE REÇU
        document.getElementById('back-salary-receipt-btn').addEventListener('click', () => {
            document.getElementById('salary-receipt-modal').classList.add('hidden');
        });

        // 29. CHARGEMENT DES ARCHIVES COMMUNIQUÉS
        async function loadCommuniqueArchives() {
            const tableBody = document.getElementById('archive-table-body');
            tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Chargement...</td></tr>';
            
            try {
                const communiquesSnap = await getDocs(query(collection(db, 'communiques'), orderBy('publishedAt', 'desc')));
                
                if (communiquesSnap.empty) {
                    tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Aucun communiqué publié.</td></tr>';
                    return;
                }
                
                let html = '';
                communiquesSnap.forEach(doc => {
                    const data = doc.data();
                    
                    const statusBadge = data.status === 'published' 
                        ? '<span class="badge badge-success">Publié</span>' 
                        : '<span class="badge badge-warning">Brouillon</span>';
                    
                    html += `
                        <tr>
                            <td>${formatDate(data.publishedAt)}</td>
                            <td>${data.feeType}</td>
                            <td>${data.month}</td>
                            <td>${data.schoolYear}</td>
                            <td>${data.classes.join(', ')}</td>
                            <td class="currency-display">$${data.amount.toFixed(2)}</td>
                            <td>${statusBadge}</td>
                            <td class="action-buttons">
                                <button class="btn btn-primary" onclick="viewCommuniqueDetails('${doc.id}')">Détails</button>
                                <button class="btn btn-info" onclick="reprintCommunique('${doc.id}')">Réimprimer</button>
                            </td>
                        </tr>
                    `;
                });
                
                tableBody.innerHTML = html;
                
                // Filtres
                document.getElementById('archive-fee-filter').addEventListener('change', filterArchives);
                document.getElementById('archive-month-filter').addEventListener('change', filterArchives);
                document.getElementById('archive-year-filter').addEventListener('change', filterArchives);
                
            } catch (error) {
                console.error("Erreur chargement archives:", error);
                tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Erreur de chargement</td></tr>';
            }
        }

        // 30. FILTRAGE DES ARCHIVES
        function filterArchives() {
            const feeFilter = document.getElementById('archive-fee-filter').value;
            const monthFilter = document.getElementById('archive-month-filter').value;
            const yearFilter = document.getElementById('archive-year-filter').value;
            
            const rows = document.querySelectorAll('#archive-table-body tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length < 8) return;
                
                const feeType = cells[1].textContent;
                const month = cells[2].textContent;
                const year = cells[3].textContent;
                
                let showRow = true;
                
                if (feeFilter && feeType !== feeFilter) showRow = false;
                if (monthFilter && month !== monthFilter) showRow = false;
                if (yearFilter && year !== yearFilter) showRow = false;
                
                row.style.display = showRow ? '' : 'none';
            });
        }

        // 31. CHARGEMENT DES ARCHIVES SALAIRES
        async function loadSalaryArchives() {
            // Enseignants
            await loadTeacherSalaryArchives();
            // Personnels
            await loadWorkerSalaryArchives();
        }

        async function loadTeacherSalaryArchives() {
            const tableBody = document.getElementById('archive-teachers-table-body');
            
            try {
                const salariesSnap = await getDocs(query(collection(db, 'teacher_salaries'), orderBy('paidAt', 'desc')));
                
                let html = '';
                if (salariesSnap.empty) {
                    html = '<tr><td colspan="7" style="text-align: center;">Aucun paiement enregistré.</td></tr>';
                } else {
                    salariesSnap.forEach(doc => {
                        const data = doc.data();
                        
                        html += `
                            <tr>
                                <td>${formatDate(data.paidAt)}</td>
                                <td>${data.teacherMatricule}</td>
                                <td>${data.teacherName}</td>
                                <td>${data.month}</td>
                                <td class="currency-display">$${data.amount.toFixed(2)}</td>
                                <td>${data.teacherType === 'secondary' ? 'Secondaire' : data.teacherType === 'primary' ? 'Primaire' : 'Maternelle'}</td>
                                <td class="action-buttons">
                                    <button class="btn btn-primary" onclick="viewSalaryDetails('${doc.id}', 'teacher')">Détails</button>
                                </td>
                            </tr>
                        `;
                    });
                }
                
                tableBody.innerHTML = html;
                
            } catch (error) {
                console.error("Erreur chargement archives enseignants:", error);
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Erreur de chargement</td></tr>';
            }
        }

        async function loadWorkerSalaryArchives() {
            const tableBody = document.getElementById('archive-workers-table-body');
            
            try {
                const salariesSnap = await getDocs(query(collection(db, 'worker_salaries'), orderBy('paidAt', 'desc')));
                
                let html = '';
                if (salariesSnap.empty) {
                    html = '<tr><td colspan="7" style="text-align: center;">Aucun paiement enregistré.</td></tr>';
                } else {
                    salariesSnap.forEach(doc => {
                        const data = doc.data();
                        
                        html += `
                            <tr>
                                <td>${formatDate(data.paidAt)}</td>
                                <td>${data.workerMatricule}</td>
                                <td>${data.workerName}</td>
                                <td>${data.month}</td>
                                <td class="currency-display">$${data.amount.toFixed(2)}</td>
                                <td>${data.workerFunction}</td>
                                <td class="action-buttons">
                                    <button class="btn btn-primary" onclick="viewSalaryDetails('${doc.id}', 'worker')">Détails</button>
                                </td>
                            </tr>
                        `;
                    });
                }
                
                tableBody.innerHTML = html;
                
            } catch (error) {
                console.error("Erreur chargement archives personnels:", error);
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Erreur de chargement</td></tr>';
            }
        }

        // 32. FONCTIONS GLOBALES POUR LES BOUTONS
        window.viewWorkerDetails = async (workerMatricule) => {
            try {
                const workerDoc = await getDoc(doc(db, 'workers', workerMatricule));
                
                if (!workerDoc.exists()) {
                    showAlert('Personnel non trouvé.', 'error');
                    return;
                }
                
                const data = workerDoc.data();
                alert(`
                    Détails du personnel:
                    
                    Matricule: ${data.matricule}
                    Nom: ${data.fullName}
                    Date de naissance: ${data.birthdate}
                    Lieu de naissance: ${data.birthplace}
                    Sexe: ${data.gender === 'M' ? 'Masculin' : 'Féminin'}
                    Adresse: ${data.address}
                    Téléphone: ${data.phone}
                    Fonction: ${data.function}
                    Description: ${data.description || 'Aucune'}
                    Date d'embauche: ${data.hiredDate}
                    Statut: ${data.status === 'active' ? 'Actif' : 'Inactif'}
                `);
                
            } catch (error) {
                showAlert('Erreur: ' + error.message, 'error');
            }
        };

        window.editWorker = async (workerMatricule) => {
    try {
        const workerDoc = await getDoc(doc(db, 'workers', workerMatricule));
        
        if (!workerDoc.exists()) {
            showAlert('Personnel non trouvé.', 'error');
            return;
        }
        
        const data = workerDoc.data();
        
        // Remplir le formulaire avec les données existantes
        document.getElementById('edit-worker-matricule').value = workerMatricule;
        document.getElementById('edit-worker-name').value = data.fullName;
        document.getElementById('edit-worker-birthdate').value = data.birthdate;
        document.getElementById('edit-worker-birthplace').value = data.birthplace;
        document.getElementById('edit-worker-gender').value = data.gender;
        document.getElementById('edit-worker-address').value = data.address;
        document.getElementById('edit-worker-phone').value = data.phone;
        document.getElementById('edit-worker-function').value = data.function;
        document.getElementById('edit-worker-status').value = data.status || 'active';
        document.getElementById('edit-worker-hireddate').value = data.hiredDate || '';
        document.getElementById('edit-worker-description').value = data.description || '';
        
        // Afficher la photo
        const photoPreview = document.getElementById('edit-worker-photo-preview');
        if (data.photoURL) {
            photoPreview.innerHTML = `<img src="${data.photoURL}" class="photo-preview">`;
        } else {
            photoPreview.innerHTML = '<i class="fas fa-user"></i>';
        }
        
        // Réinitialiser la variable de fichier photo
        editWorkerPhotoFile = null;
        
        // Afficher le modal
        document.getElementById('edit-worker-modal').classList.remove('hidden');
        
    } catch (error) {
        console.error('Erreur chargement données:', error);
        showAlert('Erreur lors du chargement des données: ' + error.message, 'error');
    }
};

// Gestion de la photo dans l'édition
document.getElementById('edit-worker-photo').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        if (file.size > 5 * 1024 * 1024) {
            showAlert("La photo ne doit pas dépasser 5MB", "error");
            return;
        }
        if (!file.type.startsWith('image/')) {
            showAlert("Veuillez sélectionner une image valide", "error");
            return;
        }
        editWorkerPhotoFile = file;
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('edit-worker-photo-preview').innerHTML = `<img src="${e.target.result}" class="photo-preview">`;
        }
        reader.readAsDataURL(file);
    }
});

// Soumission du formulaire de modification
document.getElementById('edit-worker-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const matricule = document.getElementById('edit-worker-matricule').value;
    const fullName = document.getElementById('edit-worker-name').value;
    const birthdate = document.getElementById('edit-worker-birthdate').value;
    const birthplace = document.getElementById('edit-worker-birthplace').value;
    const gender = document.getElementById('edit-worker-gender').value;
    const address = document.getElementById('edit-worker-address').value;
    const phone = document.getElementById('edit-worker-phone').value;
    const workerFunction = document.getElementById('edit-worker-function').value;
    const status = document.getElementById('edit-worker-status').value;
    const hiredDate = document.getElementById('edit-worker-hireddate').value;
    const description = document.getElementById('edit-worker-description').value;
    
    // Validation
    if (!fullName || !birthdate || !birthplace || !gender || !address || !phone || !workerFunction) {
        showAlert("Veuillez remplir tous les champs obligatoires (*)", "error");
        return;
    }
    
    const submitBtn = document.getElementById('edit-worker-submit-btn');
    const originalText = submitBtn.textContent;
    
    try {
        submitBtn.textContent = 'Mise à jour en cours...';
        submitBtn.disabled = true;
        
        // Récupérer les données actuelles
        const workerRef = doc(db, 'workers', matricule);
        const currentWorker = await getDoc(workerRef);
        const currentData = currentWorker.data();
        
        let photoURL = currentData.photoURL;
        
        // Uploader la nouvelle photo si fournie
        if (editWorkerPhotoFile) {
            try {
                photoURL = await uploadToCloudinary(editWorkerPhotoFile, `workers/${matricule}`);
            } catch (uploadError) {
                console.error("Erreur upload photo:", uploadError);
                showAlert("Attention: La photo n'a pas pu être mise à jour", "warning");
            }
        }
        
        // Mettre à jour les données
        const updatedData = {
            fullName,
            birthdate,
            birthplace,
            gender,
            address,
            phone,
            function: workerFunction,
            status,
            hiredDate: hiredDate || currentData.hiredDate,
            description,
            photoURL,
            updatedAt: serverTimestamp()
        };
        
        await updateDoc(workerRef, updatedData);
        
        showAlert(`Personnel ${matricule} mis à jour avec succès !`, 'success');
        
        // Fermer le modal
        document.getElementById('edit-worker-modal').classList.add('hidden');
        
        // Réinitialiser
        editWorkerPhotoFile = null;
        
        // Recharger la liste
        loadWorkersList();
        
    } catch (error) {
        console.error('Erreur modification personnel:', error);
        showAlert('Erreur lors de la modification: ' + error.message, 'error');
    } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    }
});

// Suppression d'un personnel
document.getElementById('delete-worker-btn').addEventListener('click', async () => {
    const matricule = document.getElementById('edit-worker-matricule').value;
    const workerName = document.getElementById('edit-worker-name').value;
    
    if (!confirm(`Êtes-vous sûr de vouloir supprimer le personnel "${workerName}" (${matricule}) ?\nCette action est irréversible.`)) {
        return;
    }
    
    try {
        const workerRef = doc(db, 'workers', matricule);
        
        // Option 1: Supprimer complètement
        // await deleteDoc(workerRef);
        
        // Option 2: Marquer comme supprimé (recommandé pour garder l'historique)
        await updateDoc(workerRef, {
            status: 'deleted',
            deletedAt: serverTimestamp(),
            deletedBy: currentUser.uid
        });
        
        showAlert(`Personnel ${matricule} supprimé avec succès`, 'success');
        
        // Fermer le modal
        document.getElementById('edit-worker-modal').classList.add('hidden');
        
        // Recharger la liste
        loadWorkersList();
        
    } catch (error) {
        console.error('Erreur suppression personnel:', error);
        showAlert('Erreur lors de la suppression: ' + error.message, 'error');
    }
});

// Bouton d'annulation
document.getElementById('cancel-edit-btn').addEventListener('click', () => {
    document.getElementById('edit-worker-modal').classList.add('hidden');
    editWorkerPhotoFile = null;
});

// 40. GESTION DES BOUTONS FERMER MODAL
document.querySelectorAll('.close-modal').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.modal').forEach(modal => modal.classList.add('hidden'));
        // Réinitialiser la photo d'édition
        editWorkerPhotoFile = null;
    });
});

// 41. FERMER LES MODALS EN CLIQUANT À L'EXTÉRIEUR
document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.classList.add('hidden');
            // Si c'est le modal d'édition, réinitialiser la photo
            if (modal.id === 'edit-worker-modal') {
                editWorkerPhotoFile = null;
            }
        }
    });
});

        window.printSalaryReceipt = async (salaryId, type) => {
            try {
                let collectionName = type === 'teacher' ? 'teacher_salaries' : 'worker_salaries';
                const salaryDoc = await getDoc(doc(db, collectionName, salaryId));
                
                if (!salaryDoc.exists()) {
                    showAlert('Paiement non trouvé.', 'error');
                    return;
                }
                
                const data = salaryDoc.data();
                
                let name, matricule;
                if (type === 'teacher') {
                    name = data.teacherName;
                    matricule = data.teacherMatricule;
                } else {
                    name = data.workerName;
                    matricule = data.workerMatricule;
                }
                
                await generateSalaryReceipt(
                    name,
                    matricule,
                    data.month,
                    data.amount,
                    data.description,
                    type === 'teacher' ? 'ENSEIGNANT' : 'PERSONNEL'
                );
                
            } catch (error) {
                showAlert('Erreur: ' + error.message, 'error');
            }
        };

        window.viewCommuniqueDetails = async (communiqueId) => {
            try {
                const communiqueDoc = await getDoc(doc(db, 'communiques', communiqueId));
                
                if (!communiqueDoc.exists()) {
                    showAlert('Communiqué non trouvé.', 'error');
                    return;
                }
                
                const data = communiqueDoc.data();
                
                alert(`
                    Détails du communiqué:
                    
                    Type de frais: ${data.feeType}
                    Date limite: ${data.deadline}
                    Année scolaire: ${data.schoolYear}
                    Mois: ${data.month}
                    Montant: $${data.amount.toFixed(2)}
                    Classes: ${data.classes.join(', ')}
                    Message: ${data.message || 'Aucun'}
                    Publié le: ${formatDate(data.publishedAt)}
                    Statut: ${data.status}
                `);
                
            } catch (error) {
                showAlert('Erreur: ' + error.message, 'error');
            }
        };

        window.reprintCommunique = async (communiqueId) => {
            // Réimpression du communiqué
            showAlert('Fonction de réimpression à implémenter', 'info');
        };

        // 33. IMPRESSION DE LA CARTE DU PERSONNEL
        window.printWorkerCard = function() {
            if (!lastCreatedWorker) {
                showAlert("Aucun personnel récemment créé", "error");
                return;
            }
            
            const worker = lastCreatedWorker;
            const cardContent = document.getElementById('worker-card-content');
            
            const today = new Date();
            const formattedDate = today.toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: 'long',
                year: 'numeric'
            });
            
            const cardHTML = `
                <div class="communique-preview">
                    <div class="communique-header">
                        <img src="R.png" alt="Logo CS la Colombe" class="communique-logo">
                        <div class="communique-title">CARTE D'IDENTIFICATION DU PERSONNEL</div>
                        <div>Complexe Scolaire la Colombe</div>
                    </div>
                    
                    <div style="display: flex; gap: 2rem; margin: 2rem 0;">
                        <div style="flex: 1;">
                            ${worker.photoURL ? 
                                `<img src="${worker.photoURL}" style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary);">` :
                                '<div style="width: 150px; height: 150px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; font-size: 3rem; color: #999;"><i class="fas fa-user"></i></div>'
                            }
                        </div>
                        <div style="flex: 2;">
                            <table style="width: 100%;">
                                <tr>
                                    <td style="padding: 8px; width: 40%;"><strong>Matricule:</strong></td>
                                    <td style="padding: 8px;">${worker.matricule}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px;"><strong>Nom:</strong></td>
                                    <td style="padding: 8px;">${worker.fullName}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px;"><strong>Fonction:</strong></td>
                                    <td style="padding: 8px;">${worker.function}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px;"><strong>Date d'embauche:</strong></td>
                                    <td style="padding: 8px;">${worker.hiredDate}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px;"><strong>Statut:</strong></td>
                                    <td style="padding: 8px;"><span class="badge badge-success">Actif</span></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    <div style="margin: 2rem 0;">
                        <p><strong>Description:</strong> ${worker.description || 'Aucune description'}</p>
                    </div>
                    
                    <div class="communique-signature">
                        <p>Le Directeur</p>
                        <div class="signature-line"></div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 2rem; font-size: 0.9rem; color: #666;">
                        <p>Cette carte est valide pour l'année scolaire ${new Date().getFullYear()}-${new Date().getFullYear() + 1}</p>
                        <p>Émise le ${formattedDate}</p>
                    </div>
                </div>
            `;
            
            cardContent.innerHTML = cardHTML;
            document.getElementById('worker-card-modal').classList.remove('hidden');
        };

        // 34. IMPRESSION DE LA CARTE
        document.getElementById('print-worker-card-btn').addEventListener('click', () => {
            const cardContent = document.getElementById('worker-card-content').innerHTML;
            const printWindow = window.open('', '_blank');
            
            const printHTML = `
                <!DOCTYPE html>
                <html>
                    <head>
                        <title>Carte du personnel - CS la Colombe</title>
                        <style>
                            body { 
                                font-family: Arial, sans-serif; 
                                margin: 30px; 
                                font-size: 12px;
                            }
                            .communique-preview { 
                                border: 1px solid #ddd; 
                                padding: 20px; 
                                max-width: 600px; 
                                margin: 0 auto;
                            }
                            .communique-header { 
                                text-align: center; 
                                margin-bottom: 20px; 
                            }
                            .communique-logo { 
                                max-width: 100px; 
                                margin-bottom: 10px; 
                            }
                            .communique-title { 
                                font-size: 16px; 
                                font-weight: bold; 
                                margin: 10px 0; 
                            }
                            table { 
                                width: 100%; 
                            }
                            td { 
                                padding: 6px; 
                            }
                            .communique-signature { 
                                margin-top: 30px; 
                                text-align: right; 
                            }
                            .signature-line { 
                                border-top: 1px solid #000; 
                                margin-top: 30px; 
                                width: 250px; 
                                margin-left: auto; 
                            }
                            .badge { 
                                display: inline-block; 
                                padding: 3px 8px; 
                                border-radius: 4px; 
                                background: #27ae60; 
                                color: white; 
                                font-size: 10px; 
                            }
                            @media print {
                                body { margin: 10px; }
                                .communique-preview { border: 1px solid #000; }
                            }
                        </style>
                    </head>
                    <body>
                        ${cardContent}
                        <script>
                            window.onload = function() {
                                window.print();
                                setTimeout(function() {
                                    window.close();
                                }, 1000);
                            }
                        <\/script>
                    </body>
                </html>
            `;
            
            printWindow.document.write(printHTML);
            printWindow.document.close();
        });

        // 35. BOUTON RETOUR POUR LA CARTE
        document.getElementById('back-worker-card-btn').addEventListener('click', () => {
            document.getElementById('worker-card-modal').classList.add('hidden');
        });

        // 36. NAVIGATION ENTRE LES PAGES
        document.querySelectorAll('.nav-menu a').forEach(link => {
            link.addEventListener('click', e => {
                e.preventDefault();
                document.querySelectorAll('.nav-menu a, .page').forEach(el => el.classList.remove('active'));
                link.classList.add('active');
                document.getElementById(link.dataset.page + '-page').classList.add('active');
                document.getElementById('page-title').textContent = link.textContent;
                
                // Fermer le menu sur mobile
                if (window.innerWidth <= 768) {
                    document.querySelector('.sidebar').classList.add('collapsed');
                }
            });
        });

        // 37. NAVIGATION ENTRE LES ONGLETS
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.dataset.tab;
                document.querySelectorAll('.tab, .tab-content').forEach(el => el.classList.remove('active'));
                tab.classList.add('active');
                
                // Onglets principaux
                if (tabId === 'teachers' || tabId === 'workers') {
                    document.getElementById(tabId + '-tab').classList.add('active');
                }
                
                // Onglets archives
                if (tabId === 'archive-teachers' || tabId === 'archive-workers') {
                    document.getElementById(tabId + '-tab').classList.add('active');
                }
            });
        });

        // 38. GESTION DU MENU BURGER
        document.getElementById('menu-toggle').addEventListener('click', () => {
            document.querySelector('.sidebar').classList.toggle('collapsed');
        });

        // 39. FERMER LE MENU EN CLIQUANT À L'EXTÉRIEUR SUR MOBILE
        document.addEventListener('click', (e) => {
            const sidebar = document.querySelector('.sidebar');
            const menuToggle = document.getElementById('menu-toggle');
            
            if (window.innerWidth <= 768 && 
                !sidebar.contains(e.target) && 
                !menuToggle.contains(e.target) &&
                !sidebar.classList.contains('collapsed')) {
                sidebar.classList.add('collapsed');
            }
        });

        // 40. GESTION DES BOUTONS FERMER MODAL
        document.querySelectorAll('.close-modal').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.modal').forEach(modal => modal.classList.add('hidden'));
            });
        });

        // 41. FERMER LES MODALS EN CLIQUANT À L'EXTÉRIEUR
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                }
            });
        });
    </script>
<script>
window.editWorker = async (workerMatricule) => {
    try {
        const workerDoc = await getDoc(doc(db, 'workers', workerMatricule));
        
        if (!workerDoc.exists()) {
            showAlert('Personnel non trouvé.', 'error');
            return;
        }
        
        const data = workerDoc.data();
        
        // Remplir le formulaire avec les données existantes
        document.getElementById('worker-name').value = data.fullName;
        document.getElementById('worker-birthdate').value = data.birthdate;
        document.getElementById('worker-birthplace').value = data.birthplace;
        document.getElementById('worker-gender').value = data.gender;
        document.getElementById('worker-address').value = data.address;
        document.getElementById('worker-phone').value = data.phone;
        document.getElementById('worker-function').value = data.function;
        document.getElementById('worker-description').value = data.description || '';
        
        // Afficher la photo existante
        if (data.photoURL) {
            document.getElementById('worker-photo-preview').innerHTML = 
                `<img src="${data.photoURL}" class="photo-preview">`;
        }
        
        // Changer le bouton pour "Modifier"
        const submitBtn = document.getElementById('worker-submit-btn');
        submitBtn.textContent = 'Modifier le Personnel';
        submitBtn.classList.remove('btn-primary');
        submitBtn.classList.add('btn-warning');
        
        // Stocker l'ID du personnel à modifier
        submitBtn.dataset.editingId = workerMatricule;
        
        // Faire défiler vers le formulaire
        document.getElementById('worker-form').scrollIntoView({ behavior: 'smooth' });
        
        showAlert(`Mode édition activé pour ${data.fullName}`, 'info');
        
    } catch (error) {
        showAlert('Erreur lors du chargement des données: ' + error.message, 'error');
    }
};

</script>
</body>
</html>
