<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Espace secretary - hybrilink</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<!-- PWA Meta Tags -->
  <meta name="application-name" content="TheoVêt">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="TheoVêt">
  <meta name="description" content="Solution complète de gestion de commerce de vêtements">
  <meta name="format-detection" content="telephone=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="msapplication-TileColor" content="#3498db">
  <meta name="msapplication-tap-highlight" content="no">
  <meta name="theme-color" content="#3498db">



<!-- Service Worker et mise à jour -->
     <meta name="version" content="2.1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">


  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" href="icon-192x192.png">
  <link rel="apple-touch-icon" sizes="192x192" href="icon-192x192.png">
  <link rel="apple-touch-icon" sizes="72x72" href="icon-72x72.png">
  <link rel="apple-touch-icon" sizes="167x167" href="icon-167x167.png">

  <!-- Manifest -->
  <link rel="manifest" href="manifest.json">

  <!-- Styles et Bibliothèques -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<!-- Scripts de mise à jour -->
<script src="update-system.js"></script>
    <style>
        :root {
            --primary: #3498db; --secondary: #2c3e50; --success: #27ae60;
            --danger: #e74c3c; --warning: #f39c12; --info: #1abc9c;
            --light: #ecf0f1; --dark: #34495e;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background-color: #f5f6fa; }
        .hidden { display: none !important; }

        /* --- Écran de démarrage --- */
        .splash-screen { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            z-index: 3000;
            color: white;
        }
        .splash-logo { 
            width: 150px; 
            height: 150px; 
            margin-bottom: 2rem;
            background: white;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .splash-logo i { 
            font-size: 4rem; 
            color: var(--primary);
        }
        .splash-text { 
            text-align: center; 
            margin-bottom: 2rem;
        }
        .splash-text h1 { 
            font-size: 2.5rem; 
            margin-bottom: 0.5rem;
            font-weight: 700;
        }
        .splash-text p { 
            font-size: 1.2rem; 
            opacity: 0.9;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top: 5px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- Styles Communs --- */
        .login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .login-card { background: white; padding: 3rem; border-radius: 10px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
        .app-container { display: flex; min-height: 100vh; }
        .sidebar { width: 250px; background: white; box-shadow: 2px 0 10px rgba(0,0,0,0.08); flex-shrink: 0; transition: transform 0.3s ease; }
        .sidebar.collapsed { transform: translateX(-100%); }
        .nav-menu { list-style: none; padding: 1rem 0; margin: 0; }
        .nav-menu li a { display: flex; align-items: center; gap: 12px; padding: 14px 20px; color: var(--dark); text-decoration: none; font-weight: 500; }

        /* Styles pour les notifications de mise à jour */
        .update-toast {
          position: fixed;
          top: 20px;
          right: 20px;
          background: white;
          border-left: 4px solid #3498db;
          border-radius: 8px;
          box-shadow: 0 4px 15px rgba(0,0,0,0.15);
          padding: 15px 20px;
          min-width: 300px;
          max-width: 400px;
          z-index: 9999;
          transform: translateX(120%);
          transition: transform 0.3s ease;
        }

        .update-toast.show {
          transform: translateX(0);
        }

        .update-toast.success {
          border-left-color: #27ae60;
        }

        .update-toast.warning {
          border-left-color: #f39c12;
        }

        .update-toast.danger {
          border-left-color: #e74c3c;
        }

        .update-toast.info {
          border-left-color: #3498db;
        }

        @keyframes pulse {
          0% { transform: scale(1); }
          50% { transform: scale(1.05); }
          100% { transform: scale(1); }
        }

        .update-available {
          animation: pulse 2s infinite;
        }

        .nav-menu li a.active, .nav-menu li a:hover { background: #eaf5fc; color: var(--primary); }
        .nav-submenu { list-style: none; padding-left: 2rem; }
        .nav-submenu li a { padding: 10px 20px; font-size: 0.9rem; }
        .nav-menu .has-submenu > a::after { content: '\f078'; font-family: 'Font Awesome 5 Free'; font-weight: 900; margin-left: auto; transition: transform 0.3s; }
        .nav-menu .has-submenu.active > a::after { transform: rotate(180deg); }
        .nav-submenu { display: none; }
        .nav-menu .has-submenu.active .nav-submenu { display: block; }
        .main-content { flex: 1; display: flex; flex-direction: column; }
        .app-header { background: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
        .content-area { padding: 2rem; }
        .page { display: none; }
        .page.active { display: block; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: 500; color: white; }
        .btn-primary { background: var(--primary); }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        .btn-warning { background: var(--warning); }
        .btn-info { background: var(--info); }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .card { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 1.5rem; }
        .form-row { display: flex; gap: 1rem; }
        .alert { padding: 1rem; border-radius: 5px; margin-bottom: 1rem; }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-error { background: #f8d7da; color: #721c24; }
        .alert-info { background: #d1ecf1; color: #0c5460; }
        
        /* --- Styles améliorés --- */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; font-weight: 600; }
        tr:hover { background-color: #f8f9fa; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 500; }
        .badge-success { background-color: var(--success); color: white; }
        .badge-warning { background-color: var(--warning); color: white; }
        .badge-danger { background-color: var(--danger); color: white; }
        .badge-info { background-color: var(--info); color: white; }
        .badge-secondary { background-color: var(--secondary); color: white; }
        .search-box { margin-bottom: 1.5rem; }
        .search-box input { width: 100%; max-width: 400px; }
        .action-buttons { display: flex; gap: 0.5rem; }
        .action-buttons button { padding: 6px 12px; font-size: 0.85rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; cursor: pointer; transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card i { font-size: 2rem; margin-bottom: 0.5rem; color: var(--primary); }
        .stat-card h3 { font-size: 1.8rem; margin: 0.5rem 0; }
        .stat-card p { color: #666; font-size: 0.9rem; }
        .filter-options { display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .filter-options select { min-width: 150px; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 2rem; border-radius: 10px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .close-modal { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; }
        .tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 1.5rem; }
        .tab { padding: 10px 20px; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab.active { border-bottom: 2px solid var(--primary); color: var(--primary); font-weight: 500; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .student-details { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; }
        .detail-item { margin-bottom: 1rem; }
        .detail-item label { font-weight: 600; color: #666; }
        .detail-item p { margin-top: 0.25rem; }
        .photo-upload { text-align: center; margin: 1rem 0; }
        .photo-preview { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); margin: 0 auto 1rem; display: block; }
        .photo-placeholder { width: 120px; height: 120px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; color: #999; }
        .file-input { display: none; }
        .upload-btn { background: var(--info); color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; }
        .loading { opacity: 0.6; pointer-events: none; }
        .multi-select { height: 120px; }
        .teacher-classes { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem; }
        .class-checkbox { display: flex; align-items: center; gap: 0.5rem; }
        
        /* --- Styles pour la photo de profil du secrétaire --- */
        .secretary-profile { display: flex; align-items: center; gap: 1rem; }
        .secretary-photo { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }
        .secretary-photo-placeholder { width: 40px; height: 40px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; color: #999; }
        
        /* --- Styles pour le reçu --- */
        .receipt { max-width: 600px; margin: 0 auto; background: white; padding: 2rem; border: 1px solid #ddd; font-family: Arial, sans-serif; }
        .receipt-header { text-align: center; margin-bottom: 2rem; border-bottom: 2px solid var(--primary); padding-bottom: 1rem; }
        .receipt-logo { max-width: 150px; margin-bottom: 1rem; }
        .receipt-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem; color: var(--primary); }
        .receipt-details { margin-bottom: 2rem; }
        .receipt-row { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
        .receipt-divider { border-top: 1px solid #ddd; margin: 1rem 0; }
        .receipt-footer { text-align: center; margin-top: 2rem; font-size: 0.9rem; color: #666; border-top: 1px solid #eee; padding-top: 1rem; }
        .code-validation { background: #f8f9fa; padding: 1rem; border-radius: 5px; margin: 1rem 0; text-align: center; border: 1px dashed #ddd; }
        .code-validation h3 { color: var(--primary); margin-bottom: 0.5rem; }
        .code-value { font-size: 1.5rem; font-weight: bold; letter-spacing: 2px; color: var(--success); background: white; padding: 0.5rem; border-radius: 4px; border: 1px solid #ddd; }
        
        /* --- Styles pour la gestion des frais --- */
        .fees-controls { display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .fees-controls select, .fees-controls input { min-width: 150px; }
        .fees-summary { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .fees-summary-card { background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); text-align: center; }
        .fees-summary-card h4 { margin-bottom: 0.5rem; color: var(--dark); }
        .fees-summary-card p { font-size: 1.5rem; font-weight: bold; color: var(--primary); }

  .back-btn {
   font-size: 20px;}
        
        /* --- Styles pour l'espace administratif --- */
        .admin-controls { display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .report-card { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 1.5rem; }
        .report-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .report-summary { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .signature-area { margin-top: 3rem; display: flex; justify-content: space-between; }
        .signature-box { text-align: center; width: 45%; }
        .signature-line { border-top: 1px solid #000; margin-top: 3rem; }

        /* --- Styles pour les montants en dollars --- */
        .currency-display { font-weight: bold; color: var(--success); }
        .currency-input-group { position: relative; }
        .currency-symbol { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #666; font-weight: bold; }
        .currency-input { padding-left: 25px; }

        /* --- Styles pour les mois multiples --- */
        .months-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 0.5rem; margin: 1rem 0; }
        .month-checkbox { display: flex; align-items: center; gap: 0.5rem; }
        
        /* --- Styles pour le bouton menu --- */
        .menu-toggle { display: none; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--dark); }
        
        /* --- Styles pour le statut de connexion --- */
        .connection-status { 
            display: flex; 
            align-items: center; 
            gap: 0.5rem; 
            padding: 0.5rem 1rem; 
            border-radius: 20px; 
            font-size: 0.8rem; 
            margin-right: 1rem;
        }
        .connection-status.online { background: #d4edda; color: #155724; }
        .connection-status.offline { background: #f8d7da; color: #721c24; }
        .status-indicator { 
            width: 10px; 
            height: 10px; 
            border-radius: 50%; 
            display: inline-block;
        }
        .status-online { background: var(--success); }
        .status-offline { background: var(--danger); }
        
        /* --- Styles pour le bouton d'installation PWA --- */
        .install-btn { 
            background: var(--info); 
            color: white; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 5px; 
            cursor: pointer; 
            margin-right: 1rem;
            display: none;
        }
        
        /* --- Styles pour la recherche/modification --- */
        .search-modify-container { 
            background: white; 
            padding: 1.5rem; 
            border-radius: 8px; 
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .class-stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .class-stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        
        .class-stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #eee;
        }
        
        .class-students-list {
            margin-top: 1rem;
        }
        
        .class-student-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid #f5f5f5;
        }
        
        .class-student-item:last-child {
            border-bottom: none;
        }
        
        @media (max-width: 768px) {
            .menu-toggle { display: block; }
            .sidebar { position: fixed; z-index: 1000; height: 100%; }
            .main-content { margin-left: 0; }
            .connection-status, .install-btn { display: none; }
            .form-row { flex-direction: column; }
            .fees-controls, .admin-controls { flex-direction: column; }
        }
    </style>
</head>
<body>
    <!-- Écran de démarrage -->
    <div id="splash-screen" class="splash-screen">
        <div class="splash-logo">
            <i > <img src="hi.png" width="50px"></i>
        </div>
        <div class="splash-text">
            <h1>hybrilink</h1>
            <p>Portail Secrétariat</p>
        </div>
        <div class="loading-spinner"></div>
    </div>

    <!-- Écran de connexion sécurisé -->
    <div id="login-overlay" class="login-overlay hidden">
        <div class="login-card">
            <h3>Portail Secrétariat</h3>
            <p>Veuillez vous connecter pour continuer.</p>
            <form id="login-form" style="margin-top: 2rem;">
                <div class="form-group">
                    <input type="email" id="login-email" class="form-control" placeholder="Email" required>
                </div>
                <div class="form-group">
                    <input type="password" id="login-password" class="form-control" placeholder="Mot de passe" required>
                </div>
                <div id="login-alert" class="alert hidden" style="margin-top: 1rem;"></div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Connexion</button>
            </form>
        </div>
    </div>

    <!-- Contenu de l'application (caché par défaut) -->
    <div id="app-root" class="app-container hidden">
        <nav class="sidebar">
            <div style="padding: 1.5rem; text-align: center; border-bottom: 1px solid #eee;">
                <i class="fas fa-edit" style="font-size: 2rem; color: var(--primary);"></i>
                <h3 style="margin-top: 0.5rem;">Secrétariat</h3>
            </div>
            <ul class="nav-menu">
                <li><a href="#" data-page="other-management"><i class="fas fa-cogs fa-fw"></i> Gestion Autres</a></li>
                <li><a href="#" class="active" data-page="dashboard"><i class="fas fa-tachometer-alt fa-fw"></i> Tableau de Bord</a></li>
                
                <!-- Menu déroulant Élèves -->
                <li class="has-submenu">
                    <a href="#"><i class="fas fa-user-graduate fa-fw"></i> Élèves</a>
                    <ul class="nav-submenu">
                        <li><a href="#" data-page="enroll-student">Inscrire Élève Secondaire</a></li>
                        <li><a href="#" data-page="enroll-primary-student">Inscrire Élève Primaire</a></li>
                        <li><a href="#" data-page="enroll-kindergarten-student">Inscrire Élève Maternelle</a></li>
                    </ul>
                </li>
                
                <!-- Menu déroulant Enseignants -->
                <li class="has-submenu">
                    <a href="#"><i class="fas fa-chalkboard-teacher fa-fw"></i> Enseignants</a>
                    <ul class="nav-submenu">
                        <li><a href="#" data-page="enroll-teacher">Inscrire Enseignant Secondaire</a></li>
                        <li><a href="#" data-page="enroll-primary-teacher">Inscrire Enseignant Primaire</a></li>
                        <li><a href="#" data-page="enroll-kindergarten-teacher">Inscrire Enseignant Maternelle</a></li>
                    </ul>
                </li>
                
                <!-- Menu déroulant Classes -->
                <li class="has-submenu">
                    <a href="#"><i class="fas fa-door-open fa-fw"></i> Classes</a>
                    <ul class="nav-submenu">
                        <li><a href="#" data-page="manage-classes">Gérer Classes Secondaires</a></li>
                        <li><a href="#" data-page="manage-primary-classes">Gérer Classes Primaires</a></li>
                        <li><a href="#" data-page="manage-kindergarten-classes">Gérer Classes Maternelles</a></li>
                    </ul>
                </li>
                
                <li><a href="#" data-page="validate-payment"><i class="fas fa-check-circle fa-fw"></i> Valider Paiement</a></li>
                <li><a href="#" data-page="manage-fees"><i class="fas fa-money-bill-wave fa-fw"></i> Gestion des Frais</a></li>
                <li><a href="#" data-page="students-list"><i class="fas fa-users fa-fw"></i> Statistiques Élèves</a></li>
                <li><a href="#" data-page="teachers-list"><i class="fas fa-user-tie fa-fw"></i> Statistiques Enseignants</a></li>
             <li> <button class="back-btn" onclick="window.location.href='new.html'">
              <i class="fas fa-bars"></i>
                rapport general
            </button></li>
                <li><a href="#" data-page="profile"><i class="fas fa-user fa-fw"></i> Profil</a></li>
            </ul>
        </nav>
        <div class="main-content">
            <header class="app-header">
                <button class="menu-toggle" id="menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h2 id="page-title">Tableau de Bord</h2>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div id="connection-status" class="connection-status online">
                        <span class="status-indicator status-online"></span>
                        <span>En ligne</span>
                    </div>
                    <button id="install-btn" class="install-btn">
                        <i class="fas fa-download"></i> Installer
                    </button>
                    <div class="secretary-profile">
                        <div id="secretary-photo-container">
                            <!-- La photo sera insérée ici dynamiquement -->
                        </div>
                        <span id="secretary-name"></span>
                    </div>
                    <button id="logout-btn" class="btn btn-danger">Déconnexion</button>
                </div>
            </header>
            <main class="content-area">
                <div id="global-alert" class="alert hidden"></div>

                <!-- Page: Tableau de Bord -->
                <div id="dashboard-page" class="page active">
                    <div class="stats-grid">
                        <div class="stat-card" data-target="students-list">
                            <i class="fas fa-users"></i>
                            <h3 id="total-students">0</h3>
                            <p>Élèves inscrits</p>
                        </div>
                        <div class="stat-card" data-target="teachers-list">
                            <i class="fas fa-user-tie"></i>
                            <h3 id="total-teachers">0</h3>
                            <p>Enseignants</p>
                        </div>
                        <div class="stat-card" data-target="manage-classes">
                            <i class="fas fa-door-open"></i>
                            <h3 id="total-classes">0</h3>
                            <p>Classes</p>
                        </div>
                        <div class="stat-card" data-target="validate-payment">
                            <i class="fas fa-money-bill-wave"></i>
                            <h3 id="pending-payments">0</h3>
                            <p>Paiements en attente</p>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h4>Activités récentes</h4>
                        <div id="recent-activities">
                            <p>Aucune activité récente</p>
                        </div>
                    </div>
                </div>

                <!-- Page: Gestion Autres -->
                <div id="other-management-page" class="page">
                    <div class="card">
                        <h4>Gestion des Personnels, Salaires et Communications</h4>
                        <p>Cette section permet de gérer les personnels ouvriers, les paiements de salaires et les communications aux parents.</p>
                        <div style="text-align: center; margin-top: 2rem;">
                            <a href="autre.html" class="btn btn-primary" style="padding: 12px 24px; font-size: 1.1rem;">
                                <i class="fas fa-external-link-alt"></i> Ouvrir la Gestion Complète
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Page: Inscrire Élève Secondaire -->
                <div id="enroll-student-page" class="page">
                    <div class="card">
                        <form id="student-form">
                            <h4>Informations de l'élève (Secondaire)</h4>
                            
                            <!-- Photo de profil -->
                            <div class="photo-upload">
                                <div class="photo-placeholder" id="student-photo-preview">
                                    <i class="fas fa-camera"></i>
                                </div>
                                <input type="file" id="student-photo" class="file-input" accept="image/*">
                                <button type="button" class="upload-btn" onclick="document.getElementById('student-photo').click()">
                                    <i class="fas fa-upload"></i> Choisir une photo
                                </button>
                            </div>

                            <div class="form-row">
                                <div class="form-group" style="flex: 2;">
                                    <label>Nom Complet</label>
                                    <input type="text" id="student-name" class="form-control" required>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Date de Naissance</label>
                                    <input type="date" id="student-birthdate" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Lieu de Naissance</label>
                                    <input type="text" id="student-birthplace" class="form-control" required>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Sexe</label>
                                    <select id="student-gender" class="form-control" required>
                                        <option value="">Sélectionner</option>
                                        <option value="M">Masculin</option>
                                        <option value="F">Féminin</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Adresse de Résidence</label>
                                <input type="text" id="student-address" class="form-control" required>
                            </div>
                            
                            <div class="form-group">
                                <label>Numéro de Téléphone</label>
                                <input type="tel" id="student-phone" class="form-control" required>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Classe</label>
                                    <select id="student-class" class="form-control" required></select>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Frais d'inscription ($)</label>
                                    <div class="currency-input-group">
                                        <span class="currency-symbol">$</span>
                                        <input type="number" id="student-fees" class="form-control currency-input" step="0.01" min="0" required value="0">
                                    </div>
                                </div>
                            </div>

                            <hr style="margin: 2rem 0;">
                            <h4>Informations du Parent</h4>
                            <div class="form-group">
                                <label>Nom du Parent</label>
                                <input type="text" id="parent-name" class="form-control" required>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Téléphone Parent</label>
                                    <input type="tel" id="parent-phone" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label>Adresse Parent</label>
                                    <input type="text" id="parent-address" class="form-control" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <button type="submit" class="btn btn-primary" style="margin-top: 1rem; margin-right: 1rem;" id="student-submit-btn">
                                    Inscrire l'Élève
                                </button>
                                <button type="button" class="btn btn-success" style="margin-top: 1rem;" id="print-student-btn" onclick="printEnrollmentForm('secondary')">
                                    <i class="fas fa-print"></i> Imprimer Bordereau
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Page: Inscrire Élève Primaire -->
                <div id="enroll-primary-student-page" class="page">
                    <div class="card">
                        <form id="primary-student-form">
                            <h4>Informations de l'élève (Primaire)</h4>
                            
                            <!-- Photo de profil -->
                            <div class="photo-upload">
                                <div class="photo-placeholder" id="primary-student-photo-preview">
                                    <i class="fas fa-camera"></i>
                                </div>
                                <input type="file" id="primary-student-photo" class="file-input" accept="image/*">
                                <button type="button" class="upload-btn" onclick="document.getElementById('primary-student-photo').click()">
                                    <i class="fas fa-upload"></i> Choisir une photo
                                </button>
                            </div>

                            <div class="form-row">
                                <div class="form-group" style="flex: 2;">
                                    <label>Nom Complet</label>
                                    <input type="text" id="primary-student-name" class="form-control" required>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Date de Naissance</label>
                                    <input type="date" id="primary-student-birthdate" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Lieu de Naissance</label>
                                    <input type="text" id="primary-student-birthplace" class="form-control" required>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Sexe</label>
                                    <select id="primary-student-gender" class="form-control" required>
                                        <option value="">Sélectionner</option>
                                        <option value="M">Masculin</option>
                                        <option value="F">Féminin</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Adresse de Résidence</label>
                                <input type="text" id="primary-student-address" class="form-control" required>
                            </div>
                            
                            <!-- Pas de numéro de téléphone pour les élèves primaires -->
                            
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Classe</label>
                                    <select id="primary-student-class" class="form-control" required></select>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Frais d'inscription ($)</label>
                                    <div class="currency-input-group">
                                        <span class="currency-symbol">$</span>
                                        <input type="number" id="primary-student-fees" class="form-control currency-input" step="0.01" min="0" required value="0">
                                    </div>
                                </div>
                            </div>

                            <hr style="margin: 2rem 0;">
                            <h4>Informations du Parent</h4>
                            <div class="form-group">
                                <label>Nom du Parent</label>
                                    <input type="text" id="primary-parent-name" class="form-control" required>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Téléphone Parent</label>
                                    <input type="tel" id="primary-parent-phone" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label>Adresse Parent</label>
                                    <input type="text" id="primary-parent-address" class="form-control" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <button type="submit" class="btn btn-primary" style="margin-top: 1rem; margin-right: 1rem;" id="primary-student-submit-btn">
                                    Inscrire l'Élève Primaire
                                </button>
                                <button type="button" class="btn btn-success" style="margin-top: 1rem;" id="print-primary-student-btn" onclick="printEnrollmentForm('primary')">
                                    <i class="fas fa-print"></i> Imprimer Bordereau
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Page: Inscrire Élève Maternelle -->
                <div id="enroll-kindergarten-student-page" class="page">
                    <div class="card">
                        <form id="kindergarten-student-form">
                            <h4>Informations de l'élève (Maternelle)</h4>
                            
                            <!-- Photo de profil -->
                            <div class="photo-upload">
                                <div class="photo-placeholder" id="kindergarten-student-photo-preview">
                                    <i class="fas fa-camera"></i>
                                </div>
                                <input type="file" id="kindergarten-student-photo" class="file-input" accept="image/*">
                                <button type="button" class="upload-btn" onclick="document.getElementById('kindergarten-student-photo').click()">
                                    <i class="fas fa-upload"></i> Choisir une photo
                                </button>
                            </div>

                            <div class="form-row">
                                <div class="form-group" style="flex: 2;">
                                    <label>Nom Complet</label>
                                    <input type="text" id="kindergarten-student-name" class="form-control" required>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Date de Naissance</label>
                                    <input type="date" id="kindergarten-student-birthdate" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Lieu de Naissance</label>
                                    <input type="text" id="kindergarten-student-birthplace" class="form-control" required>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Sexe</label>
                                    <select id="kindergarten-student-gender" class="form-control" required>
                                        <option value="">Sélectionner</option>
                                        <option value="M">Masculin</option>
                                        <option value="F">Féminin</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Adresse de Résidence</label>
                                <input type="text" id="kindergarten-student-address" class="form-control" required>
                            </div>
                            
                            <!-- Pas de numéro de téléphone pour les élèves maternelles -->
                            
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Classe</label>
                                    <select id="kindergarten-student-class" class="form-control" required></select>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Frais d'inscription ($)</label>
                                    <div class="currency-input-group">
                                        <span class="currency-symbol">$</span>
                                        <input type="number" id="kindergarten-student-fees" class="form-control currency-input" step="0.01" min="0" required value="0">
                                    </div>
                                </div>
                            </div>

                            <hr style="margin: 2rem 0;">
                            <h4>Informations du Parent</h4>
                            <div class="form-group">
                                <label>Nom du Parent</label>
                                <input type="text" id="kindergarten-parent-name" class="form-control" required>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Téléphone Parent</label>
                                    <input type="tel" id="kindergarten-parent-phone" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label>Adresse Parent</label>
                                    <input type="text" id="kindergarten-parent-address" class="form-control" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <button type="submit" class="btn btn-primary" style="margin-top: 1rem; margin-right: 1rem;" id="kindergarten-student-submit-btn">
                                    Inscrire l'Élève Maternelle
                                </button>
                                <button type="button" class="btn btn-success" style="margin-top: 1rem;" id="print-kindergarten-student-btn" onclick="printEnrollmentForm('kindergarten')">
                                    <i class="fas fa-print"></i> Imprimer Bordereau
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Page: Inscrire Enseignant Secondaire -->
                <div id="enroll-teacher-page" class="page">
                    <div class="card">
                        <form id="teacher-form">
                            <h4>Informations de l'enseignant (Secondaire)</h4>
                            
                            <!-- Photo de profil -->
                            <div class="photo-upload">
                                <div class="photo-placeholder" id="teacher-photo-preview">
                                    <i class="fas fa-camera"></i>
                                </div>
                                <input type="file" id="teacher-photo" class="file-input" accept="image/*">
                                <button type="button" class="upload-btn" onclick="document.getElementById('teacher-photo').click()">
                                    <i class="fas fa-upload"></i> Choisir une photo
                                </button>
                            </div>

                            <div class="form-group">
                                <label>Nom Complet</label>
                                <input type="text" id="teacher-name" class="form-control" required>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Date de Naissance</label>
                                    <input type="date" id="teacher-birthdate" class="form-control" required>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Lieu de Naissance</label>
                                    <input type="text" id="teacher-birthplace" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Sexe</label>
                                    <select id="teacher-gender" class="form-control" required>
                                        <option value="">Sélectionner</option>
                                        <option value="M">Masculin</option>
                                        <option value="F">Féminin</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Numéro de Téléphone</label>
                                    <input type="tel" id="teacher-phone" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Adresse de Résidence</label>
                                <input type="text" id="teacher-address" class="form-control" required>
                            </div>
                            
                            <div class="form-group">
                                <label>Matières (séparées par une virgule)</label>
                                <input type="text" id="teacher-subjects" class="form-control" placeholder="Ex: Mathématiques, Physique" required>
                            </div>
                            
                            <div class="form-group">
                                <label>Classes à gérer</label>
                                <div id="teacher-classes-container" class="teacher-classes">
                                    <!-- Les classes seront chargées dynamiquement -->
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary" style="margin-top: 1rem;" id="teacher-submit-btn">
                                Inscrire l'Enseignant
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Page: Inscrire Enseignant Primaire -->
                <div id="enroll-primary-teacher-page" class="page">
                    <div class="card">
                        <form id="primary-teacher-form">
                            <h4>Informations de l'enseignant (Primaire)</h4>
                            
                            <!-- Photo de profil -->
                            <div class="photo-upload">
                                <div class="photo-placeholder" id="primary-teacher-photo-preview">
                                    <i class="fas fa-camera"></i>
                                </div>
                                <input type="file" id="primary-teacher-photo" class="file-input" accept="image/*">
                                <button type="button" class="upload-btn" onclick="document.getElementById('primary-teacher-photo').click()">
                                    <i class="fas fa-upload"></i> Choisir une photo
                                </button>
                            </div>

                            <div class="form-group">
                                <label>Nom Complet</label>
                                <input type="text" id="primary-teacher-name" class="form-control" required>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Date de Naissance</label>
                                    <input type="date" id="primary-teacher-birthdate" class="form-control" required>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Lieu de Naissance</label>
                                    <input type="text" id="primary-teacher-birthplace" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Sexe</label>
                                    <select id="primary-teacher-gender" class="form-control" required>
                                        <option value="">Sélectionner</option>
                                        <option value="M">Masculin</option>
                                        <option value="F">Féminin</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Numéro de Téléphone</label>
                                    <input type="tel" id="primary-teacher-phone" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Adresse de Résidence</label>
                                <input type="text" id="primary-teacher-address" class="form-control" required>
                            </div>
                            
                            <!-- Pas de champ matières pour les enseignants primaires -->
                            
                            <div class="form-group">
                                <label>Classes à gérer</label>
                                <div id="primary-teacher-classes-container" class="teacher-classes">
                                    <!-- Les classes primaires seront chargées dynamiquement -->
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary" style="margin-top: 1rem;" id="primary-teacher-submit-btn">
                                Inscrire l'Enseignant Primaire
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Page: Inscrire Enseignant Maternelle -->
                <div id="enroll-kindergarten-teacher-page" class="page">
                    <div class="card">
                        <form id="kindergarten-teacher-form">
                            <h4>Informations de l'enseignant (Maternelle)</h4>
                            
                            <!-- Photo de profil -->
                            <div class="photo-upload">
                                <div class="photo-placeholder" id="kindergarten-teacher-photo-preview">
                                    <i class="fas fa-camera"></i>
                                </div>
                                <input type="file" id="kindergarten-teacher-photo" class="file-input" accept="image/*">
                                <button type="button" class="upload-btn" onclick="document.getElementById('kindergarten-teacher-photo').click()">
                                    <i class="fas fa-upload"></i> Choisir une photo
                                </button>
                            </div>

                            <div class="form-group">
                                <label>Nom Complet</label>
                                <input type="text" id="kindergarten-teacher-name" class="form-control" required>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Date de Naissance</label>
                                    <input type="date" id="kindergarten-teacher-birthdate" class="form-control" required>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Lieu de Naissance</label>
                                    <input type="text" id="kindergarten-teacher-birthplace" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Sexe</label>
                                    <select id="kindergarten-teacher-gender" class="form-control" required>
                                        <option value="">Sélectionner</option>
                                        <option value="M">Masculin</option>
                                        <option value="F">Féminin</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Numéro de Téléphone</label>
                                    <input type="tel" id="kindergarten-teacher-phone" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Adresse de Résidence</label>
                                <input type="text" id="kindergarten-teacher-address" class="form-control" required>
                            </div>
                            
                            <!-- Pas de champ matières pour les enseignants maternelles -->
                            
                            <div class="form-group">
                                <label>Classes à gérer</label>
                                <div id="kindergarten-teacher-classes-container" class="teacher-classes">
                                    <!-- Les classes maternelles seront chargées dynamiquement -->
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary" style="margin-top: 1rem;" id="kindergarten-teacher-submit-btn">
                                Inscrire l'Enseignant Maternelle
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Page: Gérer Classes Secondaires -->
                <div id="manage-classes-page" class="page">
                    <div class="card">
                        <h4>Ajouter une nouvelle classe (Secondaire)</h4>
                        <form id="class-form" class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label>Nom de la classe</label>
                                <input type="text" id="class-name" class="form-control" placeholder="Ex: 7ème A Scientifique" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label>Niveau</label>
                                <input type="text" id="class-level" class="form-control" placeholder="Ex: 7ème" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label>Capacité</label>
                                <input type="number" id="class-capacity" class="form-control" placeholder="30" required>
                            </div>
                            <button type="submit" class="btn btn-primary" style="align-self: flex-end;">Ajouter</button>
                        </form>
                    </div>
                    <div class="card">
                        <h4>Classes existantes (Secondaire)</h4>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nom</th>
                                        <th>Niveau</th>
                                        <th>Capacité</th>
                                        <th>Élèves inscrits</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="classes-list"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Page: Gérer Classes Primaires -->
                <div id="manage-primary-classes-page" class="page">
                    <div class="card">
                        <h4>Ajouter une nouvelle classe (Primaire)</h4>
                        <form id="primary-class-form" class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label>Nom de la classe</label>
                                <input type="text" id="primary-class-name" class="form-control" placeholder="Ex: CP1" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label>Niveau</label>
                                <input type="text" id="primary-class-level" class="form-control" placeholder="Ex: CP" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label>Capacité</label>
                                <input type="number" id="primary-class-capacity" class="form-control" placeholder="30" required>
                            </div>
                            <button type="submit" class="btn btn-primary" style="align-self: flex-end;">Ajouter</button>
                        </form>
                    </div>
                    <div class="card">
                        <h4>Classes existantes (Primaire)</h4>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nom</th>
                                        <th>Niveau</th>
                                        <th>Capacité</th>
                                        <th>Élèves inscrits</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="primary-classes-list"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Page: Gérer Classes Maternelles -->
                <div id="manage-kindergarten-classes-page" class="page">
                    <div class="card">
                        <h4>Ajouter une nouvelle classe (Maternelle)</h4>
                        <form id="kindergarten-class-form" class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label>Nom de la classe</label>
                                <input type="text" id="kindergarten-class-name" class="form-control" placeholder="Ex: Petite Section" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label>Niveau</label>
                                <input type="text" id="kindergarten-class-level" class="form-control" placeholder="Ex: PS" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label>Capacité</label>
                                <input type="number" id="kindergarten-class-capacity" class="form-control" placeholder="25" required>
                            </div>
                            <button type="submit" class="btn btn-primary" style="align-self: flex-end;">Ajouter</button>
                        </form>
                    </div>
                    <div class="card">
                        <h4>Classes existantes (Maternelle)</h4>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nom</th>
                                        <th>Niveau</th>
                                        <th>Capacité</th>
                                        <th>Élèves inscrits</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="kindergarten-classes-list"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

              <!-- Page: Valider Paiement (VERSION MODIFIÉE) -->
<div id="validate-payment-page" class="page">
    <div class="card">
        <h4>Valider un paiement par code</h4>
        <div class="form-group">
            <label>Entrer le code de paiement</label>
            <input type="text" id="payment-code-input" class="form-control" placeholder="PAY-XXXXXX">
        </div>
        <button id="find-payment-btn" class="btn btn-primary">Rechercher</button>
    </div>
    
    <div id="payment-details-card" class="card hidden">
        <h4>Détails de la transaction</h4>
        <div id="edit-payment-form">
            <div class="form-row">
                <div class="form-group" style="flex: 2;">
                    <label>Nom de l'élève</label>
                    <input type="text" id="edit-payment-student-name" class="form-control" required>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Classe</label>
                    <input type="text" id="edit-payment-student-class" class="form-control" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group" style="flex: 1;">
                    <label>Type d'élève</label>
                    <select id="edit-payment-student-type" class="form-control" required>
                        <option value="secondary">Secondaire</option>
                        <option value="primary">Primaire</option>
                        <option value="kindergarten">Maternelle</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 2;">
                    <label>Mois (séparés par des virgules)</label>
                    <input type="text" id="edit-payment-months" class="form-control" placeholder="janvier, février, mars" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group" style="flex: 1;">
                    <label>Type de frais</label>
                    <select id="edit-payment-type" class="form-control" required>
                        <option value="Frais scolaires">Frais scolaires</option>
                        <option value="Frais de l'état">Frais de l'état</option>
                        <option value="visite">visite</option>
                        <option value="achat pull">achat pull</option>
                        <option value="Autres">Autres</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Montant total ($)</label>
                    <div class="currency-input-group">
                        <span class="currency-symbol">$</span>
                        <input type="number" id="edit-payment-amount" class="form-control currency-input" step="0.01" min="0" required>
                    </div>
                </div>
            </div>
            
            <input type="hidden" id="edit-payment-code">
            
            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <button id="update-payment-btn" class="btn btn-success" style="flex: 1;">
                    <i class="fas fa-check-circle"></i> Valider le Paiement
                </button>
                <button id="cancel-edit-payment-btn" class="btn btn-secondary" style="flex: 1;">
                    <i class="fas fa-times"></i> Annuler
                </button>
            </div>
        </div>
    </div>
    
    <!-- Supprimer la section des paiements en attente -->
    <!-- La section des paiements sur place reste inchangée -->
    <div class="card">
        <h4>Paiements sur place</h4>
        <form id="onsite-payment-form">
            <!-- ... reste du formulaire inchangé ... -->
        </form>
    </div>
</div>
                    <div class="card">
                        <h4>Paiements sur place</h4>
                        <form id="onsite-payment-form">
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Matricule de l'élève</label>
                                    <input type="text" id="onsite-student-id" class="form-control" placeholder="Ex: 2023SC001" required>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Type d'élève</label>
                                    <select id="onsite-student-type" class="form-control" required>
                                        <option value="secondary">Secondaire</option>
                                        <option value="primary">Primaire</option>
                                        <option value="kindergarten">Maternelle</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Classe</label>
                                    <input type="text" id="onsite-student-class" class="form-control" readonly>
                                </div>
                                <div class="form-group" style="flex: 2;">
                                    <label>Nom complet de l'élève</label>
                                    <input type="text" id="onsite-student-name" class="form-control" readonly>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Type de frais</label>
                                    <select id="onsite-payment-type" class="form-control" required>
                                        <option value="">Sélectionner</option>
                                        <option value="Frais scolaires">Frais scolaires</option>
                                        <option value="Frais de l'état">Frais de l'état</option>
                                        <option value="visite">visite</option>


                                        <option value="achat pull">achat pull</option>
                                        <option value="Autres">Autres (veuillez spécifier)</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Spécification (si autres)</label>
                                    <input type="text" id="onsite-payment-other" class="form-control" placeholder="Spécifiez le type de frais">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Mois de paiement</label>
                                    <div class="months-container" id="onsite-months-container">
                                        <!-- Les mois seront générés dynamiquement -->
                                    </div>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Montant par mois ($)</label>
                                    <div class="currency-input-group">
                                        <span class="currency-symbol">$</span>
                                        <input type="number" id="onsite-monthly-amount" class="form-control currency-input" step="0.01" min="0" required placeholder="Montant par mois">
                                    </div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Montant Total ($)</label>
                                    <div class="currency-input-group">
                                        <span class="currency-symbol">$</span>
                                        <input type="number" id="onsite-amount" class="form-control currency-input" step="0.01" min="0" required readonly>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">Valider le paiement</button>
                        </form>
                    </div>
                </div>

                <!-- Page: Gestion des Frais (CORRIGÉE) -->
                <div id="manage-fees-page" class="page">
                    <div class="card">
                        <h4>Gestion des frais scolaires</h4>
                       <!-- Remplacer la section existante des filtres de frais par ceci : -->
<div class="fees-controls">
    <select id="fees-student-type" class="form-control">
        <option value="all">Tous les élèves</option>
        <option value="secondary">Élèves Secondaires</option>
        <option value="primary">Élèves Primaires</option>
        <option value="kindergarten">Élèves Maternelles</option>
    </select>
    <select id="fees-class" class="form-control">
        <option value="">Toutes les classes</option>
    </select>
    <select id="fees-month" class="form-control">
        <option value="all">Tous les mois</option>
        <option value="janvier">Janvier</option>
        <option value="février">Février</option>
        <option value="mars">Mars</option>
        <option value="avril">Avril</option>
        <option value="mai">Mai</option>
        <option value="juin">Juin</option>
        <option value="juillet">Juillet</option>
        <option value="août">Août</option>
        <option value="septembre">Septembre</option>
        <option value="octobre">Octobre</option>
        <option value="novembre">Novembre</option>
        <option value="décembre">Décembre</option>
        <!-- Ajout du filtre pour l'inscription -->
        <option value="inscription">Frais d'inscription</option>
    </select>
    <select id="fees-type" class="form-control">
        <option value="all">Tous les types</option>
        <option value="Frais scolaires">Frais scolaires</option>
        <option value="Frais de l'état">Frais de l'état</option>
        <option value="visite">visite</option>
        <option value="achat pull">achat pull</option>
        <option value="Frais d'inscription">Frais d'inscription</option>
        <option value="Autres">Autres</option>
    </select>
    <button id="load-fees-btn" class="btn btn-primary">Afficher</button>
</div>
                        
                        <div class="fees-summary">
                            <div class="fees-summary-card">
                                <h4>Total élèves</h4>
                                <p id="total-students-fees">0</p>
                            </div>
                            <div class="fees-summary-card">
                                <h4>Élèves en ordre</h4>
                                <p id="paid-students">0</p>
                            </div>
                            <div class="fees-summary-card">
                                <h4>Élèves non payés</h4>
                                <p id="unpaid-students">0</p>
                            </div>
                            <div class="fees-summary-card">
                                <h4>Taux de paiement</h4>
                                <p id="payment-rate">0%</p>
                            </div>
                        </div>
                        
                        <div class="tabs">
                            <div class="tab active" data-tab="unpaid">Élèves non payés</div>
                            <div class="tab" data-tab="paid">Élèves en ordre</div>
                            <div class="tab" data-tab="all">Tous les élèves</div>
                        </div>
                        
                        <div class="search-box">
                            <input type="text" id="fees-search" class="form-control" placeholder="Rechercher par matricule ou nom...">
                        </div>
                        
                        <div class="tab-content active" id="unpaid-tab">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Matricule</th>
                                            <th>Nom</th>
                                            <th>Type</th>
                                            <th>Classe</th>
                                            <th>Type de frais</th>
                                            <th>Montant payé</th>
                                            <th>Mois impayés</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="unpaid-students-list"></tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="tab-content" id="paid-tab">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Matricule</th>
                                            <th>Nom</th>
                                            <th>Type</th>
                                            <th>Classe</th>
                                            <th>Type de frais</th>
                                            <th>Montant payé</th>
                                            <th>Dernier paiement</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="paid-students-list"></tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="tab-content" id="all-tab">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Matricule</th>
                                            <th>Nom</th>
                                            <th>Type</th>
                                            <th>Classe</th>
                                            <th>Type de frais</th>
                                            <th>Montant payé</th>
                                            <th>Statut paiement</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="all-students-list"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page: Statistiques Élèves (MODIFIÉE) -->
                <div id="students-list-page" class="page">
                    <div class="card">
                        <div class="form-row" style="justify-content: space-between; align-items: center;">
                            <h4>Statistiques par Classe</h4>
                            <button id="export-students-excel-btn" class="btn btn-success">
                                <i class="fas fa-file-excel"></i> Excel
                            </button>
                        </div>
                        
                        <!-- Recherche pour modification -->
                        <div class="search-modify-container">
                            <h5>Rechercher et Modifier un Élève</h5>
                            <div class="form-row">
                                <div class="form-group" style="flex: 2;">
                                    <label>Rechercher par matricule ou nom</label>
                                    <input type="text" id="search-student-modify" class="form-control" placeholder="Entrez le matricule ou le nom de l'élève">
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Type d'élève</label>
                                    <select id="search-student-type" class="form-control">
                                        <option value="all">Tous types</option>
                                        <option value="secondary">Secondaire</option>
                                        <option value="primary">Primaire</option>
                                        <option value="kindergarten">Maternelle</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex: 1; align-self: flex-end;">
                                    <button id="search-student-btn" class="btn btn-primary" style="width: 100%;">Rechercher</button>
                                </div>
                            </div>
                            <div id="student-search-results" style="margin-top: 1rem;"></div>
                        </div>
                        
                        <!-- Statistiques par classe -->
                        <div class="class-stats-container" id="class-stats-container">
                            <!-- Les statistiques par classe seront générées ici -->
                        </div>
                        
                        <div class="card">
                            <h5>Exporter les données</h5>
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Type d'export</label>
                                    <select id="export-type" class="form-control">
                                        <option value="excel">Excel (.xlsx)</option>
                                        <option value="csv">CSV (.csv)</option>
                                        <option value="pdf">PDF (.pdf)</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Type d'élève</label>
                                    <select id="export-student-type" class="form-control">
                                        <option value="all">Tous les élèves</option>
                                        <option value="secondary">Élèves Secondaires</option>
                                        <option value="primary">Élèves Primaires</option>
                                        <option value="kindergarten">Élèves Maternelles</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Classe</label>
                                    <select id="export-class" class="form-control">
                                        <option value="">Toutes les classes</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex: 1; align-self: flex-end;">
                                    <button id="export-data-btn" class="btn btn-primary" style="width: 100%;">
                                        <i class="fas fa-download"></i> Exporter
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page: Statistiques Enseignants (MODIFIÉE) -->
                <div id="teachers-list-page" class="page">
                    <div class="card">
                        <div class="form-row" style="justify-content: space-between; align-items: center;">
                            <h4>Statistiques par Classe</h4>
                            <button id="export-teachers-excel-btn" class="btn btn-success">
                                <i class="fas fa-file-excel"></i> Excel
                            </button>
                        </div>
                        
                        <!-- Recherche pour modification -->
                        <div class="search-modify-container">
                            <h5>Rechercher et Modifier un Enseignant</h5>
                            <div class="form-row">
                                <div class="form-group" style="flex: 2;">
                                    <label>Rechercher par matricule ou nom</label>
                                    <input type="text" id="search-teacher-modify" class="form-control" placeholder="Entrez le matricule ou le nom de l'enseignant">
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Type d'enseignant</label>
                                    <select id="search-teacher-type" class="form-control">
                                        <option value="all">Tous types</option>
                                        <option value="secondary">Secondaire</option>
                                        <option value="primary">Primaire</option>
                                        <option value="kindergarten">Maternelle</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex: 1; align-self: flex-end;">
                                    <button id="search-teacher-btn" class="btn btn-primary" style="width: 100%;">Rechercher</button>
                                </div>
                            </div>
                            <div id="teacher-search-results" style="margin-top: 1rem;"></div>
                        </div>
                        
                        <!-- Statistiques par classe -->
                        <div class="class-stats-container" id="teacher-class-stats-container">
                            <!-- Les statistiques par classe seront générées ici -->
                        </div>
                        
                        <div class="card">
                            <h5>Exporter les données</h5>
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Type d'export</label>
                                    <select id="export-teacher-type" class="form-control">
                                        <option value="excel">Excel (.xlsx)</option>
                                        <option value="csv">CSV (.csv)</option>
                                        <option value="pdf">PDF (.pdf)</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Type d'enseignant</label>
                                    <select id="export-teacher-category" class="form-control">
                                        <option value="all">Tous les enseignants</option>
                                        <option value="secondary">Enseignants Secondaires</option>
                                        <option value="primary">Enseignants Primaires</option>
                                        <option value="kindergarten">Enseignants Maternelles</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex: 1; align-self: flex-end;">
                                    <button id="export-teacher-data-btn" class="btn btn-primary" style="width: 100%;">
                                        <i class="fas fa-download"></i> Exporter
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page: Rapports Administratifs (CORRIGÉE) -->
                <div id="admin-reports-page" class="page">
                    <div class="card">
                        <h4>Rapports Administratifs</h4>
                        <div class="admin-controls">
                            <select id="report-type" class="form-control">
                                <option value="daily">Rapport Journalier</option>
                                <option value="monthly">Rapport Mensuel</option>
                                <option value="yearly">Rapport Annuel</option>
                                <option value="fees">Rapport par Type de Frais</option>
                                <option value="enrollment">Rapport des Inscriptions</option>
                                <option value="payments-class">Rapport Paiements par Classe</option>
                            </select>
                            
                            <!-- Contrôles spécifiques au type de rapport -->
                            <div id="daily-controls" class="report-controls">
                                <input type="date" id="report-date" class="form-control">
                            </div>
                            
                            <div id="monthly-controls" class="report-controls hidden">
                                <select id="report-month" class="form-control">
                                    <option value="janvier">Janvier</option>
                                    <option value="février">Février</option>
                                    <option value="mars">Mars</option>
                                    <option value="avril">Avril</option>
                                    <option value="mai">Mai</option>
                                    <option value="juin">Juin</option>
                                    <option value="juillet">Juillet</option>
                                    <option value="août">Août</option>
                                    <option value="septembre">Septembre</option>
                                    <option value="octobre">Octobre</option>
                                    <option value="novembre">Novembre</option>
                                    <option value="décembre">Décembre</option>
                                </select>
                            </div>
                            
                            <div id="yearly-controls" class="report-controls hidden">
                                <select id="report-year" class="form-control">
                                    <option value="2023">2023</option>
                                    <option value="2024">2024</option>
                                    <option value="2025">2025</option>
                                </select>
                            </div>
                            
                            <div id="class-controls" class="report-controls hidden">
                                <select id="report-class" class="form-control">
                                    <option value="">Toutes les classes</option>
                                </select>
                            </div>
                            
                            <div id="fees-type-controls" class="report-controls hidden">
                                <select id="report-fees-type" class="form-control">
                                    <option value="all">Tous les frais</option>
                                    <option value="Frais scolaires">Frais scolaires</option>
                                    <option value="Frais de l'état">Frais de l'état</option>
                                    <option value="visite">visite</option>
                                    <option value="achat pull">achat pull</option>
                                    <option value="Autres">Autres</option>
                                </select>
                            </div>
                            
                            <button id="generate-report-btn" class="btn btn-primary">Générer Rapport</button>
                            <button id="export-report-btn" class="btn btn-success">Exporter PDF</button>
                            <button id="back-report-btn" class="btn btn-secondary" style="display: none;">
                                <i class="fas fa-arrow-left"></i> Retour
                            </button>
                        </div>
                        
                        <div id="report-content" class="hidden">
                            <div class="report-card">
                                <div class="report-header">
                                    <h3 id="report-title">Rapport des Paiements</h3>
                                    <span id="report-period"></span>
                                </div>
                                
                                <!-- Résumé général -->
                                <div id="general-summary" class="report-summary">
                                    <div class="fees-summary-card">
                                        <h4>Total Paiements</h4>
                                        <p id="total-payments">0</p>
                                    </div>
                                    <div class="fees-summary-card">
                                        <h4>Montant Total</h4>
                                        <p id="total-amount" class="currency-display">$0.00</p>
                                    </div>
                                    <div class="fees-summary-card">
                                        <h4>Paiements en ligne</h4>
                                        <p id="online-payments">0</p>
                                    </div>
                                    <div class="fees-summary-card">
                                        <h4>Paiements sur place</h4>
                                        <p id="onsite-payments">0</p>
                                    </div>
                                </div>
                                
                                <!-- Section spécifique pour le rapport par classe -->
                                <div id="class-payments-section" class="hidden">
                                    <div class="report-summary">
                                        <div class="fees-summary-card">
                                            <h4>Élèves en ordre</h4>
                                            <p id="class-paid-students">0</p>
                                        </div>
                                        <div class="fees-summary-card">
                                            <h4>Élèves non payés</h4>
                                            <p id="class-unpaid-students">0</p>
                                        </div>
                                        <div class="fees-summary-card">
                                            <h4>Taux de paiement</h4>
                                            <p id="class-payment-rate">0%</p>
                                        </div>
                                        <div class="fees-summary-card">
                                            <h4>Montant par élève</h4>
                                            <p id="class-per-student" class="currency-display">$0.00</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Section pour le rapport des inscriptions -->
                                <div id="enrollment-report-section" class="hidden">
                                    <div class="report-summary">
                                        <div class="fees-summary-card">
                                            <h4>Total inscriptions</h4>
                                            <p id="total-enrollments">0</p>
                                        </div>
                                        <div class="fees-summary-card">
                                            <h4>Secondaire</h4>
                                            <p id="secondary-enrollments">0</p>
                                        </div>
                                        <div class="fees-summary-card">
                                            <h4>Primaire</h4>
                                            <p id="primary-enrollments">0</p>
                                        </div>
                                        <div class="fees-summary-card">
                                            <h4>Maternelle</h4>
                                            <p id="kindergarten-enrollments">0</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Section des statistiques par type de frais -->
                                <div id="fees-breakdown-section" class="hidden">
                                    <h4 style="margin-top: 2rem;">Détail par Type de Frais</h4>
                                    <div class="table-container">
                                        <table>
                                            <thead>
                                                <tr>
                                                    <th>Type de Frais</th>
                                                    <th>Nombre de Paiements</th>
                                                    <th>Montant Total</th>
                                                    <th>Pourcentage</th>
                                                </tr>
                                            </thead>
                                            <tbody id="fees-breakdown-table"></tbody>
                                            <tfoot>
                                                <tr>
                                                    <td><strong>TOTAL GÉNÉRAL</strong></td>
                                                    <td id="total-payments-breakdown">0</td>
                                                    <td id="total-amount-breakdown" class="currency-display">$0.00</td>
                                                    <td>100%</td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                                
                                <!-- Tableau principal des rapports -->
                                <div class="table-container">
                                    <table id="report-table">
                                        <thead id="report-table-head">
                                            <!-- En-têtes générés dynamiquement -->
                                        </thead>
                                        <tbody id="report-table-body"></tbody>
                                        <tfoot id="report-table-footer">
                                            <!-- Pied de tableau généré dynamiquement -->
                                        </tfoot>
                                    </table>
                                </div>
                                <div class="signature-area">
                                    <div class="signature-box">
                                        <p>Le Secrétaire</p>
                                        <div class="signature-line"></div>
                                    </div>
                                    <div class="signature-box">
                                        <p>Le Directeur</p>
                                        <div class="signature-line"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page: Profil -->
                <div id="profile-page" class="page">
                    <div class="card">
                        <h4>Mon Profil</h4>
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <div class="photo-upload">
                                    <div class="photo-placeholder" id="profile-photo-preview">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <input type="file" id="profile-photo" class="file-input" accept="image/*">
                                    <button type="button" class="upload-btn" onclick="document.getElementById('profile-photo').click()">
                                        <i class="fas fa-upload"></i> Changer la photo
                                    </button>
                                </div>
                            </div>
                            <div class="form-group" style="flex: 2;">
                                <div class="form-row">
                                    <div class="form-group" style="flex: 1;">
                                        <label>Nom Complet</label>
                                        <input type="text" id="profile-name" class="form-control" readonly>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label>Email</label>
                                        <input type="email" id="profile-email" class="form-control" readonly>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group" style="flex: 1;">
                                        <label>Téléphone</label>
                                        <input type="tel" id="profile-phone" class="form-control">
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label>Date d'inscription</label>
                                        <input type="text" id="profile-created" class="form-control" readonly>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Adresse</label>
                                    <input type="text" id="profile-address" class="form-control">
                                </div>
                                <button id="update-profile-btn" class="btn btn-primary">Mettre à jour le profil</button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <div id="student-details-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Détails de l'élève</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div id="student-details-content">
                <!-- Contenu généré dynamiquement -->
            </div>
        </div>
    </div>

    <div id="teacher-details-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Détails de l'enseignant</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div id="teacher-details-content">
                <!-- Contenu généré dynamiquement -->
            </div>
        </div>
    </div>

    <div id="edit-student-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Modifier l'élève</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="edit-student-form">
                <input type="hidden" id="edit-student-id">
                <input type="hidden" id="edit-student-collection">
                <div class="form-group">
                    <label>Nom Complet</label>
                    <input type="text" id="edit-student-name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Date de Naissance</label>
                    <input type="date" id="edit-student-birthdate" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Lieu de Naissance</label>
                    <input type="text" id="edit-student-birthplace" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Sexe</label>
                    <select id="edit-student-gender" class="form-control" required>
                        <option value="">Sélectionner</option>
                        <option value="M">Masculin</option>
                        <option value="F">Féminin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Adresse de Résidence</label>
                    <input type="text" id="edit-student-address" class="form-control" required>
                </div>
                <div class="form-group" id="edit-student-phone-container">
                    <label>Numéro de Téléphone</label>
                    <input type="tel" id="edit-student-phone" class="form-control">
                </div>
                <div class="form-group">
                    <label>Classe</label>
                    <select id="edit-student-class" class="form-control" required></select>
                </div>
                <div class="form-group">
                    <label>Frais d'inscription ($)</label>
                    <div class="currency-input-group">
                        <span class="currency-symbol">$</span>
                        <input type="number" id="edit-student-fees" class="form-control currency-input" step="0.01" min="0" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Nom du Parent</label>
                    <input type="text" id="edit-parent-name" class="form-control" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Téléphone Parent</label>
                        <input type="tel" id="edit-parent-phone" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Adresse Parent</label>
                        <input type="text" id="edit-parent-address" class="form-control" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Statut</label>
                    <select id="edit-student-status" class="form-control" required>
                        <option value="active">Actif</option>
                        <option value="inactive">Inactif</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Enregistrer les modifications</button>
            </form>
        </div>
    </div>

    <div id="edit-teacher-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Modifier l'enseignant</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="edit-teacher-form">
                <input type="hidden" id="edit-teacher-id">
                <input type="hidden" id="edit-teacher-collection">
                <div class="form-group">
                    <label>Nom Complet</label>
                    <input type="text" id="edit-teacher-name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Date de Naissance</label>
                    <input type="date" id="edit-teacher-birthdate" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Lieu de Naissance</label>
                    <input type="text" id="edit-teacher-birthplace" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Sexe</label>
                    <select id="edit-teacher-gender" class="form-control" required>
                        <option value="">Sélectionner</option>
                        <option value="M">Masculin</option>
                        <option value="F">Féminin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Adresse de Résidence</label>
                    <input type="text" id="edit-teacher-address" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Numéro de Téléphone</label>
                    <input type="tel" id="edit-teacher-phone" class="form-control" required>
                </div>
                <div class="form-group" id="edit-teacher-subjects-container">
                    <label>Matières (séparées par une virgule)</label>
                    <input type="text" id="edit-teacher-subjects" class="form-control" placeholder="Ex: Mathématiques, Physique">
                </div>
                <div class="form-group">
                    <label>Classes à gérer</label>
                    <div id="edit-teacher-classes-container" class="teacher-classes">
                        <!-- Les classes seront chargées dynamiquement -->
                    </div>
                </div>
                <div class="form-group">
                    <label>Statut</label>
                    <select id="edit-teacher-status" class="form-control" required>
                        <option value="active">Actif</option>
                        <option value="inactive">Inactif</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Enregistrer les modifications</button>
            </form>
        </div>
    </div>

    <div id="receipt-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>Reçu de paiement</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div id="receipt-content">
                <!-- Contenu du reçu généré dynamiquement -->
            </div>
            <div style="text-align: center; margin-top: 1rem;">
                <button id="print-receipt-btn" class="btn btn-primary">Imprimer le reçu</button>
                <button id="back-receipt-btn" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Retour
                </button>
            </div>
        </div>
    </div>

    <!-- Modal pour l'impression du bordereau d'inscription -->
    <div id="enrollment-slip-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Bordereau d'Inscription</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div id="enrollment-slip-content">
                <!-- Contenu du bordereau généré dynamiquement -->
            </div>
            <div style="text-align: center; margin-top: 1rem;">
                <button id="print-enrollment-slip-btn" class="btn btn-primary">
                    <i class="fas fa-print"></i> Imprimer le Bordereau
                </button>
                <button id="back-enrollment-slip-btn" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Retour
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // 1. INITIALISATION DE FIREBASE
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, query, where, addDoc, serverTimestamp, doc, updateDoc, writeBatch, orderBy, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        // CONFIGURATION FIREBASE
        const firebaseConfig = {
          apiKey: "AIzaSyBn7VIddclO7KtrXb5sibCr9SjVLjOy-qI",
          authDomain: "theo1d.firebaseapp.com",
          projectId: "theo1d",
          storageBucket: "theo1d.firebasestorage.app",
          messagingSenderId: "269629842962",
          appId: "1:269629842962:web:a80a12b04448fe1e595acb",
          measurementId: "G-TNSG1XFMDZ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // 2. CONFIGURATION CLOUDINARY
        const CLOUDINARY_CONFIG = {
            cloudName: 'diwn8sxtn',
            uploadPreset: 'cs_lacolombe'
        };

        // 3. FONCTION UPLOAD CLOUDINARY (optimisée)
        async function uploadToCloudinary(file, folder = 'cs-lacolombe') {
            if (!file) return null;
            
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const formData = new FormData();
                        formData.append('file', file);
                        formData.append('upload_preset', CLOUDINARY_CONFIG.uploadPreset);
                        formData.append('folder', folder);
                        
                        const response = await fetch(
                            `https://api.cloudinary.com/v1_1/${CLOUDINARY_CONFIG.cloudName}/image/upload`,
                            { 
                                method: 'POST', 
                                body: formData 
                            }
                        );
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        resolve(data.secure_url);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error('Erreur de lecture du fichier'));
                reader.readAsDataURL(file);
            });
        }

        // 4. LOGIQUE SPÉCIFIQUE À LA PAGE SECRÉTARIAT
        const loginOverlay = document.getElementById('login-overlay');
        const appRoot = document.getElementById('app-root');
        const splashScreen = document.getElementById('splash-screen');
        let currentSecretary = null;

        // Variables pour stocker les photos temporairement
        let studentPhotoFile = null;
        let teacherPhotoFile = null;
        let profilePhotoFile = null;
        let primaryStudentPhotoFile = null;
        let primaryTeacherPhotoFile = null;
        let kindergartenStudentPhotoFile = null;
        let kindergartenTeacherPhotoFile = null;

        // Variables pour la gestion hors ligne
        let isOnline = navigator.onLine;
        let deferredPrompt = null;
        let offlineQueue = [];

        // Dernier élève inscrit (pour l'impression du bordereau)
        let lastEnrolledStudent = null;

        // --- Gestion des photos ---
        document.getElementById('student-photo').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    showAlert("La photo ne doit pas dépasser 5MB", "error");
                    return;
                }
                if (!file.type.startsWith('image/')) {
                    showAlert("Veuillez sélectionner une image valide", "error");
                    return;
                }
                studentPhotoFile = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('student-photo-preview').innerHTML = `<img src="${e.target.result}" class="photo-preview">`;
                }
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('primary-student-photo').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    showAlert("La photo ne doit pas dépasser 5MB", "error");
                    return;
                }
                if (!file.type.startsWith('image/')) {
                    showAlert("Veuillez sélectionner une image valide", "error");
                    return;
                }
                primaryStudentPhotoFile = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('primary-student-photo-preview').innerHTML = `<img src="${e.target.result}" class="photo-preview">`;
                }
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('kindergarten-student-photo').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    showAlert("La photo ne doit pas dépasser 5MB", "error");
                    return;
                }
                if (!file.type.startsWith('image/')) {
                    showAlert("Veuillez sélectionner une image valide", "error");
                    return;
                }
                kindergartenStudentPhotoFile = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('kindergarten-student-photo-preview').innerHTML = `<img src="${e.target.result}" class="photo-preview">`;
                }
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('teacher-photo').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    showAlert("La photo ne doit pas dépasser 5MB", "error");
                    return;
                }
                if (!file.type.startsWith('image/')) {
                    showAlert("Veuillez sélectionner une image valide", "error");
                    return;
                }
                teacherPhotoFile = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('teacher-photo-preview').innerHTML = `<img src="${e.target.result}" class="photo-preview">`;
                }
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('primary-teacher-photo').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    showAlert("La photo ne doit pas dépasser 5MB", "error");
                    return;
                }
                if (!file.type.startsWith('image/')) {
                    showAlert("Veuillez sélectionner une image valide", "error");
                    return;
                }
                primaryTeacherPhotoFile = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('primary-teacher-photo-preview').innerHTML = `<img src="${e.target.result}" class="photo-preview">`;
                }
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('kindergarten-teacher-photo').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    showAlert("La photo ne doit pas dépasser 5MB", "error");
                    return;
                }
                if (!file.type.startsWith('image/')) {
                    showAlert("Veuillez sélectionner une image valide", "error");
                    return;
                }
                kindergartenTeacherPhotoFile = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('kindergarten-teacher-photo-preview').innerHTML = `<img src="${e.target.result}" class="photo-preview">`;
                }
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('profile-photo').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    showAlert("La photo ne doit pas dépasser 5MB", "error");
                    return;
                }
                if (!file.type.startsWith('image/')) {
                    showAlert("Veuillez sélectionner une image valide", "error");
                    return;
                }
                profilePhotoFile = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('profile-photo-preview').innerHTML = `<img src="${e.target.result}" class="photo-preview">`;
                }
                reader.readAsDataURL(file);
            }
        });

        // --- Gestion de l'écran de démarrage ---
        setTimeout(() => {
            splashScreen.classList.add('hidden');
            checkAuthentication();
        }, 2000);

        // --- Authentification renforcée ---
        function checkAuthentication() {
            // Vérifier si l'utilisateur est déjà connecté
            const user = auth.currentUser;
            if (user) {
                // Déconnecter l'utilisateur pour forcer la reconnexion
                signOut(auth).then(() => {
                    loginOverlay.classList.remove('hidden');
                    showLoginAlert("Veuillez vous reconnecter", "info");
                });
            } else {
                loginOverlay.classList.remove('hidden');
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    // Suppression de la vérification de portail - accès direct
                    const q = query(collection(db, 'secretary'), where('uid', '==', user.uid));
                    const snap = await getDocs(q);
                    
                    // Si le secrétaire n'existe pas encore dans Firestore, le créer
                    if (snap.empty) {
                        // Créer un nouveau document secrétaire
                        const secretaryData = {
                            uid: user.uid,
                            fullName: user.email.split('@')[0],
                            email: user.email,
                            createdAt: serverTimestamp(),
                            updatedAt: serverTimestamp()
                        };
                        
                        const newSecretaryRef = await addDoc(collection(db, 'secretary'), secretaryData);
                        currentSecretary = { id: newSecretaryRef.id, ...secretaryData };
                    } else {
                        currentSecretary = { id: snap.docs[0].id, ...snap.docs[0].data() };
                    }
                    
                    loginOverlay.classList.add('hidden');
                    appRoot.classList.remove('hidden');
                    document.getElementById('secretary-name').textContent = currentSecretary.fullName;
                    
                    // Afficher la photo de profil du secrétaire
                    const photoContainer = document.getElementById('secretary-photo-container');
                    if (currentSecretary.photoURL) {
                        photoContainer.innerHTML = `<img src="${currentSecretary.photoURL}" class="secretary-photo" alt="Photo de profil">`;
                    } else {
                        photoContainer.innerHTML = `<div class="secretary-photo-placeholder"><i class="fas fa-user"></i></div>`;
                    }
                    
                    // Charger les données du profil
                    loadProfileData();
                    initializePortal();
                } catch (error) {
                    console.error("Erreur initialisation secrétaire:", error);
                    showLoginAlert("Erreur lors de l'initialisation du compte", "error");
                }
            } else {
                // Toujours afficher l'écran de connexion si pas d'utilisateur
                loginOverlay.classList.remove('hidden');
                appRoot.classList.add('hidden');
            }
        });

        function showLoginAlert(message, type = 'info') {
            const alertBox = document.getElementById('login-alert');
            alertBox.textContent = message;
            alertBox.className = `alert alert-${type}`;
            alertBox.classList.remove('hidden');
            setTimeout(() => alertBox.classList.add('hidden'), 6000);
        }

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Connexion...';
            submitBtn.disabled = true;

            try {
                await signInWithEmailAndPassword(auth, email, password);
                showLoginAlert("Connexion réussie !", "success");
                // La redirection se fera automatiquement via onAuthStateChanged
            } catch (error) {
                console.error("Erreur connexion:", error);
                let errorMessage = "Email ou mot de passe incorrect.";
                if (error.code === 'auth/invalid-email') {
                    errorMessage = "Adresse email invalide.";
                } else if (error.code === 'auth/user-disabled') {
                    errorMessage = "Ce compte a été désactivé.";
                } else if (error.code === 'auth/user-not-found') {
                    errorMessage = "Aucun compte trouvé avec cette adresse email.";
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = "Mot de passe incorrect.";
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = "Erreur de réseau. Vérifiez votre connexion internet.";
                }
                showLoginAlert(errorMessage, "error");
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            signOut(auth);
            showAlert("Déconnexion réussie", "success");
        });

        // --- Gestion PWA ---
        // Événement d'installation
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('install-btn').style.display = 'block';
        });

        document.getElementById('install-btn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    document.getElementById('install-btn').style.display = 'none';
                }
                deferredPrompt = null;
            }
        });

        // Gestion du statut de connexion
        function updateConnectionStatus() {
            const statusElement = document.getElementById('connection-status');
            if (isOnline) {
                statusElement.className = 'connection-status online';
                statusElement.innerHTML = '<span class="status-indicator status-online"></span><span>En ligne</span>';
            } else {
                statusElement.className = 'connection-status offline';
                statusElement.innerHTML = '<span class="status-indicator status-offline"></span><span>Hors ligne</span>';
            }
        }

        window.addEventListener('online', () => {
            isOnline = true;
            updateConnectionStatus();
            showAlert("Connexion rétablie - Synchronisation en cours...", "success");
            syncOfflineData();
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            updateConnectionStatus();
            showAlert("Mode hors ligne activé - Les données seront sauvegardées localement", "warning");
        });

        // Initialiser le statut de connexion
        updateConnectionStatus();

        // Gestion des données hors ligne
        function addToOfflineQueue(action, data) {
            offlineQueue.push({ action, data, timestamp: new Date().getTime() });
            localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
        }

        async function syncOfflineData() {
            if (!isOnline) return;

            const queue = JSON.parse(localStorage.getItem('offlineQueue') || '[]');
            if (queue.length === 0) return;

            showAlert("Synchronisation des données hors ligne...", "info");

            for (const item of queue) {
                try {
                    // Implémenter la logique de synchronisation selon l'action
                    switch (item.action) {
                        case 'addStudent':
                            // Logique pour ajouter l'étudiant
                            break;
                        case 'addTeacher':
                            // Logique pour ajouter l'enseignant
                            break;
                        // Ajouter d'autres actions selon les besoins
                    }
                } catch (error) {
                    console.error("Erreur synchronisation:", error);
                }
            }

            // Vider la file d'attente après synchronisation
            localStorage.removeItem('offlineQueue');
            offlineQueue = [];
            showAlert("Synchronisation terminée", "success");
        }

        // --- Initialisation et Fonctions Utilitaires ---
      function initializePortal() {
    loadClassesIntoSelects();
    loadClassesList();
    loadPrimaryClassesList();
    loadKindergartenClassesList();
    loadDashboardStats();
    loadStudentsList();
    loadTeachersList();
    loadPendingPaymentsList();
    loadTeacherClasses();
    loadPrimaryTeacherClasses();
    loadKindergartenTeacherClasses();
    loadFeesClasses();
    setupPaymentForm();
    setupStatsNavigation();
    setupMenuDropdowns();
    setupReportControls();
    
    // AJOUTEZ CES LIGNES :
    loadAllClassesForReports();
    populateExportClassSelect();
    
    // Charger les données hors ligne si disponibles
    if (localStorage.getItem('offlineQueue')) {
        offlineQueue = JSON.parse(localStorage.getItem('offlineQueue'));
    }
}

        function showAlert(message, type = 'info') {
            const alertBox = document.getElementById('global-alert');
            alertBox.textContent = message;
            alertBox.className = `alert alert-${type}`;
            alertBox.classList.remove('hidden');
            setTimeout(() => alertBox.classList.add('hidden'), 6000);
        }

        function formatDate(date) {
            if (!date) return 'Non définie';
            return date.toLocaleDateString('fr-FR', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function generatePassword() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let password = '';
            for (let i = 0; i < 8; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return password;
        }

        function generatePaymentCode() {
            return 'PAY-' + Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        function generateEnrollmentCode() {
            return 'ENR-' + Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        // --- Gestion des menus déroulants ---
        function setupMenuDropdowns() {
            document.querySelectorAll('.has-submenu > a').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const parent = this.parentElement;
                    parent.classList.toggle('active');
                });
            });
        }

        // --- Navigation des cartes de statistiques ---
        function setupStatsNavigation() {
            document.querySelectorAll('.stat-card').forEach(card => {
                card.addEventListener('click', function() {
                    const targetPage = this.getAttribute('data-target');
                    if (targetPage) {
                        document.querySelectorAll('.nav-menu a, .page').forEach(el => el.classList.remove('active'));
                        document.querySelector(`.nav-menu a[data-page="${targetPage}"]`).classList.add('active');
                        document.getElementById(targetPage + '-page').classList.add('active');
                        document.getElementById('page-title').textContent = document.querySelector(`.nav-menu a[data-page="${targetPage}"]`).textContent;
                    }
                });
            });
        }

        // --- Tableau de Bord ---
        async function loadDashboardStats() {
            try {
                // Compter les élèves secondaires
                const studentsSnap = await getDocs(query(collection(db, 'students'), where('status', '!=', 'deleted')));
                // Compter les élèves primaires
                const primaryStudentsSnap = await getDocs(query(collection(db, 'primary_students'), where('status', '!=', 'deleted')));
                // Compter les élèves maternelles
                const kindergartenStudentsSnap = await getDocs(query(collection(db, 'kindergarten_students'), where('status', '!=', 'deleted')));
                const totalStudents = studentsSnap.size + primaryStudentsSnap.size + kindergartenStudentsSnap.size;
                document.getElementById('total-students').textContent = totalStudents;
                
                // Compter les enseignants secondaires
                const teachersSnap = await getDocs(query(collection(db, 'teachers'), where('status', '!=', 'deleted')));
                // Compter les enseignants primaires
                const primaryTeachersSnap = await getDocs(query(collection(db, 'primary_teachers'), where('status', '!=', 'deleted')));
                // Compter les enseignants maternelles
                const kindergartenTeachersSnap = await getDocs(query(collection(db, 'kindergarten_teachers'), where('status', '!=', 'deleted')));
                const totalTeachers = teachersSnap.size + primaryTeachersSnap.size + kindergartenTeachersSnap.size;
                document.getElementById('total-teachers').textContent = totalTeachers;
                
                // Compter les classes secondaires
                const classesSnap = await getDocs(collection(db, 'classes'));
                // Compter les classes primaires
                const primaryClassesSnap = await getDocs(collection(db, 'primary_classes'));
                // Compter les classes maternelles
                const kindergartenClassesSnap = await getDocs(collection(db, 'kindergarten_classes'));
                const totalClasses = classesSnap.size + primaryClassesSnap.size + kindergartenClassesSnap.size;
                document.getElementById('total-classes').textContent = totalClasses;
                
                // Compter les paiements en attente
                const pendingPaymentsSnap = await getDocs(query(collection(db, 'payment_requests'), where('status', '==', 'pending')));
                document.getElementById('pending-payments').textContent = pendingPaymentsSnap.size;
                
                // Charger les activités récentes
                loadRecentActivities();
            } catch (error) {
                console.error('Erreur chargement stats:', error);
            }
        }

        async function loadRecentActivities() {
            const activitiesEl = document.getElementById('recent-activities');
            activitiesEl.innerHTML = '<p>Chargement...</p>';
            
            try {
                // Récupérer les 10 dernières activités
                const activities = [];
                
                // Récupérer les dernières inscriptions d'élèves secondaires
                const studentsSnap = await getDocs(query(collection(db, 'students'), where('status', '!=', 'deleted'), orderBy('createdAt', 'desc')));
                studentsSnap.forEach(doc => {
                    const data = doc.data();
                    activities.push({
                        type: 'student_enrollment',
                        message: `Nouvel élève secondaire inscrit: ${data.fullName}`,
                        date: data.createdAt?.toDate(),
                        icon: 'fa-user-plus',
                        color: 'success'
                    });
                });
                
                // Récupérer les dernières inscriptions d'élèves primaires
                const primaryStudentsSnap = await getDocs(query(collection(db, 'primary_students'), where('status', '!=', 'deleted'), orderBy('createdAt', 'desc')));
                primaryStudentsSnap.forEach(doc => {
                    const data = doc.data();
                    activities.push({
                        type: 'primary_student_enrollment',
                        message: `Nouvel élève primaire inscrit: ${data.fullName}`,
                        date: data.createdAt?.toDate(),
                        icon: 'fa-user-plus',
                        color: 'info'
                    });
                });
                
                // Récupérer les dernières inscriptions d'élèves maternelles
                const kindergartenStudentsSnap = await getDocs(query(collection(db, 'kindergarten_students'), where('status', '!=', 'deleted'), orderBy('createdAt', 'desc')));
                kindergartenStudentsSnap.forEach(doc => {
                    const data = doc.data();
                    activities.push({
                        type: 'kindergarten_student_enrollment',
                        message: `Nouvel élève maternelle inscrit: ${data.fullName}`,
                        date: data.createdAt?.toDate(),
                        icon: 'fa-user-plus',
                        color: 'info'
                    });
                });
                
                // Récupérer les dernières inscriptions d'enseignants secondaires
                const teachersSnap = await getDocs(query(collection(db, 'teachers'), where('status', '!=', 'deleted'), orderBy('createdAt', 'desc')));
                teachersSnap.forEach(doc => {
                    const data = doc.data();
                    activities.push({
                        type: 'teacher_enrollment',
                        message: `Nouvel enseignant secondaire inscrit: ${data.fullName}`,
                        date: data.createdAt?.toDate(),
                        icon: 'fa-user-tie',
                        color: 'info'
                    });
                });
                
                // Récupérer les dernières inscriptions d'enseignants primaires
                const primaryTeachersSnap = await getDocs(query(collection(db, 'primary_teachers'), where('status', '!=', 'deleted'), orderBy('createdAt', 'desc')));
                primaryTeachersSnap.forEach(doc => {
                    const data = doc.data();
                    activities.push({
                        type: 'primary_teacher_enrollment',
                        message: `Nouvel enseignant primaire inscrit: ${data.fullName}`,
                        date: data.createdAt?.toDate(),
                        icon: 'fa-user-tie',
                        color: 'info'
                    });
                });
                
                // Récupérer les dernières inscriptions d'enseignants maternelles
                const kindergartenTeachersSnap = await getDocs(query(collection(db, 'kindergarten_teachers'), where('status', '!=', 'deleted'), orderBy('createdAt', 'desc')));
                kindergartenTeachersSnap.forEach(doc => {
                    const data = doc.data();
                    activities.push({
                        type: 'kindergarten_teacher_enrollment',
                        message: `Nouvel enseignant maternelle inscrit: ${data.fullName}`,
                        date: data.createdAt?.toDate(),
                        icon: 'fa-user-tie',
                        color: 'info'
                    });
                });
                
                // Récupérer les derniers paiements
                const paymentsSnap = await getDocs(query(collection(db, 'payments'), orderBy('validatedAt', 'desc')));
                paymentsSnap.forEach(doc => {
                    const data = doc.data();
                    activities.push({
                        type: 'payment',
                        message: `Paiement validé pour ${data.studentName}: $${data.amount}`,
                        date: data.validatedAt?.toDate(),
                        icon: 'fa-money-bill-wave',
                        color: 'success'
                    });
                });
                
                // Trier par date et prendre les 10 plus récentes
                activities.sort((a, b) => b.date - a.date);
                const recentActivities = activities.slice(0, 10);
                
                let activitiesHTML = '';
                
                if (recentActivities.length === 0) {
                    activitiesHTML = '<p>Aucune activité récente</p>';
                } else {
                    recentActivities.forEach(activity => {
                        activitiesHTML += `
                            <div style="padding: 10px 0; border-bottom: 1px solid #eee;">
                                <i class="fas ${activity.icon}" style="color: var(--${activity.color});"></i>
                                <span>${activity.message}</span>
                                <small style="color: #666; display: block;">${formatDate(activity.date)}</small>
                            </div>
                        `;
                    });
                }
                
                activitiesEl.innerHTML = activitiesHTML;
            } catch (error) {
                console.error("Erreur chargement activités:", error);
                activitiesEl.innerHTML = '<p>Erreur de chargement</p>';
            }
        }

        // --- Inscription Élève Secondaire (optimisée) ---
        document.getElementById('student-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const studentName = document.getElementById('student-name').value;
            const birthdate = document.getElementById('student-birthdate').value;
            const birthplace = document.getElementById('student-birthplace').value;
            const gender = document.getElementById('student-gender').value;
            const address = document.getElementById('student-address').value;
            const phone = document.getElementById('student-phone').value;
            const studentClass = document.getElementById('student-class').value;
            const enrollmentFees = parseFloat(document.getElementById('student-fees').value) || 0;
            const parentName = document.getElementById('parent-name').value;
            const parentPhone = document.getElementById('parent-phone').value;
            const parentAddress = document.getElementById('parent-address').value;
            const year = new Date().getFullYear();

            // Validation basique
            if (!studentName || !birthdate || !studentClass || !parentName || !parentPhone) {
                showAlert("Veuillez remplir tous les champs obligatoires", "error");
                return;
            }

            const submitBtn = document.getElementById('student-submit-btn');
            const originalText = submitBtn.textContent;
            
            try {
                // Afficher le chargement
                submitBtn.textContent = 'Inscription en cours...';
                submitBtn.disabled = true;

                console.log("Début de l'inscription pour:", studentName);

                // Générer matricule
                const q = query(collection(db, 'students'), where('year', '==', year));
                const countSnap = await getDocs(q);
                const matricule = `SEC${year}${(countSnap.size + 1).toString().padStart(3, '0')}`;

                console.log("Matricule généré:", matricule);

                // Uploader la photo vers Cloudinary si elle existe (en parallèle)
                let photoURL = null;
                if (studentPhotoFile) {
                    try {
                        photoURL = await uploadToCloudinary(studentPhotoFile, `students/${matricule}`);
                        console.log("✅ Photo élève uploadée:", photoURL);
                    } catch (uploadError) {
                        console.error("❌ Erreur photo élève:", uploadError);
                        // Continuer sans photo si l'upload échoue
                    }
                }

                // Créer l'élève dans Firestore
                const studentData = {
                    matricule,
                    fullName: studentName,
                    birthdate,
                    birthplace,
                    gender,
                    address,
                    phone,
                    class: studentClass,
                    enrollmentFees,
                    parentName,
                    parentPhone,
                    parentAddress,
                    photoURL,
                    studentType: 'secondary',
                    status: 'active',
                    year,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                };

                console.log("Données élève préparées:", studentData);

                // Utiliser setDoc avec l'ID comme matricule pour éviter les doublons
                const studentRef = doc(db, 'students', matricule);
                await setDoc(studentRef, studentData);
                console.log("Élève sauvegardé dans Firestore");

                // Sauvegarder le dernier élève inscrit pour l'impression
                lastEnrolledStudent = { ...studentData, id: matricule };
                
                // Enregistrer les frais d'inscription comme un paiement
                if (enrollmentFees > 0) {
                    const paymentData = {
                        studentId: matricule,
                        studentName: studentName,
                        studentClass: studentClass,
                        studentType: 'secondary',
                        month: 'inscription',
                        paymentType: 'Frais d\'inscription',
                        amount: enrollmentFees,
                        validatedBy: currentSecretary.uid,
                        validatedAt: serverTimestamp(),
                        createdAt: serverTimestamp(),
                        paymentMethod: 'onsite',
                        description: 'Frais d\'inscription pour l\'année scolaire'
                    };
                    
                    const paymentRef = doc(collection(db, 'payments'));
                    await setDoc(paymentRef, paymentData);
                }

                showAlert(`Élève secondaire ${studentName} inscrit avec succès! Matricule: ${matricule}`, 'success');
                form.reset();
                studentPhotoFile = null;
                document.getElementById('student-photo-preview').innerHTML = '<i class="fas fa-camera"></i>';
                
                // Afficher le bouton d'impression du bordereau
                document.getElementById('print-student-btn').style.display = 'inline-block';
                
                // Mettre à jour les statistiques et listes
                loadDashboardStats();
                loadStudentsList();

            } catch (error) {
                console.error('Erreur complète inscription élève:', error);
                if (!isOnline) {
                    // Sauvegarder localement
                    addToOfflineQueue('addStudent', { studentData: studentData });
                    showAlert(`Élève sauvegardé localement (hors ligne). Matricule: ${matricule}`, 'warning');
                    form.reset();
                    studentPhotoFile = null;
                    document.getElementById('student-photo-preview').innerHTML = '<i class="fas fa-camera"></i>';
                } else {
                    showAlert(`Erreur lors de l'inscription: ${error.message}`, 'error');
                }
            } finally {
                // Réactiver le bouton
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        // --- Inscription Élève Primaire ---
        document.getElementById('primary-student-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const studentName = document.getElementById('primary-student-name').value;
            const birthdate = document.getElementById('primary-student-birthdate').value;
            const birthplace = document.getElementById('primary-student-birthplace').value;
            const gender = document.getElementById('primary-student-gender').value;
            const address = document.getElementById('primary-student-address').value;
            const studentClass = document.getElementById('primary-student-class').value;
            const enrollmentFees = parseFloat(document.getElementById('primary-student-fees').value) || 0;
            const parentName = document.getElementById('primary-parent-name').value;
            const parentPhone = document.getElementById('primary-parent-phone').value;
            const parentAddress = document.getElementById('primary-parent-address').value;
            const year = new Date().getFullYear();

            // Validation basique
            if (!studentName || !birthdate || !studentClass || !parentName || !parentPhone) {
                showAlert("Veuillez remplir tous les champs obligatoires", "error");
                return;
            }

            const submitBtn = document.getElementById('primary-student-submit-btn');
            const originalText = submitBtn.textContent;
            
            try {
                // Afficher le chargement
                submitBtn.textContent = 'Inscription en cours...';
                submitBtn.disabled = true;

                console.log("Début de l'inscription pour élève primaire:", studentName);

                // Générer matricule
                const q = query(collection(db, 'primary_students'), where('year', '==', year));
                const countSnap = await getDocs(q);
                const matricule = `PRI${year}${(countSnap.size + 1).toString().padStart(3, '0')}`;

                console.log("Matricule primaire généré:", matricule);

                // Uploader la photo vers Cloudinary si elle existe (en parallèle)
                let photoURL = null;
                if (primaryStudentPhotoFile) {
                    try {
                        photoURL = await uploadToCloudinary(primaryStudentPhotoFile, `primary_students/${matricule}`);
                        console.log("✅ Photo élève primaire uploadée:", photoURL);
                    } catch (uploadError) {
                        console.error("❌ Erreur photo élève primaire:", uploadError);
                        // Continuer sans photo si l'upload échoue
                    }
                }

                // Créer l'élève dans Firestore
                const studentData = {
                    matricule,
                    fullName: studentName,
                    birthdate,
                    birthplace,
                    gender,
                    address,
                    class: studentClass,
                    enrollmentFees,
                    parentName,
                    parentPhone,
                    parentAddress,
                    photoURL,
                    studentType: 'primary',
                    status: 'active',
                    year,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                };

                console.log("Données élève primaire préparées:", studentData);

                // Utiliser setDoc avec l'ID comme matricule
                const studentRef = doc(db, 'primary_students', matricule);
                await setDoc(studentRef, studentData);
                console.log("Élève primaire sauvegardé dans Firestore");

                // Sauvegarder le dernier élève inscrit pour l'impression
                lastEnrolledStudent = { ...studentData, id: matricule };
                
                // Enregistrer les frais d'inscription comme un paiement
                if (enrollmentFees > 0) {
                    const paymentData = {
                        studentId: matricule,
                        studentName: studentName,
                        studentClass: studentClass,
                        studentType: 'primary',
                        month: 'inscription',
                        paymentType: 'Frais d\'inscription',
                        amount: enrollmentFees,
                        validatedBy: currentSecretary.uid,
                        validatedAt: serverTimestamp(),
                        createdAt: serverTimestamp(),
                        paymentMethod: 'onsite',
                        description: 'Frais d\'inscription pour l\'année scolaire'
                    };
                    
                    const paymentRef = doc(collection(db, 'payments'));
                    await setDoc(paymentRef, paymentData);
                }

                showAlert(`Élève primaire ${studentName} inscrit avec succès! Matricule: ${matricule}`, 'success');
                form.reset();
                primaryStudentPhotoFile = null;
                document.getElementById('primary-student-photo-preview').innerHTML = '<i class="fas fa-camera"></i>';
                
                // Afficher le bouton d'impression du bordereau
                document.getElementById('print-primary-student-btn').style.display = 'inline-block';
                
                // Mettre à jour les statistiques et listes
                loadDashboardStats();
                loadStudentsList();

            } catch (error) {
                console.error('Erreur complète inscription élève primaire:', error);
                if (!isOnline) {
                    // Sauvegarder localement
                    addToOfflineQueue('addPrimaryStudent', { studentData: studentData });
                    showAlert(`Élève primaire sauvegardé localement (hors ligne). Matricule: ${matricule}`, 'warning');
                    form.reset();
                    primaryStudentPhotoFile = null;
                    document.getElementById('primary-student-photo-preview').innerHTML = '<i class="fas fa-camera"></i>';
                } else {
                    showAlert(`Erreur lors de l'inscription: ${error.message}`, 'error');
                }
            } finally {
                // Réactiver le bouton
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        // --- Inscription Élève Maternelle ---
        document.getElementById('kindergarten-student-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const studentName = document.getElementById('kindergarten-student-name').value;
            const birthdate = document.getElementById('kindergarten-student-birthdate').value;
            const birthplace = document.getElementById('kindergarten-student-birthplace').value;
            const gender = document.getElementById('kindergarten-student-gender').value;
            const address = document.getElementById('kindergarten-student-address').value;
            const studentClass = document.getElementById('kindergarten-student-class').value;
            const enrollmentFees = parseFloat(document.getElementById('kindergarten-student-fees').value) || 0;
            const parentName = document.getElementById('kindergarten-parent-name').value;
            const parentPhone = document.getElementById('kindergarten-parent-phone').value;
            const parentAddress = document.getElementById('kindergarten-parent-address').value;
            const year = new Date().getFullYear();

            // Validation basique
            if (!studentName || !birthdate || !studentClass || !parentName || !parentPhone) {
                showAlert("Veuillez remplir tous les champs obligatoires", "error");
                return;
            }

            const submitBtn = document.getElementById('kindergarten-student-submit-btn');
            const originalText = submitBtn.textContent;
            
            try {
                // Afficher le chargement
                submitBtn.textContent = 'Inscription en cours...';
                submitBtn.disabled = true;

                console.log("Début de l'inscription pour élève maternelle:", studentName);

                // Générer matricule
                const q = query(collection(db, 'kindergarten_students'), where('year', '==', year));
                const countSnap = await getDocs(q);
                const matricule = `MAT${year}${(countSnap.size + 1).toString().padStart(3, '0')}`;

                console.log("Matricule maternelle généré:", matricule);

                // Uploader la photo vers Cloudinary si elle existe (en parallèle)
                let photoURL = null;
                if (kindergartenStudentPhotoFile) {
                    try {
                        photoURL = await uploadToCloudinary(kindergartenStudentPhotoFile, `kindergarten_students/${matricule}`);
                        console.log("✅ Photo élève maternelle uploadée:", photoURL);
                    } catch (uploadError) {
                        console.error("❌ Erreur photo élève maternelle:", uploadError);
                        // Continuer sans photo si l'upload échoue
                    }
                }

                // Créer l'élève dans Firestore
                const studentData = {
                    matricule,
                    fullName: studentName,
                    birthdate,
                    birthplace,
                    gender,
                    address,
                    class: studentClass,
                    enrollmentFees,
                    parentName,
                    parentPhone,
                    parentAddress,
                    photoURL,
                    studentType: 'kindergarten',
                    status: 'active',
                    year,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                };

                console.log("Données élève maternelle préparées:", studentData);

                // Utiliser setDoc avec l'ID comme matricule
                const studentRef = doc(db, 'kindergarten_students', matricule);
                await setDoc(studentRef, studentData);
                console.log("Élève maternelle sauvegardé dans Firestore");

                // Sauvegarder le dernier élève inscrit pour l'impression
                lastEnrolledStudent = { ...studentData, id: matricule };
                
                // Enregistrer les frais d'inscription comme un paiement
                if (enrollmentFees > 0) {
                    const paymentData = {
                        studentId: matricule,
                        studentName: studentName,
                        studentClass: studentClass,
                        studentType: 'kindergarten',
                        month: 'inscription',
                        paymentType: 'Frais d\'inscription',
                        amount: enrollmentFees,
                        validatedBy: currentSecretary.uid,
                        validatedAt: serverTimestamp(),
                        createdAt: serverTimestamp(),
                        paymentMethod: 'onsite',
                        description: 'Frais d\'inscription pour l\'année scolaire'
                    };
                    
                    const paymentRef = doc(collection(db, 'payments'));
                    await setDoc(paymentRef, paymentData);
                }

                showAlert(`Élève maternelle ${studentName} inscrit avec succès! Matricule: ${matricule}`, 'success');
                form.reset();
                kindergartenStudentPhotoFile = null;
                document.getElementById('kindergarten-student-photo-preview').innerHTML = '<i class="fas fa-camera"></i>';
                
                // Afficher le bouton d'impression du bordereau
                document.getElementById('print-kindergarten-student-btn').style.display = 'inline-block';
                
                // Mettre à jour les statistiques et listes
                loadDashboardStats();
                loadStudentsList();

            } catch (error) {
                console.error('Erreur complète inscription élève maternelle:', error);
                if (!isOnline) {
                    // Sauvegarder localement
                    addToOfflineQueue('addKindergartenStudent', { studentData: studentData });
                    showAlert(`Élève maternelle sauvegardé localement (hors ligne). Matricule: ${matricule}`, 'warning');
                    form.reset();
                    kindergartenStudentPhotoFile = null;
                    document.getElementById('kindergarten-student-photo-preview').innerHTML = '<i class="fas fa-camera"></i>';
                } else {
                    showAlert(`Erreur lors de l'inscription: ${error.message}`, 'error');
                }
            } finally {
                // Réactiver le bouton
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        // --- Inscription Enseignant Secondaire (optimisée) ---
        async function loadTeacherClasses() {
            const container = document.getElementById('teacher-classes-container');
            container.innerHTML = 'Chargement...';
            
            try {
                const classesSnap = await getDocs(collection(db, 'classes'));
                let html = '';
                classesSnap.forEach(doc => {
                    const data = doc.data();
                    html += `
                        <div class="class-checkbox">
                            <input type="checkbox" id="class-${doc.id}" value="${data.name}">
                            <label for="class-${doc.id}">${data.name}</label>
                        </div>
                    `;
                });
                container.innerHTML = html || '<p>Aucune classe disponible</p>';
            } catch (error) {
                console.error("Erreur chargement classes:", error);
                container.innerHTML = 'Erreur de chargement';
            }
        }

        document.getElementById('teacher-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const teacherName = document.getElementById('teacher-name').value;
            const birthdate = document.getElementById('teacher-birthdate').value;
            const birthplace = document.getElementById('teacher-birthplace').value;
            const gender = document.getElementById('teacher-gender').value;
            const address = document.getElementById('teacher-address').value;
            const phone = document.getElementById('teacher-phone').value;
            const teacherSubjects = document.getElementById('teacher-subjects').value.split(',').map(s => s.trim());
            
            // Récupérer les classes sélectionnées
            const selectedClasses = [];
            document.querySelectorAll('#teacher-classes-container input[type="checkbox"]:checked').forEach(checkbox => {
                selectedClasses.push(checkbox.value);
            });

            const submitBtn = document.getElementById('teacher-submit-btn');
            const originalText = submitBtn.textContent;

            try {
                // Afficher le chargement
                submitBtn.textContent = 'Inscription en cours...';
                submitBtn.disabled = true;

                // Générer matricule enseignant
                const teacherSnap = await getDocs(collection(db, 'teachers'));
                const teacherCount = teacherSnap.size + 1;
                const teacherMatricule = `ENS${teacherCount.toString().padStart(3, '0')}`;

                // Uploader la photo vers Cloudinary si elle existe (en parallèle)
                let photoURL = null;
                if (teacherPhotoFile) {
                    try {
                        photoURL = await uploadToCloudinary(teacherPhotoFile, `teachers/${teacherMatricule}`);
                        console.log("✅ Photo enseignant uploadée:", photoURL);
                    } catch (uploadError) {
                        console.error("❌ Erreur upload photo enseignant:", uploadError);
                        // Continuer sans photo
                    }
                }

                // Créer l'enseignant dans Firestore
                const teacherData = {
                    matricule: teacherMatricule,
                    fullName: teacherName,
                    birthdate,
                    birthplace,
                    gender,
                    address,
                    phone,
                    subjects: teacherSubjects,
                    classes: selectedClasses,
                    teacherType: 'secondary',
                    photoURL,
                    status: 'active',
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                };

                // Utiliser setDoc avec l'ID comme matricule
                const teacherRef = doc(db, 'teachers', teacherMatricule);
                await setDoc(teacherRef, teacherData);

                showAlert(`Enseignant secondaire ${teacherName} inscrit avec succès! Matricule: ${teacherMatricule}`, 'success');
                document.getElementById('teacher-form').reset();
                teacherPhotoFile = null;
                document.getElementById('teacher-photo-preview').innerHTML = '<i class="fas fa-camera"></i>';
                
                // Mettre à jour les statistiques et listes
                loadDashboardStats();
                loadTeachersList();
            } catch (error) {
                console.error('Erreur inscription enseignant:', error);
                if (!isOnline) {
                    // Sauvegarder localement
                    addToOfflineQueue('addTeacher', { teacherData: teacherData });
                    showAlert(`Enseignant sauvegardé localement (hors ligne). Matricule: ${teacherMatricule}`, 'warning');
                    document.getElementById('teacher-form').reset();
                    teacherPhotoFile = null;
                    document.getElementById('teacher-photo-preview').innerHTML = '<i class="fas fa-camera"></i>';
                } else {
                    showAlert(`Erreur lors de l'inscription: ${error.message}`, 'error');
                }
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        // --- Inscription Enseignant Primaire ---
        async function loadPrimaryTeacherClasses() {
            const container = document.getElementById('primary-teacher-classes-container');
            container.innerHTML = 'Chargement...';
            
            try {
                const classesSnap = await getDocs(collection(db, 'primary_classes'));
                let html = '';
                classesSnap.forEach(doc => {
                    const data = doc.data();
                    html += `
                        <div class="class-checkbox">
                            <input type="checkbox" id="primary-class-${doc.id}" value="${data.name}">
                            <label for="primary-class-${doc.id}">${data.name}</label>
                        </div>
                    `;
                });
                container.innerHTML = html || '<p>Aucune classe primaire disponible</p>';
            } catch (error) {
                console.error("Erreur chargement classes primaires:", error);
                container.innerHTML = 'Erreur de chargement';
            }
        }

        document.getElementById('primary-teacher-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const teacherName = document.getElementById('primary-teacher-name').value;
            const birthdate = document.getElementById('primary-teacher-birthdate').value;
            const birthplace = document.getElementById('primary-teacher-birthplace').value;
            const gender = document.getElementById('primary-teacher-gender').value;
            const address = document.getElementById('primary-teacher-address').value;
            const phone = document.getElementById('primary-teacher-phone').value;
            
            // Récupérer les classes sélectionnées
            const selectedClasses = [];
            document.querySelectorAll('#primary-teacher-classes-container input[type="checkbox"]:checked').forEach(checkbox => {
                selectedClasses.push(checkbox.value);
            });

            const submitBtn = document.getElementById('primary-teacher-submit-btn');
            const originalText = submitBtn.textContent;

            try {
                // Afficher le chargement
                submitBtn.textContent = 'Inscription en cours...';
                submitBtn.disabled = true;

                // Générer matricule enseignant primaire
                const teacherSnap = await getDocs(collection(db, 'primary_teachers'));
                const teacherCount = teacherSnap.size + 1;
                const teacherMatricule = `ENP${teacherCount.toString().padStart(3, '0')}`;

                // Uploader la photo vers Cloudinary si elle existe (en parallèle)
                let photoURL = null;
                if (primaryTeacherPhotoFile) {
                    try {
                        photoURL = await uploadToCloudinary(primaryTeacherPhotoFile, `primary_teachers/${teacherMatricule}`);
                        console.log("✅ Photo enseignant primaire uploadée:", photoURL);
                    } catch (uploadError) {
                        console.error("❌ Erreur upload photo enseignant primaire:", uploadError);
                        // Continuer sans photo
                    }
                }

                // Créer l'enseignant dans Firestore
                const teacherData = {
                    matricule: teacherMatricule,
                    fullName: teacherName,
                    birthdate,
                    birthplace,
                    gender,
                    address,
                    phone,
                    classes: selectedClasses,
                    teacherType: 'primary',
                    photoURL,
                    status: 'active',
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                };

                // Utiliser setDoc avec l'ID comme matricule
                const teacherRef = doc(db, 'primary_teachers', teacherMatricule);
                await setDoc(teacherRef, teacherData);

                showAlert(`Enseignant primaire ${teacherName} inscrit avec succès! Matricule: ${teacherMatricule}`, 'success');
                document.getElementById('primary-teacher-form').reset();
                primaryTeacherPhotoFile = null;
                document.getElementById('primary-teacher-photo-preview').innerHTML = '<i class="fas fa-camera"></i>';
                
                // Mettre à jour les statistiques et listes
                loadDashboardStats();
                loadTeachersList();
            } catch (error) {
                console.error('Erreur inscription enseignant primaire:', error);
                if (!isOnline) {
                    // Sauvegarder localement
                    addToOfflineQueue('addPrimaryTeacher', { teacherData: teacherData });
                    showAlert(`Enseignant primaire sauvegardé localement (hors ligne). Matricule: ${teacherMatricule}`, 'warning');
                    document.getElementById('primary-teacher-form').reset();
                    primaryTeacherPhotoFile = null;
                    document.getElementById('primary-teacher-photo-preview').innerHTML = '<i class="fas fa-camera"></i>';
                } else {
                    showAlert(`Erreur lors de l'inscription: ${error.message}`, 'error');
                }
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        // --- Inscription Enseignant Maternelle ---
        async function loadKindergartenTeacherClasses() {
            const container = document.getElementById('kindergarten-teacher-classes-container');
            container.innerHTML = 'Chargement...';
            
            try {
                const classesSnap = await getDocs(collection(db, 'kindergarten_classes'));
                let html = '';
                classesSnap.forEach(doc => {
                    const data = doc.data();
                    html += `
                        <div class="class-checkbox">
                            <input type="checkbox" id="kindergarten-class-${doc.id}" value="${data.name}">
                            <label for="kindergarten-class-${doc.id}">${data.name}</label>
                        </div>
                    `;
                });
                container.innerHTML = html || '<p>Aucune classe maternelle disponible</p>';
            } catch (error) {
                console.error("Erreur chargement classes maternelles:", error);
                container.innerHTML = 'Erreur de chargement';
            }
        }

        document.getElementById('kindergarten-teacher-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const teacherName = document.getElementById('kindergarten-teacher-name').value;
            const birthdate = document.getElementById('kindergarten-teacher-birthdate').value;
            const birthplace = document.getElementById('kindergarten-teacher-birthplace').value;
            const gender = document.getElementById('kindergarten-teacher-gender').value;
            const address = document.getElementById('kindergarten-teacher-address').value;
            const phone = document.getElementById('kindergarten-teacher-phone').value;
            
            // Récupérer les classes sélectionnées
            const selectedClasses = [];
            document.querySelectorAll('#kindergarten-teacher-classes-container input[type="checkbox"]:checked').forEach(checkbox => {
                selectedClasses.push(checkbox.value);
            });

            const submitBtn = document.getElementById('kindergarten-teacher-submit-btn');
            const originalText = submitBtn.textContent;

            try {
                // Afficher le chargement
                submitBtn.textContent = 'Inscription en cours...';
                submitBtn.disabled = true;

                // Générer matricule enseignant maternelle
                const teacherSnap = await getDocs(collection(db, 'kindergarten_teachers'));
                const teacherCount = teacherSnap.size + 1;
                const teacherMatricule = `ENM${teacherCount.toString().padStart(3, '0')}`;

                // Uploader la photo vers Cloudinary si elle existe (en parallèle)
                let photoURL = null;
                if (kindergartenTeacherPhotoFile) {
                    try {
                        photoURL = await uploadToCloudinary(kindergartenTeacherPhotoFile, `kindergarten_teachers/${teacherMatricule}`);
                        console.log("✅ Photo enseignant maternelle uploadée:", photoURL);
                    } catch (uploadError) {
                        console.error("❌ Erreur upload photo enseignant maternelle:", uploadError);
                        // Continuer sans photo
                    }
                }

                // Créer l'enseignant dans Firestore
                const teacherData = {
                    matricule: teacherMatricule,
                    fullName: teacherName,
                    birthdate,
                    birthplace,
                    gender,
                    address,
                    phone,
                    classes: selectedClasses,
                    teacherType: 'kindergarten',
                    photoURL,
                    status: 'active',
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                };

                // Utiliser setDoc avec l'ID comme matricule
                const teacherRef = doc(db, 'kindergarten_teachers', teacherMatricule);
                await setDoc(teacherRef, teacherData);

                showAlert(`Enseignant maternelle ${teacherName} inscrit avec succès! Matricule: ${teacherMatricule}`, 'success');
                document.getElementById('kindergarten-teacher-form').reset();
                kindergartenTeacherPhotoFile = null;
                document.getElementById('kindergarten-teacher-photo-preview').innerHTML = '<i class="fas fa-camera"></i>';
                
                // Mettre à jour les statistiques et listes
                loadDashboardStats();
                loadTeachersList();
            } catch (error) {
                console.error('Erreur inscription enseignant maternelle:', error);
                if (!isOnline) {
                    // Sauvegarder localement
                    addToOfflineQueue('addKindergartenTeacher', { teacherData: teacherData });
                    showAlert(`Enseignant maternelle sauvegardé localement (hors ligne). Matricule: ${teacherMatricule}`, 'warning');
                    document.getElementById('kindergarten-teacher-form').reset();
                    kindergartenTeacherPhotoFile = null;
                    document.getElementById('kindergarten-teacher-photo-preview').innerHTML = '<i class="fas fa-camera"></i>';
                } else {
                    showAlert(`Erreur lors de l'inscription: ${error.message}`, 'error');
                }
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        // --- Gestion des Classes Secondaires ---
        async function loadClassesIntoSelects() {
    const classSelect = document.getElementById('student-class');
    const primaryClassSelect = document.getElementById('primary-student-class');
    const kindergartenClassSelect = document.getElementById('kindergarten-student-class');
    const filterClassSelect = document.getElementById('filter-class');
    const feesClassSelect = document.getElementById('fees-class');
    const editClassSelect = document.getElementById('edit-student-class');
    const enrollmentClassSelect = document.getElementById('enrollment-class');
    const exportClassSelect = document.getElementById('export-class');
    const reportClassSelect = document.getElementById('report-class');
    
    // Réinitialiser seulement les champs spécifiques aux élèves
    if (classSelect) classSelect.innerHTML = '<option value="">-- Sélectionner --</option>';
    if (primaryClassSelect) primaryClassSelect.innerHTML = '<option value="">-- Sélectionner --</option>';
    if (kindergartenClassSelect) kindergartenClassSelect.innerHTML = '<option value="">-- Sélectionner --</option>';
    if (filterClassSelect) filterClassSelect.innerHTML = '<option value="">Toutes les classes</option>';
    if (feesClassSelect) feesClassSelect.innerHTML = '<option value="">Toutes les classes</option>';
    if (editClassSelect) editClassSelect.innerHTML = '<option value="">-- Sélectionner --</option>';
    if (exportClassSelect) exportClassSelect.innerHTML = '<option value="">Toutes les classes</option>';
    if (reportClassSelect) reportClassSelect.innerHTML = '<option value="">Toutes les classes</option>';
    
    try {
        // Classes secondaires - UNIQUEMENT dans le select secondaire
        const classesSnap = await getDocs(collection(db, 'classes'));
        classesSnap.forEach(doc => {
            const data = doc.data();
            if (classSelect) classSelect.innerHTML += `<option value="${data.name}">${data.name}</option>`;
            if (editClassSelect) editClassSelect.innerHTML += `<option value="${data.name}">${data.name}</option>`;
            if (filterClassSelect) filterClassSelect.innerHTML += `<option value="${data.name}">${data.name} (Secondaire)</option>`;
            if (feesClassSelect) feesClassSelect.innerHTML += `<option value="${data.name}">${data.name} (Secondaire)</option>`;
            if (exportClassSelect) exportClassSelect.innerHTML += `<option value="${data.name}">${data.name} (Secondaire)</option>`;
            if (reportClassSelect) reportClassSelect.innerHTML += `<option value="${data.name}">${data.name} (Secondaire)</option>`;
        });
        
        // Classes primaires - UNIQUEMENT dans le select primaire
        const primaryClassesSnap = await getDocs(collection(db, 'primary_classes'));
        primaryClassesSnap.forEach(doc => {
            const data = doc.data();
            if (primaryClassSelect) primaryClassSelect.innerHTML += `<option value="${data.name}">${data.name}</option>`;
            if (filterClassSelect) filterClassSelect.innerHTML += `<option value="${data.name}">${data.name} (Primaire)</option>`;
            if (feesClassSelect) feesClassSelect.innerHTML += `<option value="${data.name}">${data.name} (Primaire)</option>`;
            if (exportClassSelect) exportClassSelect.innerHTML += `<option value="${data.name}">${data.name} (Primaire)</option>`;
            if (reportClassSelect) reportClassSelect.innerHTML += `<option value="${data.name}">${data.name} (Primaire)</option>`;
        });
        
        // Classes maternelles - UNIQUEMENT dans le select maternelle
        const kindergartenClassesSnap = await getDocs(collection(db, 'kindergarten_classes'));
        kindergartenClassesSnap.forEach(doc => {
            const data = doc.data();
            if (kindergartenClassSelect) kindergartenClassSelect.innerHTML += `<option value="${data.name}">${data.name}</option>`;
            if (filterClassSelect) filterClassSelect.innerHTML += `<option value="${data.name}">${data.name} (Maternelle)</option>`;
            if (feesClassSelect) feesClassSelect.innerHTML += `<option value="${data.name}">${data.name} (Maternelle)</option>`;
            if (exportClassSelect) exportClassSelect.innerHTML += `<option value="${data.name}">${data.name} (Maternelle)</option>`;
            if (reportClassSelect) reportClassSelect.innerHTML += `<option value="${data.name}">${data.name} (Maternelle)</option>`;
        });
    } catch (error) {
        console.error('Erreur chargement classes:', error);
    }
}

async function loadClassesForEditModal(studentType) {
    const editClassSelect = document.getElementById('edit-student-class');
    if (!editClassSelect) return;
    
    editClassSelect.innerHTML = '<option value="">-- Sélectionner --</option>';
    
    try {
        if (studentType === 'secondary') {
            const classesSnap = await getDocs(collection(db, 'classes'));
            classesSnap.forEach(doc => {
                const data = doc.data();
                editClassSelect.innerHTML += `<option value="${data.name}">${data.name}</option>`;
            });
        } else if (studentType === 'primary') {
            const classesSnap = await getDocs(collection(db, 'primary_classes'));
            classesSnap.forEach(doc => {
                const data = doc.data();
                editClassSelect.innerHTML += `<option value="${data.name}">${data.name}</option>`;
            });
        } else if (studentType === 'kindergarten') {
            const classesSnap = await getDocs(collection(db, 'kindergarten_classes'));
            classesSnap.forEach(doc => {
                const data = doc.data();
                editClassSelect.innerHTML += `<option value="${data.name}">${data.name}</option>`;
            });
        }
    } catch (error) {
        console.error('Erreur chargement classes pour édition:', error);
    }
}

// Ajoutez cette fonction après la fonction loadClassesIntoSelects() existante
async function loadAllClassesForReports() {
    const reportClassSelect = document.getElementById('report-class');
    const exportClassSelect = document.getElementById('export-class');
    
    if (!reportClassSelect || !exportClassSelect) return;
    
    try {
        reportClassSelect.innerHTML = '<option value="">Toutes les classes</option>';
        exportClassSelect.innerHTML = '<option value="">Toutes les classes</option>';
        
        // Classes secondaires
        const classesSnap = await getDocs(collection(db, 'classes'));
        classesSnap.forEach(doc => {
            const data = doc.data();
            reportClassSelect.innerHTML += `<option value="${data.name}">${data.name} (Secondaire)</option>`;
            exportClassSelect.innerHTML += `<option value="${data.name}">${data.name} (Secondaire)</option>`;
        });
        
        // Classes primaires
        const primaryClassesSnap = await getDocs(collection(db, 'primary_classes'));
        primaryClassesSnap.forEach(doc => {
            const data = doc.data();
            reportClassSelect.innerHTML += `<option value="${data.name}">${data.name} (Primaire)</option>`;
            exportClassSelect.innerHTML += `<option value="${data.name}">${data.name} (Primaire)</option>`;
        });
        
        // Classes maternelles
        const kindergartenClassesSnap = await getDocs(collection(db, 'kindergarten_classes'));
        kindergartenClassesSnap.forEach(doc => {
            const data = doc.data();
            reportClassSelect.innerHTML += `<option value="${data.name}">${data.name} (Maternelle)</option>`;
            exportClassSelect.innerHTML += `<option value="${data.name}">${data.name} (Maternelle)</option>`;
        });
    } catch (error) {
        console.error('Erreur chargement classes pour rapports:', error);
    }
}
        
        // Fonction pour charger la liste des classes secondaires
        async function loadClassesList() {
            const listEl = document.getElementById('classes-list');
            listEl.innerHTML = "<tr><td colspan='5' style='text-align: center;'>Chargement...</td></tr>";
            
            try {
                const classesSnap = await getDocs(collection(db, 'classes'));
                
                console.log("Nombre de classes secondaires trouvées:", classesSnap.size);
                
                if (classesSnap.empty) {
                    listEl.innerHTML = '<tr><td colspan="5" style="text-align: center;">Aucune classe créée.</td></tr>';
                    return;
                }
                
                let html = '';
                
                for (const classDoc of classesSnap.docs) {
                    const data = classDoc.data();
                    console.log(`Classe ${classDoc.id}:`, data);
                    
                    let studentCount = 0;
                    try {
                        // Récupérer tous les étudiants et filtrer manuellement
                        const allStudentsSnap = await getDocs(query(collection(db, 'students'), where('status', '!=', 'deleted')));
                        allStudentsSnap.forEach(studentDoc => {
                            const studentData = studentDoc.data();
                            if (studentData.class && studentData.class === data.name) {
                                studentCount++;
                            }
                        });
                    } catch (error) {
                        console.error("Erreur comptage étudiants:", error);
                    }
                    
                    html += `
                        <tr>
                            <td>${data.name || 'Non défini'}</td>
                            <td>${data.level || 'Non défini'}</td>
                            <td>${data.capacity || 'Non défini'}</td>
                            <td>${studentCount}</td>
                            <td class="action-buttons">
                                <button class="btn btn-warning" onclick="editClass('${classDoc.id}', 'secondary')">Modifier</button>
                                <button class="btn btn-danger" onclick="deleteClass('${classDoc.id}', 'secondary')">Supprimer</button>
                            </td>
                        </tr>
                    `;
                }
                
                listEl.innerHTML = html;
                
            } catch (error) {
                console.error("Erreur chargement classes secondaires:", error);
                listEl.innerHTML = '<tr><td colspan="5" style="text-align: center;">Erreur de chargement: ' + error.message + '</td></tr>';
            }
        }
        
        // Fonction pour charger la liste des classes primaires
        async function loadPrimaryClassesList() {
            const listEl = document.getElementById('primary-classes-list');
            listEl.innerHTML = "<tr><td colspan='5' style='text-align: center;'>Chargement...</td></tr>";
            
            try {
                const classesSnap = await getDocs(collection(db, 'primary_classes'));
                
                console.log("Nombre de classes primaires trouvées:", classesSnap.size);
                
                if (classesSnap.empty) {
                    listEl.innerHTML = '<tr><td colspan="5" style="text-align: center;">Aucune classe primaire créée.</td></tr>';
                    return;
                }
                
                let html = '';
                
                for (const classDoc of classesSnap.docs) {
                    const data = classDoc.data();
                    console.log(`Classe primaire ${classDoc.id}:`, data);
                    
                    let studentCount = 0;
                    try {
                        // Récupérer tous les étudiants primaires et filtrer manuellement
                        const allStudentsSnap = await getDocs(query(collection(db, 'primary_students'), where('status', '!=', 'deleted')));
                        allStudentsSnap.forEach(studentDoc => {
                            const studentData = studentDoc.data();
                            if (studentData.class && studentData.class === data.name) {
                                studentCount++;
                            }
                        });
                    } catch (error) {
                        console.error("Erreur comptage étudiants primaires:", error);
                    }
                    
                    html += `
                        <tr>
                            <td>${data.name || 'Non défini'}</td>
                            <td>${data.level || 'Non défini'}</td>
                            <td>${data.capacity || 'Non défini'}</td>
                            <td>${studentCount}</td>
                            <td class="action-buttons">
                                <button class="btn btn-warning" onclick="editClass('${classDoc.id}', 'primary')">Modifier</button>
                                <button class="btn btn-danger" onclick="deleteClass('${classDoc.id}', 'primary')">Supprimer</button>
                            </td>
                        </tr>
                    `;
                }
                
                listEl.innerHTML = html;
                
            } catch (error) {
                console.error("Erreur chargement classes primaires:", error);
                listEl.innerHTML = '<tr><td colspan="5" style="text-align: center;">Erreur de chargement: ' + error.message + '</td></tr>';
            }
        }
        
        // Fonction pour charger la liste des classes maternelles
        async function loadKindergartenClassesList() {
            const listEl = document.getElementById('kindergarten-classes-list');
            listEl.innerHTML = "<tr><td colspan='5' style='text-align: center;'>Chargement...</td></tr>";
            
            try {
                const classesSnap = await getDocs(collection(db, 'kindergarten_classes'));
                
                console.log("Nombre de classes maternelles trouvées:", classesSnap.size);
                
                if (classesSnap.empty) {
                    listEl.innerHTML = '<tr><td colspan="5" style="text-align: center;">Aucune classe maternelle créée.</td></tr>';
                    return;
                }
                
                let html = '';
                
                for (const classDoc of classesSnap.docs) {
                    const data = classDoc.data();
                    console.log(`Classe maternelle ${classDoc.id}:`, data);
                    
                    let studentCount = 0;
                    try {
                        // Récupérer tous les étudiants maternelles et filtrer manuellement
                        const allStudentsSnap = await getDocs(query(collection(db, 'kindergarten_students'), where('status', '!=', 'deleted')));
                        allStudentsSnap.forEach(studentDoc => {
                            const studentData = studentDoc.data();
                            if (studentData.class && studentData.class === data.name) {
                                studentCount++;
                            }
                        });
                    } catch (error) {
                        console.error("Erreur comptage étudiants maternelles:", error);
                    }
                    
                    html += `
                        <tr>
                            <td>${data.name || 'Non défini'}</td>
                            <td>${data.level || 'Non défini'}</td>
                            <td>${data.capacity || 'Non défini'}</td>
                            <td>${studentCount}</td>
                            <td class="action-buttons">
                                <button class="btn btn-warning" onclick="editClass('${classDoc.id}', 'kindergarten')">Modifier</button>
                                <button class="btn btn-danger" onclick="deleteClass('${classDoc.id}', 'kindergarten')">Supprimer</button>
                            </td>
                        </tr>
                    `;
                }
                
                listEl.innerHTML = html;
                
            } catch (error) {
                console.error("Erreur chargement classes maternelles:", error);
                listEl.innerHTML = '<tr><td colspan="5" style="text-align: center;">Erreur de chargement: ' + error.message + '</td></tr>';
            }
        }
        
        document.getElementById('class-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('class-name').value;
            const level = document.getElementById('class-level').value;
            const capacity = document.getElementById('class-capacity').value;
            
            if (!name || !level || !capacity) {
                showAlert("Veuillez remplir tous les champs pour la classe.", "error");
                return;
            }
            
            try {
                await addDoc(collection(db, 'classes'), { 
                    name, 
                    level, 
                    capacity: parseInt(capacity),
                    createdAt: serverTimestamp()
                });
                
                showAlert('Classe secondaire ajoutée avec succès !', 'success');
                document.getElementById('class-form').reset();
                
                loadClassesIntoSelects();
                loadClassesList();
                loadTeacherClasses();
                
            } catch (error) {
                console.error("Erreur ajout classe secondaire:", error);
                showAlert('Erreur lors de l\'ajout: ' + error.message, 'error');
            }
        });

        document.getElementById('primary-class-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('primary-class-name').value;
            const level = document.getElementById('primary-class-level').value;
            const capacity = document.getElementById('primary-class-capacity').value;
            
            if (!name || !level || !capacity) {
                showAlert("Veuillez remplir tous les champs pour la classe primaire.", "error");
                return;
            }
            
            try {
                await addDoc(collection(db, 'primary_classes'), { 
                    name, 
                    level, 
                    capacity: parseInt(capacity),
                    createdAt: serverTimestamp()
                });
                
                showAlert('Classe primaire ajoutée avec succès !', 'success');
                document.getElementById('primary-class-form').reset();
                
                loadClassesIntoSelects();
                loadPrimaryClassesList();
                loadPrimaryTeacherClasses();
                
            } catch (error) {
                console.error("Erreur ajout classe primaire:", error);
                showAlert('Erreur lors de l\'ajout: ' + error.message, 'error');
            }
        });

        document.getElementById('kindergarten-class-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('kindergarten-class-name').value;
            const level = document.getElementById('kindergarten-class-level').value;
            const capacity = document.getElementById('kindergarten-class-capacity').value;
            
            if (!name || !level || !capacity) {
                showAlert("Veuillez remplir tous les champs pour la classe maternelle.", "error");
                return;
            }
            
            try {
                await addDoc(collection(db, 'kindergarten_classes'), { 
                    name, 
                    level, 
                    capacity: parseInt(capacity),
                    createdAt: serverTimestamp()
                });
                
                showAlert('Classe maternelle ajoutée avec succès !', 'success');
                document.getElementById('kindergarten-class-form').reset();
                
                loadClassesIntoSelects();
                loadKindergartenClassesList();
                loadKindergartenTeacherClasses();
                
            } catch (error) {
                console.error("Erreur ajout classe maternelle:", error);
                showAlert('Erreur lors de l\'ajout: ' + error.message, 'error');
            }
        });

        // --- Validation Paiement (CORRIGÉ) ---
let foundRequest = null;

// Modifier la fonction de recherche pour récupérer les données sans validation
document.getElementById('find-payment-btn').addEventListener('click', async () => {
    const code = document.getElementById('payment-code-input').value;
    if (!code) {
        showAlert("Veuillez entrer un code de paiement", "error");
        return;
    }
    
    try {
        const q = query(collection(db, 'payment_requests'), where('paymentCode', '==', code), where('status', '==', 'pending'));
        const snap = await getDocs(q);

        if (snap.empty) {
            showAlert('Aucune demande de paiement en attente trouvée pour ce code.', 'error');
            document.getElementById('payment-details-card').classList.add('hidden');
            document.getElementById('edit-payment-form').classList.add('hidden');
            return;
        }
        
        foundRequest = snap.docs[0];
        const data = foundRequest.data();
        
        // Afficher les informations dans des champs modifiables
        document.getElementById('edit-payment-student-name').value = data.studentName;
        document.getElementById('edit-payment-student-class').value = data.studentClass || '';
        document.getElementById('edit-payment-student-type').value = data.studentType || 'secondary';
        document.getElementById('edit-payment-months').value = data.months.join(', ');
        document.getElementById('edit-payment-type').value = data.paymentType || 'Frais scolaires';
        document.getElementById('edit-payment-amount').value = data.amount.toFixed(2);
        document.getElementById('edit-payment-code').value = data.paymentCode;
        
        document.getElementById('payment-details-card').classList.remove('hidden');
        document.getElementById('edit-payment-form').classList.remove('hidden');
        
    } catch (error) {
        showAlert('Erreur de recherche: ' + error.message, 'error');
    }
});

document.getElementById('update-payment-btn').addEventListener('click', async () => {
    if (!foundRequest) return;
    
    // Récupérer les valeurs modifiées
    const updatedName = document.getElementById('edit-payment-student-name').value;
    const updatedClass = document.getElementById('edit-payment-student-class').value;
    const updatedType = document.getElementById('edit-payment-student-type').value;
    const monthsString = document.getElementById('edit-payment-months').value;
    const updatedPaymentType = document.getElementById('edit-payment-type').value;
    const updatedAmount = parseFloat(document.getElementById('edit-payment-amount').value) || 0;
    
    // Convertir la chaîne de mois en tableau
    const updatedMonths = monthsString.split(',').map(m => m.trim());
    
    try {
        const batch = writeBatch(db);
        
        // Mettre à jour la demande de paiement
        batch.update(doc(db, 'payment_requests', foundRequest.id), { 
            studentName: updatedName,
            studentClass: updatedClass,
            studentType: updatedType,
            months: updatedMonths,
            paymentType: updatedPaymentType,
            amount: updatedAmount,
            status: 'paid',
            validatedAt: serverTimestamp(),
            validatedBy: currentSecretary.uid
        });

        // Créer les paiements individuels
        updatedMonths.forEach(month => {
            const paymentDocRef = doc(collection(db, 'payments'));
            batch.set(paymentDocRef, {
                studentId: foundRequest.data().studentId,
                studentName: updatedName,
                studentClass: updatedClass,
                studentType: updatedType,
                month: month,
                paymentType: updatedPaymentType,
                amount: updatedAmount / updatedMonths.length,
                validatedBy: currentSecretary.uid,
                validatedAt: serverTimestamp(),
                createdAt: serverTimestamp(),
                paymentMethod: 'online'
            });
        });

        await batch.commit();
        
        // Générer le reçu
        await generateReceipt(updatedName, updatedMonths, updatedAmount, foundRequest.data().paymentCode, updatedClass, updatedPaymentType);
        
        showAlert('Paiement validé avec succès !', 'success');
        document.getElementById('payment-details-card').classList.add('hidden');
        document.getElementById('edit-payment-form').classList.add('hidden');
        document.getElementById('payment-code-input').value = '';
        foundRequest = null;
        
        // Mettre à jour les listes
        loadDashboardStats();
        loadFeesData();
        
    } catch (error) {
        showAlert('Erreur de validation: ' + error.message, 'error');
    }
});

document.getElementById('cancel-edit-payment-btn').addEventListener('click', () => {
    document.getElementById('payment-details-card').classList.add('hidden');
    document.getElementById('edit-payment-form').classList.add('hidden');
    document.getElementById('payment-code-input').value = '';
    foundRequest = null;
});

// Supprimer l'affichage automatique des paiements en attente
async function loadPendingPaymentsList() {
    const listEl = document.getElementById('pending-payments-list');
    if (listEl) {
        listEl.innerHTML = ''; // Vider la liste
    }
}

// --- Paiements sur place (CORRIGÉ AVEC FILTRE DES MOIS ET STATISTIQUES) ---
function setupPaymentForm() {
    const studentIdInput = document.getElementById('onsite-student-id');
    const studentTypeSelect = document.getElementById('onsite-student-type');
    const monthlyAmountInput = document.getElementById('onsite-monthly-amount');
    const paymentTypeSelect = document.getElementById('onsite-payment-type');
    
    // Créer un conteneur pour les statistiques de paiement s'il n'existe pas déjà
    if (!document.getElementById('payment-stats-container')) {
        const paymentStatsHTML = `
            <div id="payment-stats-container" class="card hidden" style="margin-top: 1rem;">
                <h5>Statistiques de paiement de l'élève</h5>
                <div class="fees-summary" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="fees-summary-card">
                        <h4>Total payé</h4>
                        <p id="student-total-paid" class="currency-display">$0.00</p>
                    </div>
                    <div class="fees-summary-card">
                        <h4>Mois payés</h4>
                        <p id="student-months-count">0</p>
                    </div>
                    <div class="fees-summary-card">
                        <h4>Mois restants</h4>
                        <p id="student-months-remaining">12</p>
                    </div>
                </div>
                <div class="table-container" style="max-height: 200px; overflow-y: auto;">
                    <table id="student-payments-history" style="font-size: 0.9rem;">
                        <thead>
                            <tr>
                                <th>Mois</th>
                                <th>Type de frais</th>
                                <th>Montant</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody id="student-payments-body">
                            <tr><td colspan="4" style="text-align: center;">Aucun paiement trouvé</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        
        // Insérer après le formulaire
        document.getElementById('onsite-payment-form').insertAdjacentHTML('afterend', paymentStatsHTML);
    }
    
    studentIdInput.addEventListener('blur', async () => {
        const matricule = studentIdInput.value.trim();
        if (!matricule) return;
        
        try {
            let studentDoc;
            let studentData;
            
            if (studentTypeSelect.value === 'secondary') {
                studentDoc = await getDoc(doc(db, 'students', matricule));
            } else if (studentTypeSelect.value === 'primary') {
                studentDoc = await getDoc(doc(db, 'primary_students', matricule));
            } else {
                studentDoc = await getDoc(doc(db, 'kindergarten_students', matricule));
            }
            
            if (studentDoc.exists()) {
                studentData = studentDoc.data();
                document.getElementById('onsite-student-name').value = studentData.fullName;
                document.getElementById('onsite-student-class').value = studentData.class;
                
                // Récupérer tous les paiements de l'élève
                const paymentsSnap = await getDocs(query(
                    collection(db, 'payments'), 
                    where('studentId', '==', matricule)
                ));
                
                const studentPayments = [];
                paymentsSnap.forEach(doc => {
                    studentPayments.push({ id: doc.id, ...doc.data() });
                });
                
                // Afficher les statistiques de paiement
                displayPaymentStats(studentData, studentPayments);
                
                // Générer les checkboxes pour les mois en fonction du type de frais sélectionné
                generateFilteredMonthCheckboxes(studentPayments, paymentTypeSelect.value);
            } else {
                document.getElementById('onsite-student-name').value = '';
                document.getElementById('onsite-student-class').value = '';
                document.getElementById('onsite-amount').value = '';
                document.getElementById('payment-stats-container').classList.add('hidden');
                showAlert("Aucun élève trouvé avec ce matricule", "error");
            }
        } catch (error) {
            console.error("Erreur recherche élève:", error);
        }
    });
    
    // Mettre à jour les mois quand le type de paiement change
    paymentTypeSelect.addEventListener('change', async () => {
        const matricule = document.getElementById('onsite-student-id').value.trim();
        if (!matricule) return;
        
        try {
            // Récupérer les paiements de l'élève
            const paymentsSnap = await getDocs(query(
                collection(db, 'payments'), 
                where('studentId', '==', matricule)
            ));
            
            const studentPayments = [];
            paymentsSnap.forEach(doc => {
                studentPayments.push({ id: doc.id, ...doc.data() });
            });
            
            // Mettre à jour les checkboxes
            generateFilteredMonthCheckboxes(studentPayments, paymentTypeSelect.value);
        } catch (error) {
            console.error("Erreur lors du filtrage des mois:", error);
        }
    });
    
    // Gérer l'affichage du champ de spécification pour "Autres"
    paymentTypeSelect.addEventListener('change', function() {
        const otherSpec = document.getElementById('onsite-payment-other');
        if (this.value === 'Autres') {
            otherSpec.style.display = 'block';
            otherSpec.required = true;
        } else {
            otherSpec.style.display = 'none';
            otherSpec.required = false;
            otherSpec.value = '';
        }
    });
    
    // Calcul automatique du montant total
    monthlyAmountInput.addEventListener('input', updateTotalAmount);
}

// Fonction pour afficher les statistiques de paiement de l'élève
function displayPaymentStats(studentData, payments) {
    const statsContainer = document.getElementById('payment-stats-container');
    const totalPaidEl = document.getElementById('student-total-paid');
    const monthsCountEl = document.getElementById('student-months-count');
    const monthsRemainingEl = document.getElementById('student-months-remaining');
    const paymentsBody = document.getElementById('student-payments-body');
    
    // Filtrer uniquement les frais scolaires
    const schoolFeesPayments = payments.filter(p => p.paymentType === 'Frais scolaires');
    
    // Calculer le total payé
    const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
    totalPaidEl.textContent = `$${totalPaid.toFixed(2)}`;
    
    // Compter les mois payés (pour les frais scolaires)
    const paidMonths = schoolFeesPayments.map(p => p.month);
    const uniquePaidMonths = [...new Set(paidMonths)];
    monthsCountEl.textContent = uniquePaidMonths.length;
    
    // Mois restants (total 12 mois)
    const remainingMonths = 12 - uniquePaidMonths.length;
    monthsRemainingEl.textContent = remainingMonths;
    
    // Générer le tableau des paiements
    if (payments.length > 0) {
        // Trier par date (du plus récent au plus ancien)
        const sortedPayments = payments.sort((a, b) => {
            const dateA = a.validatedAt?.toDate?.() || new Date(0);
            const dateB = b.validatedAt?.toDate?.() || new Date(0);
            return dateB - dateA;
        });
        
        let html = '';
        sortedPayments.forEach(payment => {
            const paymentDate = payment.validatedAt?.toDate?.() 
                ? formatDate(payment.validatedAt.toDate()) 
                : 'Date inconnue';
            
            const monthDisplay = payment.month === 'inscription' 
                ? 'Inscription' 
                : payment.month;
            
            html += `
                <tr>
                    <td>${monthDisplay}</td>
                    <td>${payment.paymentType || 'Frais scolaires'}</td>
                    <td class="currency-display">$${payment.amount.toFixed(2)}</td>
                    <td>${paymentDate}</td>
                </tr>
            `;
        });
        paymentsBody.innerHTML = html;
    } else {
        paymentsBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Aucun paiement trouvé</td></tr>';
    }
    
    statsContainer.classList.remove('hidden');
}

// Fonction modifiée pour générer les checkboxes avec filtrage
function generateFilteredMonthCheckboxes(payments, selectedPaymentType) {
    const container = document.getElementById('onsite-months-container');
    const months = [
        'janvier', 'février', 'mars', 'avril', 'mai', 'juin',
        'juillet', 'août', 'septembre', 'octobre', 'novembre', 'décembre'
    ];
    
    // Récupérer les mois déjà payés pour le type de frais sélectionné
    let paidMonths = [];
    if (selectedPaymentType === 'Frais scolaires') {
        paidMonths = payments
            .filter(p => p.paymentType === 'Frais scolaires')
            .map(p => p.month);
    } else if (selectedPaymentType === 'Frais de l\'état') {
        paidMonths = payments
            .filter(p => p.paymentType === 'Frais de l\'état')
            .map(p => p.month);
    } else if (selectedPaymentType === 'visite') {
        paidMonths = payments
            .filter(p => p.paymentType === 'visite')
            .map(p => p.month);
    } else if (selectedPaymentType === 'achat pull') {
        paidMonths = payments
            .filter(p => p.paymentType === 'achat pull')
            .map(p => p.month);
    } else if (selectedPaymentType && selectedPaymentType !== '') {
        // Pour les autres types, on vérifie aussi
        paidMonths = payments
            .filter(p => p.paymentType === selectedPaymentType)
            .map(p => p.month);
    }
    
    let html = '';
    months.forEach(month => {
        const isPaid = paidMonths.includes(month);
        
        if (isPaid) {
            // Mois déjà payé - afficher comme désactivé avec indication
            html += `
                <div class="month-checkbox" style="opacity: 0.5;">
                    <input type="checkbox" id="month-${month}" value="${month}" class="month-checkbox-input" disabled>
                    <label for="month-${month}">${month} <span style="color: var(--success); font-size: 0.8rem;">(déjà payé)</span></label>
                </div>
            `;
        } else {
            // Mois non payé - normal
            html += `
                <div class="month-checkbox">
                    <input type="checkbox" id="month-${month}" value="${month}" class="month-checkbox-input">
                    <label for="month-${month}">${month}</label>
                </div>
            `;
        }
    });
    
    container.innerHTML = html;
    
    // Ajouter l'écouteur d'événements pour le calcul du montant total
    document.querySelectorAll('.month-checkbox-input:not([disabled])').forEach(checkbox => {
        checkbox.addEventListener('change', updateTotalAmount);
    });
    
    // Ajouter un message récapitulatif
    if (paidMonths.length > 0) {
        const summaryHTML = `
            <div style="margin-top: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px; font-size: 0.9rem;">
                <strong>Mois déjà payés pour "${selectedPaymentType || 'Frais scolaires'}" :</strong> 
                ${paidMonths.join(', ')}
            </div>
        `;
        
        // Supprimer l'ancien résumé s'il existe
        const oldSummary = container.querySelector('.paid-months-summary');
        if (oldSummary) oldSummary.remove();
        
        // Ajouter le nouveau résumé
        const summaryDiv = document.createElement('div');
        summaryDiv.className = 'paid-months-summary';
        summaryDiv.innerHTML = summaryHTML;
        container.appendChild(summaryDiv);
    }
}

        // --- Gestion des Frais (CORRIGÉE) ---
        async function loadFeesClasses() {
            const selectEl = document.getElementById('fees-class');
            selectEl.innerHTML = '<option value="">Toutes les classes</option>';
            
            try {
                // Classes secondaires
                const classesSnap = await getDocs(collection(db, 'classes'));
                classesSnap.forEach(doc => {
                    const data = doc.data();
                    selectEl.innerHTML += `<option value="${data.name}">${data.name}</option>`;
                });
                
                // Classes primaires
                const primaryClassesSnap = await getDocs(collection(db, 'primary_classes'));
                primaryClassesSnap.forEach(doc => {
                    const data = doc.data();
                    selectEl.innerHTML += `<option value="${data.name}">${data.name}</option>`;
                });
                
                // Classes maternelles
                const kindergartenClassesSnap = await getDocs(collection(db, 'kindergarten_classes'));
                kindergartenClassesSnap.forEach(doc => {
                    const data = doc.data();
                    selectEl.innerHTML += `<option value="${data.name}">${data.name}</option>`;
                });
            } catch (error) {
                console.error("Erreur chargement classes pour frais:", error);
            }
        }

        document.getElementById('load-fees-btn').addEventListener('click', async () => {
            await loadFeesData();
        });

        // Recherche dans la gestion des frais
        document.getElementById('fees-search').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const activeTab = document.querySelector('.tab.active').dataset.tab;
            const rows = document.querySelectorAll(`#${activeTab}-students-list tr`);
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });

        // Remplacer la fonction loadFeesData() actuelle par cette version améliorée
async function loadFeesData() {
    const selectedStudentType = document.getElementById('fees-student-type').value;
    const selectedClass = document.getElementById('fees-class').value;
    const selectedMonth = document.getElementById('fees-month').value;
    const selectedType = document.getElementById('fees-type').value;
    
    try {
        let studentsList = [];
        
        // Récupérer TOUS les élèves d'abord, puis filtrer localement
        if (selectedStudentType === 'all' || selectedStudentType === 'secondary') {
            const studentsSnap = await getDocs(collection(db, 'students'));
            studentsSnap.forEach(doc => {
                const data = doc.data();
                // Filtrer par statut localement
                if (data.status !== 'deleted') {
                    // Filtrer par classe localement si sélectionnée
                    if (!selectedClass || data.class === selectedClass) {
                        studentsList.push({...data, studentType: 'secondary'});
                    }
                }
            });
        }
        
        if (selectedStudentType === 'all' || selectedStudentType === 'primary') {
            const primaryStudentsSnap = await getDocs(collection(db, 'primary_students'));
            primaryStudentsSnap.forEach(doc => {
                const data = doc.data();
                if (data.status !== 'deleted') {
                    if (!selectedClass || data.class === selectedClass) {
                        studentsList.push({...data, studentType: 'primary'});
                    }
                }
            });
        }
        
        if (selectedStudentType === 'all' || selectedStudentType === 'kindergarten') {
            const kindergartenStudentsSnap = await getDocs(collection(db, 'kindergarten_students'));
            kindergartenStudentsSnap.forEach(doc => {
                const data = doc.data();
                if (data.status !== 'deleted') {
                    if (!selectedClass || data.class === selectedClass) {
                        studentsList.push({...data, studentType: 'kindergarten'});
                    }
                }
            });
        }
        
        // Récupérer TOUS les paiements d'abord, puis filtrer localement
        let allPayments = [];
        const paymentsSnap = await getDocs(collection(db, 'payments'));
        paymentsSnap.forEach(doc => {
            allPayments.push({ id: doc.id, ...doc.data() });
        });
        
        // Filtrer les paiements localement
        let filteredPayments = allPayments;
        
        // Si le mois sélectionné est "inscription", filtrer spécifiquement
        if (selectedMonth && selectedMonth !== 'all') {
            if (selectedMonth === 'inscription') {
                filteredPayments = filteredPayments.filter(payment => 
                    payment.month === 'inscription'
                );
            } else {
                filteredPayments = filteredPayments.filter(payment => 
                    payment.month === selectedMonth
                );
            }
        }
        
        // Filtrer par type de frais
        if (selectedType && selectedType !== 'all') {
            filteredPayments = filteredPayments.filter(payment => 
                payment.paymentType === selectedType
            );
        }
        
        // Organiser les paiements par étudiant
        const studentPayments = {};
        const studentPaidMonths = {};
        const studentAmounts = {};
        
        filteredPayments.forEach(payment => {
            const studentId = payment.studentId;
            
            if (!studentPayments[studentId]) {
                studentPayments[studentId] = [];
                studentPaidMonths[studentId] = [];
                studentAmounts[studentId] = 0;
            }
            
            studentPayments[studentId].push(payment);
            studentPaidMonths[studentId].push(payment.month);
            studentAmounts[studentId] += payment.amount;
        });
        
        // Pour les frais d'inscription, nous devons aussi considérer les frais d'inscription des étudiants
        // qui pourraient ne pas avoir de paiement enregistré dans la collection 'payments'
        if (selectedMonth === 'inscription' || selectedType === 'Frais d\'inscription') {
            studentsList.forEach(student => {
                const studentId = student.matricule;
                const enrollmentFees = student.enrollmentFees || 0;
                
                // Si l'étudiant a des frais d'inscription
                if (enrollmentFees > 0) {
                    // Ajouter un paiement virtuel pour les frais d'inscription
                    if (!studentPayments[studentId]) {
                        studentPayments[studentId] = [];
                        studentPaidMonths[studentId] = [];
                        studentAmounts[studentId] = 0;
                    }
                    
                    // Vérifier si un paiement pour l'inscription existe déjà
                    const hasInscriptionPayment = studentPayments[studentId].some(p => 
                        p.paymentType === 'Frais d\'inscription'
                    );
                    
                    if (!hasInscriptionPayment && enrollmentFees > 0) {
                        studentPayments[studentId].push({
                            paymentType: 'Frais d\'inscription',
                            amount: enrollmentFees,
                            month: 'inscription',
                            studentId: studentId,
                            studentName: student.fullName,
                            studentClass: student.class,
                            studentType: student.studentType
                        });
                        studentPaidMonths[studentId].push('inscription');
                        studentAmounts[studentId] += enrollmentFees;
                    }
                }
            });
        }
        
        // Calculer les statistiques
        const totalStudents = studentsList.length;
        let paidCount = 0;
        let unpaidCount = 0;
        let totalAmount = 0;
        
        // Analyser chaque étudiant
        studentsList.forEach(student => {
            const studentId = student.matricule;
            const payments = studentPayments[studentId] || [];
            const hasPayment = payments.length > 0;
            
            if (hasPayment) {
                // Vérifier si l'étudiant a payé selon les filtres
                if (selectedMonth && selectedMonth !== 'all') {
                    const paidForSelected = studentPaidMonths[studentId]?.includes(selectedMonth);
                    if (paidForSelected) {
                        paidCount++;
                        totalAmount += studentAmounts[studentId] || 0;
                    } else {
                        unpaidCount++;
                    }
                } else if (selectedType && selectedType !== 'all') {
                    const paidForSelectedType = payments.some(p => p.paymentType === selectedType);
                    if (paidForSelectedType) {
                        paidCount++;
                        totalAmount += studentAmounts[studentId] || 0;
                    } else {
                        unpaidCount++;
                    }
                } else {
                    // Pour "Tous", considérer comme payé s'il a au moins un paiement
                    paidCount++;
                    totalAmount += studentAmounts[studentId] || 0;
                }
            } else {
                unpaidCount++;
            }
        });
        
        const paymentRate = totalStudents > 0 ? Math.round((paidCount / totalStudents) * 100) : 0;
        
        // Mettre à jour les statistiques
        document.getElementById('total-students-fees').textContent = totalStudents;
        document.getElementById('paid-students').textContent = paidCount;
        document.getElementById('unpaid-students').textContent = unpaidCount;
        document.getElementById('payment-rate').textContent = paymentRate + '%';
        
        // Mettre à jour les listes d'élèves
        updateFeesStudentsLists(studentsList, studentPayments, studentPaidMonths, studentAmounts, selectedMonth, selectedType);
        
    } catch (error) {
        console.error("Erreur chargement données frais:", error);
        showAlert('Erreur lors du chargement des données: ' + error.message, 'error');
    }
}

function updateTotalAmount() {
    const selectedMonths = document.querySelectorAll('.month-checkbox-input:not([disabled]):checked');
    const monthlyAmount = parseFloat(document.getElementById('onsite-monthly-amount').value) || 0;
    const totalAmount = selectedMonths.length * monthlyAmount;
    document.getElementById('onsite-amount').value = totalAmount.toFixed(2);
}

// Version corrigée de updateFeesStudentsLists (même que précédente, gardez-la)
async function updateFeesStudentsLists(studentsList, studentPayments, studentPaidMonths, studentAmounts, selectedMonth, selectedType) {
    const unpaidList = document.getElementById('unpaid-students-list');
    const paidList = document.getElementById('paid-students-list');
    const allList = document.getElementById('all-students-list');
    
    let unpaidHTML = '';
    let paidHTML = '';
    let allHTML = '';
    
    for (const student of studentsList) {
        const studentId = student.matricule;
        const payments = studentPayments[studentId] || [];
        const paidMonths = studentPaidMonths[studentId] || [];
        const amountPaid = studentAmounts[studentId] || 0;
        const enrollmentFees = student.enrollmentFees || 0;
        
        const studentTypeText = student.studentType === 'secondary' ? 'Secondaire' : 
                              student.studentType === 'primary' ? 'Primaire' : 'Maternelle';
        
        // Déterminer si l'élève a payé selon les filtres
        let hasPaidForFilter = false;
        
        if (selectedMonth && selectedMonth !== 'all') {
            if (selectedMonth === 'inscription') {
                // Vérifier les frais d'inscription
                const hasInscriptionPayment = payments.some(p => 
                    p.paymentType === 'Frais d\'inscription' || 
                    p.month === 'inscription'
                );
                hasPaidForFilter = hasInscriptionPayment || enrollmentFees > 0;
            } else {
                hasPaidForFilter = paidMonths.includes(selectedMonth);
            }
        } else if (selectedType && selectedType !== 'all') {
            if (selectedType === 'Frais d\'inscription') {
                const hasInscriptionPayment = payments.some(p => 
                    p.paymentType === 'Frais d\'inscription'
                );
                hasPaidForFilter = hasInscriptionPayment || enrollmentFees > 0;
            } else {
                hasPaidForFilter = payments.some(p => p.paymentType === selectedType);
            }
        } else {
            hasPaidForFilter = payments.length > 0;
        }
        
        // Obtenir le dernier paiement
        let lastPaymentDate = null;
        let lastPaymentType = '';
        if (payments.length > 0) {
            const sortedPayments = payments.sort((a, b) => 
                (b.validatedAt?.toDate?.() || 0) - (a.validatedAt?.toDate?.() || 0)
            );
            lastPaymentDate = sortedPayments[0]?.validatedAt;
            lastPaymentType = sortedPayments[0]?.paymentType;
        }
        
        // Pour les frais d'inscription non payés, afficher le montant dû
        const inscriptionDue = enrollmentFees - 
            (payments.filter(p => p.paymentType === 'Frais d\'inscription')
                .reduce((sum, p) => sum + p.amount, 0));
        
        // Déterminer le type de frais à afficher
        let displayFeeType = selectedType && selectedType !== 'all' ? selectedType : 'Tous';
        if (selectedMonth === 'inscription') {
            displayFeeType = 'Frais d\'inscription';
        }
        
        // Déterminer le montant à afficher
        let displayAmount = amountPaid;
        if (selectedType === 'Frais d\'inscription' || selectedMonth === 'inscription') {
            displayAmount = payments
                .filter(p => p.paymentType === 'Frais d\'inscription' || p.month === 'inscription')
                .reduce((sum, p) => sum + p.amount, 0);
        }
        
        const unpaidRowHTML = `
            <tr>
                <td>${student.matricule}</td>
                <td>${student.fullName}</td>
                <td>${studentTypeText}</td>
                <td>${student.class}</td>
                <td>${displayFeeType}</td>
                <td class="currency-display">$${displayAmount.toFixed(2)}</td>
                <td>${selectedMonth && selectedMonth !== 'all' ? selectedMonth : 'Tous'}</td>
                <td class="action-buttons">
                    <button class="btn btn-primary" onclick="viewStudentDetails('${student.matricule}', '${student.studentType}')">Détails</button>
                    ${inscriptionDue > 0 ? `
                    <button class="btn btn-success" onclick="processInscriptionPayment('${student.matricule}', '${student.studentType}', '${student.fullName}', '${student.class}', ${inscriptionDue})">
                        Payer Inscription
                    </button>
                    ` : ''}
                </td>
            </tr>
        `;
        
        const paidRowHTML = `
            <tr>
                <td>${student.matricule}</td>
                <td>${student.fullName}</td>
                <td>${studentTypeText}</td>
                <td>${student.class}</td>
                <td>${lastPaymentType || 'Frais scolaires'}</td>
                <td class="currency-display">$${displayAmount.toFixed(2)}</td>
                <td>${formatDate(lastPaymentDate?.toDate())}</td>
                <td class="action-buttons">
                    <button class="btn btn-primary" onclick="viewStudentDetails('${student.matricule}', '${student.studentType}')">Détails</button>
                </td>
            </tr>
        `;
        
        const allRowHTML = `
            <tr>
                <td>${student.matricule}</td>
                <td>${student.fullName}</td>
                <td>${studentTypeText}</td>
                <td>${student.class}</td>
                <td>${lastPaymentType || 'Aucun'}</td>
                <td class="currency-display">$${displayAmount.toFixed(2)}</td>
                <td>${hasPaidForFilter ? '<span class="badge badge-success">Payé</span>' : '<span class="badge badge-danger">Non payé</span>'}</td>
                <td class="action-buttons">
                    <button class="btn btn-primary" onclick="viewStudentDetails('${student.matricule}', '${student.studentType}')">Détails</button>
                    ${!hasPaidForFilter ? `
                    <button class="btn btn-success" onclick="processPaymentForStudent('${student.matricule}', '${student.studentType}', '${student.fullName}', '${student.class}')">
                        Payer
                    </button>
                    ` : ''}
                </td>
            </tr>
        `;
        
        if (hasPaidForFilter) {
            paidHTML += paidRowHTML;
        } else {
            unpaidHTML += unpaidRowHTML;
        }
        
        allHTML += allRowHTML;
    }
    
    unpaidList.innerHTML = unpaidHTML || '<tr><td colspan="8" style="text-align: center;">Aucun élève non payé</td></tr>';
    paidList.innerHTML = paidHTML || '<tr><td colspan="8" style="text-align: center;">Aucun élève en ordre</td></tr>';
    allList.innerHTML = allHTML || '<tr><td colspan="8" style="text-align: center;">Aucun élève trouvé</td></tr>';
}



// Fonction pour traiter le paiement des frais d'inscription
window.processInscriptionPayment = async (studentMatricule, studentType, studentName, studentClass, amountDue) => {
    if (confirm(`Payer les frais d'inscription de $${amountDue.toFixed(2)} pour ${studentName} ?`)) {
        try {
            const paymentData = {
                studentId: studentMatricule,
                studentName: studentName,
                studentClass: studentClass,
                studentType: studentType,
                month: 'inscription',
                paymentType: 'Frais d\'inscription',
                amount: amountDue,
                validatedBy: currentSecretary.uid,
                validatedAt: serverTimestamp(),
                createdAt: serverTimestamp(),
                paymentMethod: 'onsite',
                description: 'Frais d\'inscription pour l\'année scolaire'
            };
            
            const paymentRef = doc(collection(db, 'payments'));
            await setDoc(paymentRef, paymentData);
            
            // Générer le reçu
            await generateReceipt(studentName, ['inscription'], amountDue, 'INSCRIPTION-' + generatePaymentCode(), studentClass, 'Frais d\'inscription');
            
            showAlert(`Paiement des frais d'inscription enregistré avec succès !`, 'success');
            
            // Recharger les données
            loadFeesData();
            loadDashboardStats();
            
        } catch (error) {
            console.error("Erreur paiement inscription:", error);
            showAlert('Erreur lors du paiement: ' + error.message, 'error');
        }
    }
};

        // Fonction pour traiter le paiement d'un étudiant directement depuis la gestion des frais
        window.processPaymentForStudent = async (studentMatricule, studentType, studentName, studentClass) => {
            // Remplir automatiquement le formulaire de paiement
            document.getElementById('onsite-student-id').value = studentMatricule;
            document.getElementById('onsite-student-type').value = studentType;
            document.getElementById('onsite-student-name').value = studentName;
            document.getElementById('onsite-student-class').value = studentClass;
            
            // Générer les mois
            generateMonthCheckboxes();
            
            // Naviguer vers la page de paiement
            document.querySelectorAll('.nav-menu a, .page').forEach(el => el.classList.remove('active'));
            document.querySelector('.nav-menu a[data-page="validate-payment"]').classList.add('active');
            document.getElementById('validate-payment-page').classList.add('active');
            document.getElementById('page-title').textContent = 'Valider Paiement';
            
            // Focus sur le montant mensuel
            document.getElementById('onsite-monthly-amount').focus();
        };

        // --- Statistiques Élèves (NOUVELLE VERSION) ---
        async function loadStudentsList() {
            try {
                // Charger les statistiques par classe
                await loadClassStats();
                
                // Remplir la liste des classes pour l'export
                await populateExportClassSelect();
                
            } catch (error) {
                console.error("Erreur chargement statistiques élèves:", error);
                showAlert("Erreur lors du chargement des statistiques", "error");
            }
        }

        async function loadClassStats() {
    const container = document.getElementById('class-stats-container');
    container.innerHTML = '<p>Chargement des statistiques...</p>';
    
    try {
        // Récupérer toutes les classes
        const secondaryClassesSnap = await getDocs(collection(db, 'classes'));
        const primaryClassesSnap = await getDocs(collection(db, 'primary_classes'));
        const kindergartenClassesSnap = await getDocs(collection(db, 'kindergarten_classes'));
        
        let allClasses = [];
        
        // Classes secondaires
        secondaryClassesSnap.forEach(doc => {
            const data = doc.data();
            allClasses.push({...data, type: 'secondary'});
        });
        
        // Classes primaires
        primaryClassesSnap.forEach(doc => {
            const data = doc.data();
            allClasses.push({...data, type: 'primary'});
        });
        
        // Classes maternelles
        kindergartenClassesSnap.forEach(doc => {
            const data = doc.data();
            allClasses.push({...data, type: 'kindergarten'});
        });
        
        if (allClasses.length === 0) {
            container.innerHTML = '<p>Aucune classe trouvée</p>';
            return;
        }
        
        let html = '';
        
        for (const classData of allClasses) {
            // Compter les élèves dans cette classe - NOUVELLE APPROCHE
            let studentCount = 0;
            let studentsList = [];
            
            if (classData.type === 'secondary') {
                // Récupérer tous les élèves secondaires puis filtrer localement
                const studentsSnap = await getDocs(collection(db, 'students'));
                studentsSnap.forEach(doc => {
                    const data = doc.data();
                    if (data.class === classData.name && data.status !== 'deleted') {
                        studentCount++;
                        studentsList.push(data);
                    }
                });
            } else if (classData.type === 'primary') {
                const studentsSnap = await getDocs(collection(db, 'primary_students'));
                studentsSnap.forEach(doc => {
                    const data = doc.data();
                    if (data.class === classData.name && data.status !== 'deleted') {
                        studentCount++;
                        studentsList.push(data);
                    }
                });
            } else {
                const studentsSnap = await getDocs(collection(db, 'kindergarten_students'));
                studentsSnap.forEach(doc => {
                    const data = doc.data();
                    if (data.class === classData.name && data.status !== 'deleted') {
                        studentCount++;
                        studentsList.push(data);
                    }
                });
            }
            
            const typeText = classData.type === 'secondary' ? 'Secondaire' : 
                           classData.type === 'primary' ? 'Primaire' : 'Maternelle';
            
            html += `
                <div class="class-stat-card">
                    <div class="class-stat-header">
                        <h5>${classData.name}</h5>
                        <span class="badge ${classData.type === 'secondary' ? 'badge-primary' : classData.type === 'primary' ? 'badge-success' : 'badge-info'}">${typeText}</span>
                    </div>
                    <p><strong>Niveau:</strong> ${classData.level || 'Non spécifié'}</p>
                    <p><strong>Capacité:</strong> ${classData.capacity || 'Non spécifié'}</p>
                    <p><strong>Élèves inscrits:</strong> ${studentCount}</p>
                    
                    <div class="class-students-list">
                        <h6>Liste des élèves (${studentCount})</h6>
                        ${studentsList.length > 0 ? 
                            studentsList.map(student => `
                                <div class="class-student-item">
                                    <span>${student.fullName}</span>
                                    <span>${student.matricule}</span>
                                </div>
                            `).join('') : 
                            '<p>Aucun élève dans cette classe</p>'
                        }
                    </div>
                    
                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary btn-sm" onclick="exportClassStudents('${classData.name}', '${classData.type}')">
                            <i class="fas fa-download"></i> Exporter
                        </button>
                        <button class="btn btn-info btn-sm" onclick="viewClassDetails('${classData.name}', '${classData.type}')">
                            <i class="fas fa-eye"></i> Détails
                        </button>
                    </div>
                </div>
            `;
        }
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error("Erreur chargement statistiques classes:", error);
        container.innerHTML = '<p>Erreur lors du chargement des statistiques</p>';
    }
}

// --- Recherche des Élèves pour modification (AJOUTEZ CE CODE) ---
document.getElementById('search-student-btn').addEventListener('click', async () => {
    const searchTerm = document.getElementById('search-student-modify').value.trim();
    const searchType = document.getElementById('search-student-type').value;
    
    if (!searchTerm) {
        showAlert("Veuillez entrer un matricule ou un nom", "error");
        return;
    }
    
    const resultsContainer = document.getElementById('student-search-results');
    resultsContainer.innerHTML = '<p>Recherche en cours...</p>';
    
    try {
        let students = [];
        const searchTermLower = searchTerm.toLowerCase();
        
        // Rechercher dans les élèves secondaires
        if (searchType === 'all' || searchType === 'secondary') {
            const studentsSnap = await getDocs(query(collection(db, 'students'), where('status', '!=', 'deleted')));
            studentsSnap.forEach(doc => {
                const data = doc.data();
                if (data.matricule.toLowerCase().includes(searchTermLower) || 
                    data.fullName.toLowerCase().includes(searchTermLower)) {
                    students.push({...data, type: 'secondary', docId: doc.id});
                }
            });
        }
        
        // Rechercher dans les élèves primaires
        if (searchType === 'all' || searchType === 'primary') {
            const studentsSnap = await getDocs(query(collection(db, 'primary_students'), where('status', '!=', 'deleted')));
            studentsSnap.forEach(doc => {
                const data = doc.data();
                if (data.matricule.toLowerCase().includes(searchTermLower) || 
                    data.fullName.toLowerCase().includes(searchTermLower)) {
                    students.push({...data, type: 'primary', docId: doc.id});
                }
            });
        }
        
        // Rechercher dans les élèves maternelles
        if (searchType === 'all' || searchType === 'kindergarten') {
            const studentsSnap = await getDocs(query(collection(db, 'kindergarten_students'), where('status', '!=', 'deleted')));
            studentsSnap.forEach(doc => {
                const data = doc.data();
                if (data.matricule.toLowerCase().includes(searchTermLower) || 
                    data.fullName.toLowerCase().includes(searchTermLower)) {
                    students.push({...data, type: 'kindergarten', docId: doc.id});
                }
            });
        }
        
        // Remplacer la section des résultats de recherche dans la fonction search-student-btn
// Recherchez cette partie dans le code (vers la ligne 8800 environ) :

if (students.length === 0) {
    resultsContainer.innerHTML = '<p>Aucun élève trouvé</p>';
    return;
}

let html = '<div class="table-container"><table><thead><tr><th>Matricule</th><th>Nom</th><th>Type</th><th>Classe</th><th>Téléphone Parent</th><th>Actions</th></tr></thead><tbody>';

students.forEach(student => {
    const typeText = student.type === 'secondary' ? 'Secondaire' : 
                   student.type === 'primary' ? 'Primaire' : 'Maternelle';
    
    html += `
        <tr>
            <td>${student.matricule}</td>
            <td>${student.fullName}</td>
            <td>${typeText}</td>
            <td>${student.class}</td>
            <td>${student.parentPhone || ''}</td>
            <td class="action-buttons" style="min-width: 200px;">
                <button class="btn btn-primary btn-sm" onclick="viewStudentDetails('${student.matricule}', '${student.type}')">
                    <i class="fas fa-eye"></i> Détails
                </button>
                <button class="btn btn-warning btn-sm" onclick="editStudent('${student.matricule}', '${student.type}')">
                    <i class="fas fa-edit"></i> Modifier
                </button>
                <button class="btn btn-danger btn-sm" onclick="deleteStudent('${student.matricule}', '${student.type}')">
                    <i class="fas fa-trash"></i> Supprimer
                </button>
                <button class="btn btn-success btn-sm" onclick="printStudentCard('${student.matricule}', '${student.type}')">
                    <i class="fas fa-id-card"></i> Carte
                </button>
            </td>
        </tr>
    `;
});

html += '</tbody></table></div>';
resultsContainer.innerHTML = html;
        
    } catch (error) {
        console.error("Erreur recherche élève:", error);
        resultsContainer.innerHTML = '<p>Erreur lors de la recherche</p>';
    }
});
        // Remplacer la fonction populateExportClassSelect() par cette version corrigée
async function populateExportClassSelect() {
    const selectEl = document.getElementById('export-class');
    if (!selectEl) return;
    
    selectEl.innerHTML = '<option value="">Toutes les classes</option>';
    
    try {
        // Classes secondaires
        const secondaryClassesSnap = await getDocs(collection(db, 'classes'));
        secondaryClassesSnap.forEach(doc => {
            const data = doc.data();
            selectEl.innerHTML += `<option value="secondary:${data.name}">${data.name} (Secondaire)</option>`;
        });
        
        // Classes primaires
        const primaryClassesSnap = await getDocs(collection(db, 'primary_classes'));
        primaryClassesSnap.forEach(doc => {
            const data = doc.data();
            selectEl.innerHTML += `<option value="primary:${data.name}">${data.name} (Primaire)</option>`;
        });
        
        // Classes maternelles
        const kindergartenClassesSnap = await getDocs(collection(db, 'kindergarten_classes'));
        kindergartenClassesSnap.forEach(doc => {
            const data = doc.data();
            selectEl.innerHTML += `<option value="kindergarten:${data.name}">${data.name} (Maternelle)</option>`;
        });
    } catch (error) {
        console.error("Erreur remplissage liste classes:", error);
    }
}

// Remplacer la fonction d'export des données élèves par cette version corrigée
document.getElementById('export-data-btn').addEventListener('click', async () => {
    const exportType = document.getElementById('export-type').value;
    const studentType = document.getElementById('export-student-type').value;
    const classFilter = document.getElementById('export-class').value;
    
    try {
        let students = [];
        
        // NOUVELLE APPROCHE : Récupérer tous les élèves puis filtrer localement
        if (studentType === 'all' || studentType === 'secondary') {
            const studentsSnap = await getDocs(collection(db, 'students'));
            studentsSnap.forEach(doc => {
                const data = doc.data();
                // Filtrer par status localement
                if (data.status !== 'deleted') {
                    // Filtrer par classe si spécifié
                    if (classFilter) {
                        const [classType, className] = classFilter.split(':');
                        if (classType === 'secondary' && data.class === className) {
                            students.push({...data, studentType: 'secondary'});
                        }
                    } else {
                        students.push({...data, studentType: 'secondary'});
                    }
                }
            });
        }
        
        if (studentType === 'all' || studentType === 'primary') {
            const studentsSnap = await getDocs(collection(db, 'primary_students'));
            studentsSnap.forEach(doc => {
                const data = doc.data();
                if (data.status !== 'deleted') {
                    if (classFilter) {
                        const [classType, className] = classFilter.split(':');
                        if (classType === 'primary' && data.class === className) {
                            students.push({...data, studentType: 'primary'});
                        }
                    } else {
                        students.push({...data, studentType: 'primary'});
                    }
                }
            });
        }
        
        if (studentType === 'all' || studentType === 'kindergarten') {
            const studentsSnap = await getDocs(collection(db, 'kindergarten_students'));
            studentsSnap.forEach(doc => {
                const data = doc.data();
                if (data.status !== 'deleted') {
                    if (classFilter) {
                        const [classType, className] = classFilter.split(':');
                        if (classType === 'kindergarten' && data.class === className) {
                            students.push({...data, studentType: 'kindergarten'});
                        }
                    } else {
                        students.push({...data, studentType: 'kindergarten'});
                    }
                }
            });
        }
        
        if (students.length === 0) {
            showAlert("Aucun élève à exporter", "warning");
            return;
        }
        
        // Préparer les données pour l'export
        const exportData = students.map(student => ({
            'Matricule': student.matricule,
            'Nom complet': student.fullName,
            'Type': student.studentType === 'secondary' ? 'Secondaire' : 
                   student.studentType === 'primary' ? 'Primaire' : 'Maternelle',
            'Classe': student.class,
            'Date de naissance': student.birthdate,
            'Lieu de naissance': student.birthplace || '',
            'Sexe': student.gender === 'M' ? 'Masculin' : 'Féminin',
            'Adresse': student.address || '',
            'Téléphone': student.phone || '',
            'Frais inscription': student.enrollmentFees || 0,
            'Nom parent': student.parentName,
            'Téléphone parent': student.parentPhone,
            'Adresse parent': student.parentAddress || '',
            'Statut': student.status === 'active' ? 'Actif' : 'Inactif',
            'Date inscription': formatDate(student.createdAt?.toDate())
        }));
        
        // Exporter selon le type choisi
        if (exportType === 'excel') {
            exportToExcel(exportData, 'eleves_cs_lacolombe');
        } else if (exportType === 'csv') {
            exportToCSV(exportData, 'eleves_cs_lacolombe');
        } else if (exportType === 'pdf') {
            exportToPDF(exportData, 'Liste des Élèves - hybrilink');
        }
        
        showAlert(`Export réussi: ${students.length} élève(s) exporté(s)`, "success");
        
    } catch (error) {
        console.error("Erreur export élèves:", error);
        showAlert(`Erreur lors de l'export: ${error.message}`, "error");
    }
});
        // Export des données élèves
        document.getElementById('export-data-btn').addEventListener('click', async () => {
            const exportType = document.getElementById('export-type').value;
            const studentType = document.getElementById('export-student-type').value;
            const classFilter = document.getElementById('export-class').value;
            
            try {
                let students = [];
                
                // Récupérer les élèves selon les filtres
                if (studentType === 'all' || studentType === 'secondary') {
                    let queryConstraints = [where('status', '!=', 'deleted')];
                    
                    if (classFilter) {
                        const [classType, className] = classFilter.split(':');
                        if (classType === 'secondary') {
                            queryConstraints.push(where('class', '==', className));
                        }
                    }
                    
                    const studentsSnap = await getDocs(query(collection(db, 'students'), ...queryConstraints));
                    studentsSnap.forEach(doc => {
                        const data = doc.data();
                        students.push({...data, studentType: 'secondary'});
                    });
                }
                
                if (studentType === 'all' || studentType === 'primary') {
                    let queryConstraints = [where('status', '!=', 'deleted')];
                    
                    if (classFilter) {
                        const [classType, className] = classFilter.split(':');
                        if (classType === 'primary') {
                            queryConstraints.push(where('class', '==', className));
                        }
                    }
                    
                    const studentsSnap = await getDocs(query(collection(db, 'primary_students'), ...queryConstraints));
                    studentsSnap.forEach(doc => {
                        const data = doc.data();
                        students.push({...data, studentType: 'primary'});
                    });
                }
                
                if (studentType === 'all' || studentType === 'kindergarten') {
                    let queryConstraints = [where('status', '!=', 'deleted')];
                    
                    if (classFilter) {
                        const [classType, className] = classFilter.split(':');
                        if (classType === 'kindergarten') {
                            queryConstraints.push(where('class', '==', className));
                        }
                    }
                    
                    const studentsSnap = await getDocs(query(collection(db, 'kindergarten_students'), ...queryConstraints));
                    studentsSnap.forEach(doc => {
                        const data = doc.data();
                        students.push({...data, studentType: 'kindergarten'});
                    });
                }
                
                if (students.length === 0) {
                    showAlert("Aucun élève à exporter", "warning");
                    return;
                }
                
                // Préparer les données pour l'export
                const exportData = students.map(student => ({
                    'Matricule': student.matricule,
                    'Nom complet': student.fullName,
                    'Type': student.studentType === 'secondary' ? 'Secondaire' : 
                           student.studentType === 'primary' ? 'Primaire' : 'Maternelle',
                    'Classe': student.class,
                    'Date de naissance': student.birthdate,
                    'Lieu de naissance': student.birthplace || '',
                    'Sexe': student.gender === 'M' ? 'Masculin' : 'Féminin',
                    'Adresse': student.address || '',
                    'Téléphone': student.phone || '',
                    'Frais inscription': student.enrollmentFees || 0,
                    'Nom parent': student.parentName,
                    'Téléphone parent': student.parentPhone,
                    'Adresse parent': student.parentAddress || '',
                    'Statut': student.status === 'active' ? 'Actif' : 'Inactif',
                    'Date inscription': formatDate(student.createdAt?.toDate())
                }));
                
                // Exporter selon le type choisi
                if (exportType === 'excel') {
                    exportToExcel(exportData, 'eleves_cs_lacolombe');
                } else if (exportType === 'csv') {
                    exportToCSV(exportData, 'eleves_cs_lacolombe');
                } else if (exportType === 'pdf') {
                    exportToPDF(exportData, 'Liste des Élèves - CS la Colombe');
                }
                
                showAlert(`Export réussi: ${students.length} élève(s) exporté(s)`, "success");
                
            } catch (error) {
                console.error("Erreur export élèves:", error);
                showAlert("Erreur lors de l'export", "error");
            }
        });

        // Fonctions d'export
        function exportToExcel(data, filename) {
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Élèves");
            
            // Appliquer des styles de base
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let C = range.s.c; C <= range.e.c; ++C) {
                const address = XLSX.utils.encode_col(C) + "1";
                if (!ws[address]) continue;
                ws[address].s = {
                    font: { bold: true, color: { rgb: "FFFFFF" } },
                    fill: { fgColor: { rgb: "3498DB" } },
                    alignment: { horizontal: "center" }
                };
            }
            
            XLSX.writeFile(wb, `${filename}_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function exportToCSV(data, filename) {
            const headers = Object.keys(data[0]);
            const csvRows = [headers.join(',')];
            
            for (const row of data) {
                const values = headers.map(header => {
                    const escaped = ('' + row[header]).replace(/"/g, '""');
                    return `"${escaped}"`;
                });
                csvRows.push(values.join(','));
            }
            
            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            saveAs(blob, `${filename}_${new Date().toISOString().split('T')[0]}.csv`);
        }

        function exportToPDF(data, title) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');
            
            // Titre
            doc.setFontSize(16);
            doc.text(title, 14, 15);
            doc.setFontSize(10);
            doc.text(`Généré le: ${new Date().toLocaleDateString('fr-FR')}`, 14, 22);
            
            // En-têtes de tableau
            const headers = Object.keys(data[0]);
            const tableData = data.map(row => Object.values(row));
            
            doc.autoTable({
                head: [headers],
                body: tableData,
                startY: 30,
                theme: 'striped',
                headStyles: { fillColor: [52, 152, 219] },
                styles: { fontSize: 8 },
                columnStyles: {
                    0: { cellWidth: 25 },
                    1: { cellWidth: 40 },
                    2: { cellWidth: 20 },
                    3: { cellWidth: 20 }
                }
            });
            
            doc.save(`${title.replace(/ /g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        // --- Statistiques Enseignants (NOUVELLE VERSION) ---
        async function loadTeachersList() {
            try {
                // Charger les statistiques par classe pour les enseignants
                await loadTeacherClassStats();
                
            } catch (error) {
                console.error("Erreur chargement statistiques enseignants:", error);
                showAlert("Erreur lors du chargement des statistiques", "error");
            }
        }

        async function loadTeacherClassStats() {
            const container = document.getElementById('teacher-class-stats-container');
            container.innerHTML = '<p>Chargement des statistiques...</p>';
            
            try {
                // Récupérer tous les enseignants
                const secondaryTeachersSnap = await getDocs(query(collection(db, 'teachers'), where('status', '!=', 'deleted')));
                const primaryTeachersSnap = await getDocs(query(collection(db, 'primary_teachers'), where('status', '!=', 'deleted')));
                const kindergartenTeachersSnap = await getDocs(query(collection(db, 'kindergarten_teachers'), where('status', '!=', 'deleted')));
                
                let allTeachers = [];
                
                // Enseignants secondaires
                secondaryTeachersSnap.forEach(doc => {
                    const data = doc.data();
                    allTeachers.push({...data, type: 'secondary'});
                });
                
                // Enseignants primaires
                primaryTeachersSnap.forEach(doc => {
                    const data = doc.data();
                    allTeachers.push({...data, type: 'primary'});
                });
                
                // Enseignants maternelles
                kindergartenTeachersSnap.forEach(doc => {
                    const data = doc.data();
                    allTeachers.push({...data, type: 'kindergarten'});
                });
                
                if (allTeachers.length === 0) {
                    container.innerHTML = '<p>Aucun enseignant trouvé</p>';
                    return;
                }
                
                // Grouper les enseignants par classe
                const teachersByClass = {};
                
                allTeachers.forEach(teacher => {
                    if (teacher.classes && teacher.classes.length > 0) {
                        teacher.classes.forEach(className => {
                            if (!teachersByClass[className]) {
                                teachersByClass[className] = [];
                            }
                            teachersByClass[className].push(teacher);
                        });
                    }
                });
                
                let html = '';
                
                for (const [className, teachers] of Object.entries(teachersByClass)) {
                    // Déterminer le type de classe
                    let classType = 'secondary';
                    if (className.includes('CP') || className.includes('CE') || className.includes('CM')) {
                        classType = 'primary';
                    } else if (className.includes('PS') || className.includes('MS') || className.includes('GS')) {
                        classType = 'kindergarten';
                    }
                    
                    const typeText = classType === 'secondary' ? 'Secondaire' : 
                                   classType === 'primary' ? 'Primaire' : 'Maternelle';
                    
                    html += `
                        <div class="class-stat-card">
                            <div class="class-stat-header">
                                <h5>${className}</h5>
                                <span class="badge ${classType === 'secondary' ? 'badge-primary' : classType === 'primary' ? 'badge-success' : 'badge-info'}">${typeText}</span>
                            </div>
                            <p><strong>Nombre d'enseignants:</strong> ${teachers.length}</p>
                            
                            <div class="class-students-list">
                                <h6>Enseignants de cette classe</h6>
                                ${teachers.map(teacher => `
                                    <div class="class-student-item">
                                        <span>${teacher.fullName}</span>
                                        <span>${teacher.matricule}</span>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                                <button class="btn btn-primary btn-sm" onclick="exportClassTeachers('${className}', '${classType}')">
                                    <i class="fas fa-download"></i> Exporter
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error("Erreur chargement statistiques enseignants:", error);
                container.innerHTML = '<p>Erreur lors du chargement des statistiques</p>';
            }
        }

        // Recherche d'enseignant pour modification
        document.getElementById('search-teacher-btn').addEventListener('click', async () => {
            const searchTerm = document.getElementById('search-teacher-modify').value.trim();
            const searchType = document.getElementById('search-teacher-type').value;
            
            if (!searchTerm) {
                showAlert("Veuillez entrer un matricule ou un nom", "error");
                return;
            }
            
            const resultsContainer = document.getElementById('teacher-search-results');
            resultsContainer.innerHTML = '<p>Recherche en cours...</p>';
            
            try {
                let teachers = [];
                const searchTermLower = searchTerm.toLowerCase();
                
                // Rechercher dans les enseignants secondaires
                if (searchType === 'all' || searchType === 'secondary') {
                    const teachersSnap = await getDocs(query(collection(db, 'teachers'), where('status', '!=', 'deleted')));
                    teachersSnap.forEach(doc => {
                        const data = doc.data();
                        if (data.matricule.toLowerCase().includes(searchTermLower) || 
                            data.fullName.toLowerCase().includes(searchTermLower)) {
                            teachers.push({...data, type: 'secondary', docId: doc.id});
                        }
                    });
                }
                
                // Rechercher dans les enseignants primaires
                if (searchType === 'all' || searchType === 'primary') {
                    const teachersSnap = await getDocs(query(collection(db, 'primary_teachers'), where('status', '!=', 'deleted')));
                    teachersSnap.forEach(doc => {
                        const data = doc.data();
                        if (data.matricule.toLowerCase().includes(searchTermLower) || 
                            data.fullName.toLowerCase().includes(searchTermLower)) {
                            teachers.push({...data, type: 'primary', docId: doc.id});
                        }
                    });
                }
                
                // Rechercher dans les enseignants maternelles
                if (searchType === 'all' || searchType === 'kindergarten') {
                    const teachersSnap = await getDocs(query(collection(db, 'kindergarten_teachers'), where('status', '!=', 'deleted')));
                    teachersSnap.forEach(doc => {
                        const data = doc.data();
                        if (data.matricule.toLowerCase().includes(searchTermLower) || 
                            data.fullName.toLowerCase().includes(searchTermLower)) {
                            teachers.push({...data, type: 'kindergarten', docId: doc.id});
                        }
                    });
                }
                
                if (teachers.length === 0) {
                    resultsContainer.innerHTML = '<p>Aucun enseignant trouvé</p>';
                    return;
                }
                
                let html = '<div class="table-container"><table><thead><tr><th>Matricule</th><th>Nom</th><th>Type</th><th>Téléphone</th><th>Actions</th></tr></thead><tbody>';
                
                teachers.forEach(teacher => {
                    const typeText = teacher.type === 'secondary' ? 'Secondaire' : 
                                   teacher.type === 'primary' ? 'Primaire' : 'Maternelle';
                    
                    html += `
                        <tr>
                            <td>${teacher.matricule}</td>
                            <td>${teacher.fullName}</td>
                            <td>${typeText}</td>
                            <td>${teacher.phone || ''}</td>
                            <td class="action-buttons">
                                <button class="btn btn-primary btn-sm" onclick="viewTeacherDetails('${teacher.matricule}', '${teacher.type}')">Détails</button>
                                <button class="btn btn-warning btn-sm" onclick="editTeacher('${teacher.matricule}', '${teacher.type}')">Modifier</button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                resultsContainer.innerHTML = html;
                
            } catch (error) {
                console.error("Erreur recherche enseignant:", error);
                resultsContainer.innerHTML = '<p>Erreur lors de la recherche</p>';
            }
        });

        // Export des données enseignants
        document.getElementById('export-teacher-data-btn').addEventListener('click', async () => {
            const exportType = document.getElementById('export-teacher-type').value;
            const teacherType = document.getElementById('export-teacher-category').value;
            
            try {
                let teachers = [];
                
                // Récupérer les enseignants selon les filtres
                if (teacherType === 'all' || teacherType === 'secondary') {
                    const teachersSnap = await getDocs(query(collection(db, 'teachers'), where('status', '!=', 'deleted')));
                    teachersSnap.forEach(doc => {
                        const data = doc.data();
                        teachers.push({...data, teacherType: 'secondary'});
                    });
                }
                
                if (teacherType === 'all' || teacherType === 'primary') {
                    const teachersSnap = await getDocs(query(collection(db, 'primary_teachers'), where('status', '!=', 'deleted')));
                    teachersSnap.forEach(doc => {
                        const data = doc.data();
                        teachers.push({...data, teacherType: 'primary'});
                    });
                }
                
                if (teacherType === 'all' || teacherType === 'kindergarten') {
                    const teachersSnap = await getDocs(query(collection(db, 'kindergarten_teachers'), where('status', '!=', 'deleted')));
                    teachersSnap.forEach(doc => {
                        const data = doc.data();
                        teachers.push({...data, teacherType: 'kindergarten'});
                    });
                }
                
                if (teachers.length === 0) {
                    showAlert("Aucun enseignant à exporter", "warning");
                    return;
                }
                
                // Préparer les données pour l'export
                const exportData = teachers.map(teacher => ({
                    'Matricule': teacher.matricule,
                    'Nom complet': teacher.fullName,
                    'Type': teacher.teacherType === 'secondary' ? 'Secondaire' : 
                           teacher.teacherType === 'primary' ? 'Primaire' : 'Maternelle',
                    'Téléphone': teacher.phone || '',
                    'Date de naissance': teacher.birthdate,
                    'Lieu de naissance': teacher.birthplace || '',
                    'Sexe': teacher.gender === 'M' ? 'Masculin' : 'Féminin',
                    'Adresse': teacher.address || '',
                    'Matières': teacher.subjects ? teacher.subjects.join(', ') : 'Toutes matières',
                    'Classes': teacher.classes ? teacher.classes.join(', ') : '',
                    'Statut': teacher.status === 'active' ? 'Actif' : 'Inactif',
                    'Date inscription': formatDate(teacher.createdAt?.toDate())
                }));
                
                // Exporter selon le type choisi
                if (exportType === 'excel') {
                    exportToExcel(exportData, 'enseignants_cs_lacolombe');
                } else if (exportType === 'csv') {
                    exportToCSV(exportData, 'enseignants_cs_lacolombe');
                } else if (exportType === 'pdf') {
                    exportToPDF(exportData, 'Liste des Enseignants - CS la Colombe');
                }
                
                showAlert(`Export réussi: ${teachers.length} enseignant(s) exporté(s)`, "success");
                
            } catch (error) {
                console.error("Erreur export enseignants:", error);
                showAlert("Erreur lors de l'export", "error");
            }
        });

        // --- Rapports Administratifs (CORRIGÉS) ---
      function setupReportControls() {
    const reportTypeSelect = document.getElementById('report-type');
    
    if (!reportTypeSelect) return;
    
    // Masquer tous les contrôles
    document.querySelectorAll('.report-controls').forEach(ctrl => ctrl.classList.add('hidden'));
    
    // Afficher les contrôles appropriés
    const dailyControls = document.getElementById('daily-controls');
    if (dailyControls) dailyControls.classList.remove('hidden');
    
    // Écouter les changements du type de rapport
    reportTypeSelect.addEventListener('change', function() {
        // Masquer tous les contrôles
        document.querySelectorAll('.report-controls').forEach(ctrl => ctrl.classList.add('hidden'));
        
        // Afficher les contrôles appropriés
        if (this.value === 'daily') {
            if (document.getElementById('daily-controls')) {
                document.getElementById('daily-controls').classList.remove('hidden');
            }
        } else if (this.value === 'monthly') {
            if (document.getElementById('monthly-controls')) {
                document.getElementById('monthly-controls').classList.remove('hidden');
            }
        } else if (this.value === 'yearly') {
            if (document.getElementById('yearly-controls')) {
                document.getElementById('yearly-controls').classList.remove('hidden');
            }
        } else if (this.value === 'enrollment') {
            if (document.getElementById('daily-controls')) {
                document.getElementById('daily-controls').classList.remove('hidden');
            }
            if (document.getElementById('class-controls')) {
                document.getElementById('class-controls').classList.remove('hidden');
            }
        } else if (this.value === 'payments-class') {
            if (document.getElementById('monthly-controls')) {
                document.getElementById('monthly-controls').classList.remove('hidden');
            }
            if (document.getElementById('class-controls')) {
                document.getElementById('class-controls').classList.remove('hidden');
            }
            if (document.getElementById('fees-type-controls')) {
                document.getElementById('fees-type-controls').classList.remove('hidden');
            }
        } else if (this.value === 'fees') {
            if (document.getElementById('monthly-controls')) {
                document.getElementById('monthly-controls').classList.remove('hidden');
            }
        }
    });
}

        document.getElementById('generate-report-btn').addEventListener('click', async () => {
            await generateReport();
        });

        // Bouton retour pour les rapports
        document.getElementById('back-report-btn').addEventListener('click', () => {
            document.getElementById('report-content').classList.add('hidden');
            document.getElementById('back-report-btn').style.display = 'none';
        });

function checkRequiredElements() {
    const requiredElements = [
        'report-class',
        'export-class',
        'report-type',
        'export-type',
        'export-student-type'
    ];
    
    requiredElements.forEach(id => {
        const element = document.getElementById(id);
        if (!element) {
            console.error(`Élément manquant: ${id}`);
        } else {
            console.log(`Élément trouvé: ${id}`);
        }
    });
}

// Appelez cette fonction après l'initialisation
setTimeout(() => {
    checkRequiredElements();
}, 1000);

        async function generateReport() {
    const reportType = document.getElementById('report-type').value;
    const reportDate = document.getElementById('report-date').value;
    const reportMonth = document.getElementById('report-month').value;
    const reportYear = document.getElementById('report-year') ? document.getElementById('report-year').value : new Date().getFullYear();
    const reportClass = document.getElementById('report-class') ? document.getElementById('report-class').value : '';
    const reportFeesType = document.getElementById('report-fees-type') ? document.getElementById('report-fees-type').value : '';
    
    try {
        // Cacher les sections spécifiques
        document.getElementById('class-payments-section').classList.add('hidden');
        document.getElementById('enrollment-report-section').classList.add('hidden');
        document.getElementById('fees-breakdown-section').classList.add('hidden');
        document.getElementById('general-summary').classList.remove('hidden');
        
        let reportData = [];
        let reportTitle = '';
        let reportPeriod = '';
        
        if (reportType === 'daily') {
            if (!reportDate) {
                showAlert("Veuillez sélectionner une date", "error");
                return;
            }
            
            reportTitle = 'Rapport Journalier des Paiements';
            reportPeriod = `Date: ${new Date(reportDate).toLocaleDateString('fr-FR')}`;
            
            const startDate = new Date(reportDate);
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + 1);
            
            const paymentsSnap = await getDocs(query(
                collection(db, 'payments'), 
                where('validatedAt', '>=', startDate),
                where('validatedAt', '<', endDate)
            ));
            
            reportData = paymentsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
        } else if (reportType === 'monthly') {
            if (!reportMonth) {
                showAlert("Veuillez sélectionner un mois", "error");
                return;
            }
            
            reportTitle = 'Rapport Mensuel des Paiements';
            reportPeriod = `Mois: ${reportMonth}`;
            
            const paymentsSnap = await getDocs(query(collection(db, 'payments'), where('month', '==', reportMonth)));
            reportData = paymentsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
        } else if (reportType === 'yearly') {
            reportTitle = 'Rapport Annuel des Paiements';
            reportPeriod = `Année: ${reportYear}`;
            
            const startDate = new Date(reportYear, 0, 1);
            const endDate = new Date(parseInt(reportYear) + 1, 0, 1);
            
            const paymentsSnap = await getDocs(query(
                collection(db, 'payments'), 
                where('validatedAt', '>=', startDate),
                where('validatedAt', '<', endDate)
            ));
            
            reportData = paymentsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
        } else if (reportType === 'fees') {
            if (!reportMonth) {
                showAlert("Veuillez sélectionner un mois", "error");
                return;
            }
            
            reportTitle = 'Rapport par Type de Frais';
            reportPeriod = `Mois: ${reportMonth}`;
            
            const paymentsSnap = await getDocs(query(collection(db, 'payments'), where('month', '==', reportMonth)));
            reportData = paymentsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            // Afficher le breakdown par type de frais
            document.getElementById('fees-breakdown-section').classList.remove('hidden');
            
        } else if (reportType === 'enrollment') {
            if (!reportDate) {
                showAlert("Veuillez sélectionner une date", "error");
                return;
            }
            
            reportTitle = 'Rapport des Inscriptions';
            reportPeriod = `Date: ${new Date(reportDate).toLocaleDateString('fr-FR')}`;
            
            const startDate = new Date(reportDate);
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + 1);
            
            // Récupérer les inscriptions de la journée - NOUVELLE APPROCHE
            let enrollments = [];
            
            // Élèves secondaires - récupérer tous puis filtrer localement
            const secondarySnap = await getDocs(query(
                collection(db, 'students'), 
                where('createdAt', '>=', startDate),
                where('createdAt', '<', endDate)
            ));
            secondarySnap.forEach(doc => {
                const data = doc.data();
                // Filtrer par status localement
                if (data.status !== 'deleted') {
                    enrollments.push({ ...data, type: 'secondary' });
                }
            });
            
            // Élèves primaires
            const primarySnap = await getDocs(query(
                collection(db, 'primary_students'), 
                where('createdAt', '>=', startDate),
                where('createdAt', '<', endDate)
            ));
            primarySnap.forEach(doc => {
                const data = doc.data();
                if (data.status !== 'deleted') {
                    enrollments.push({ ...data, type: 'primary' });
                }
            });
            
            // Élèves maternelles
            const kindergartenSnap = await getDocs(query(
                collection(db, 'kindergarten_students'), 
                where('createdAt', '>=', startDate),
                where('createdAt', '<', endDate)
            ));
            kindergartenSnap.forEach(doc => {
                const data = doc.data();
                if (data.status !== 'deleted') {
                    enrollments.push({ ...data, type: 'kindergarten' });
                }
            });
            
            reportData = enrollments;
            
            // Afficher la section des inscriptions
            document.getElementById('enrollment-report-section').classList.remove('hidden');
            document.getElementById('general-summary').classList.add('hidden');
            
        } else if (reportType === 'payments-class') {
            if (!reportMonth || !reportClass) {
                showAlert("Veuillez sélectionner un mois et une classe", "error");
                return;
            }
            
            reportTitle = `Rapport des Paiements - Classe ${reportClass}`;
            reportPeriod = `Mois: ${reportMonth}`;
            
            // Récupérer les paiements pour le mois spécifié - NOUVELLE APPROCHE
            let paymentsQuery = query(collection(db, 'payments'), where('month', '==', reportMonth));
            
            if (reportFeesType && reportFeesType !== 'all') {
                paymentsQuery = query(paymentsQuery, where('paymentType', '==', reportFeesType));
            }
            
            const paymentsSnap = await getDocs(paymentsQuery);
            
            // Filtrer par classe localement
            reportData = paymentsSnap.docs
                .map(doc => ({ id: doc.id, ...doc.data() }))
                .filter(payment => {
                    // Vérifier si l'élève appartient à la classe sélectionnée
                    return payment.studentClass === reportClass;
                });
            
            // Afficher la section spécifique pour le rapport par classe
            document.getElementById('class-payments-section').classList.remove('hidden');
        }
        
        // Générer le rapport
        await generateReportContent(reportData, reportType, reportTitle, reportPeriod, reportClass, reportMonth);
        
        // Afficher le contenu du rapport
        document.getElementById('report-content').classList.remove('hidden');
        document.getElementById('back-report-btn').style.display = 'block';
        
    } catch (error) {
        console.error("Erreur génération rapport:", error);
        showAlert('Erreur lors de la génération du rapport: ' + error.message, 'error');
    }
}

        async function generateReportContent(data, reportType, title, period, className = '', month = '') {
            // Mettre à jour le titre et la période
            document.getElementById('report-title').textContent = title;
            document.getElementById('report-period').textContent = period;
            
            if (reportType === 'enrollment') {
                // Rapport des inscriptions
                const totalEnrollments = data.length;
                const secondaryEnrollments = data.filter(d => d.type === 'secondary').length;
                const primaryEnrollments = data.filter(d => d.type === 'primary').length;
                const kindergartenEnrollments = data.filter(d => d.type === 'kindergarten').length;
                
                document.getElementById('total-enrollments').textContent = totalEnrollments;
                document.getElementById('secondary-enrollments').textContent = secondaryEnrollments;
                document.getElementById('primary-enrollments').textContent = primaryEnrollments;
                document.getElementById('kindergarten-enrollments').textContent = kindergartenEnrollments;
                
                // Grouper par classe
                const enrollmentsByClass = {};
                data.forEach(enrollment => {
                    if (!enrollmentsByClass[enrollment.class]) {
                        enrollmentsByClass[enrollment.class] = {
                            secondary: 0,
                            primary: 0,
                            kindergarten: 0,
                            total: 0
                        };
                    }
                    
                    enrollmentsByClass[enrollment.class][enrollment.type]++;
                    enrollmentsByClass[enrollment.class].total++;
                });
                
                // Générer le tableau
                const tableHead = document.getElementById('report-table-head');
                const tableBody = document.getElementById('report-table-body');
                const tableFooter = document.getElementById('report-table-footer');
                
                tableHead.innerHTML = `
                    <tr>
                        <th>Date</th>
                        <th>Type Classe</th>
                        <th>Classe</th>
                        <th>Type de Frais</th>
                        <th>Montant d'Inscription</th>
                        <th>Validé par</th>
                        <th>Montant Total Classe</th>
                        <th>Nombre d'Élèves</th>
                    </tr>
                `;
                
                let tableHTML = '';
                let totalAmount = 0;
                let totalStudents = 0;
                
                for (const [className, stats] of Object.entries(enrollmentsByClass)) {
                    // Calculer le montant total pour la classe
                    const classAmount = data
                        .filter(d => d.class === className)
                        .reduce((sum, d) => sum + (d.enrollmentFees || 0), 0);
                    
                    totalAmount += classAmount;
                    totalStudents += stats.total;
                    
                    tableHTML += `
                        <tr>
                            <td>${new Date().toLocaleDateString('fr-FR')}</td>
                            <td>${stats.secondary > 0 ? 'Secondaire' : stats.primary > 0 ? 'Primaire' : 'Maternelle'}</td>
                            <td>${className}</td>
                            <td>Frais d'inscription</td>
                            <td class="currency-display">$${classAmount.toFixed(2)}</td>
                            <td>${currentSecretary.fullName}</td>
                            <td class="currency-display">$${classAmount.toFixed(2)}</td>
                            <td>${stats.total}</td>
                        </tr>
                    `;
                }
                
                tableBody.innerHTML = tableHTML;
                
                tableFooter.innerHTML = `
                    <tr>
                        <td colspan="4"><strong>TOTAL GÉNÉRAL</strong></td>
                        <td class="currency-display"><strong>$${totalAmount.toFixed(2)}</strong></td>
                        <td></td>
                        <td class="currency-display"><strong>$${totalAmount.toFixed(2)}</strong></td>
                        <td><strong>${totalStudents}</strong></td>
                    </tr>
                `;
                
            } else if (reportType === 'payments-class') {
                // Rapport des paiements par classe
                const totalPayments = data.length;
                const totalAmount = data.reduce((sum, payment) => sum + payment.amount, 0);
                
                // Récupérer tous les élèves de la classe
                let classStudents = [];
                
                // Déterminer le type de classe
                let classType = 'secondary';
                if (className.includes('CP') || className.includes('CE') || className.includes('CM')) {
                    classType = 'primary';
                } else if (className.includes('PS') || className.includes('MS') || className.includes('GS')) {
                    classType = 'kindergarten';
                }
                
                if (classType === 'secondary') {
                    const studentsSnap = await getDocs(query(collection(db, 'students'), where('class', '==', className), where('status', '!=', 'deleted')));
                    studentsSnap.forEach(doc => {
                        classStudents.push(doc.data());
                    });
                } else if (classType === 'primary') {
                    const studentsSnap = await getDocs(query(collection(db, 'primary_students'), where('class', '==', className), where('status', '!=', 'deleted')));
                    studentsSnap.forEach(doc => {
                        classStudents.push(doc.data());
                    });
                } else {
                    const studentsSnap = await getDocs(query(collection(db, 'kindergarten_students'), where('class', '==', className), where('status', '!=', 'deleted')));
                    studentsSnap.forEach(doc => {
                        classStudents.push(doc.data());
                    });
                }
                
                const totalStudents = classStudents.length;
                
                // Identifier les élèves qui ont payé pour le mois
                const paidStudents = new Set();
                data.forEach(payment => {
                    paidStudents.add(payment.studentId);
                });
                
                const paidCount = paidStudents.size;
                const unpaidCount = totalStudents - paidCount;
                const paymentRate = totalStudents > 0 ? Math.round((paidCount / totalStudents) * 100) : 0;
                const perStudentAmount = totalStudents > 0 ? totalAmount / totalStudents : 0;
                
                // Mettre à jour les statistiques spécifiques à la classe
                document.getElementById('class-paid-students').textContent = paidCount;
                document.getElementById('class-unpaid-students').textContent = unpaidCount;
                document.getElementById('class-payment-rate').textContent = paymentRate + '%';
                document.getElementById('class-per-student').textContent = '$' + perStudentAmount.toFixed(2);
                
                // Générer le tableau
                const tableHead = document.getElementById('report-table-head');
                const tableBody = document.getElementById('report-table-body');
                const tableFooter = document.getElementById('report-table-footer');
                
                tableHead.innerHTML = `
                    <tr>
                        <th>Date</th>
                        <th>Élève</th>
                        <th>Type</th>
                        <th>Classe</th>
                        <th>Mois</th>
                        <th>Type de Frais</th>
                        <th>Montant</th>
                        <th>Méthode</th>
                        <th>Validé par</th>
                    </tr>
                `;
                
                let tableHTML = '';
                data.forEach(payment => {
                    const studentTypeText = payment.studentType === 'secondary' ? 'Secondaire' : 
                                          payment.studentType === 'primary' ? 'Primaire' : 'Maternelle';
                    
                    tableHTML += `
                        <tr>
                            <td>${formatDate(payment.validatedAt?.toDate())}</td>
                            <td>${payment.studentName}</td>
                            <td>${studentTypeText}</td>
                            <td>${payment.studentClass}</td>
                            <td>${payment.month}</td>
                            <td>${payment.paymentType}</td>
                            <td class="currency-display">$${payment.amount.toFixed(2)}</td>
                            <td>${payment.paymentMethod === 'online' ? 'En ligne' : 'Sur place'}</td>
                            <td>${currentSecretary.fullName}</td>
                        </tr>
                    `;
                });
                
                tableBody.innerHTML = tableHTML;
                
                tableFooter.innerHTML = `
                    <tr>
                        <td colspan="6"><strong>TOTAL POUR LA CLASSE ${className}</strong></td>
                        <td class="currency-display"><strong>$${totalAmount.toFixed(2)}</strong></td>
                        <td colspan="2"></td>
                    </tr>
                `;
                
            } else {
                // Rapports généraux
                const totalPayments = data.length;
                const totalAmount = data.reduce((sum, payment) => sum + payment.amount, 0);
                const onlinePayments = data.filter(p => p.paymentMethod === 'online').length;
                const onsitePayments = data.filter(p => p.paymentMethod === 'onsite').length;
                
                // Mettre à jour les statistiques
                document.getElementById('total-payments').textContent = totalPayments;
                document.getElementById('total-amount').textContent = '$' + totalAmount.toFixed(2);
                document.getElementById('online-payments').textContent = onlinePayments;
                document.getElementById('onsite-payments').textContent = onsitePayments;
                
                if (reportType === 'fees') {
                    // Calculer le breakdown par type de frais
                    const feesBreakdown = {};
                    data.forEach(payment => {
                        const feeType = payment.paymentType || 'Autres';
                        if (!feesBreakdown[feeType]) {
                            feesBreakdown[feeType] = {
                                count: 0,
                                amount: 0
                            };
                        }
                        feesBreakdown[feeType].count++;
                        feesBreakdown[feeType].amount += payment.amount;
                    });
                    
                    let breakdownHTML = '';
                    for (const [feeType, stats] of Object.entries(feesBreakdown)) {
                        const percentage = totalAmount > 0 ? ((stats.amount / totalAmount) * 100).toFixed(2) : 0;
                        breakdownHTML += `
                            <tr>
                                <td>${feeType}</td>
                                <td>${stats.count}</td>
                                <td class="currency-display">$${stats.amount.toFixed(2)}</td>
                                <td>${percentage}%</td>
                            </tr>
                        `;
                    }
                    
                    document.getElementById('fees-breakdown-table').innerHTML = breakdownHTML || '<tr><td colspan="4" style="text-align: center;">Aucun frais trouvé</td></tr>';
                    document.getElementById('total-payments-breakdown').textContent = totalPayments;
                    document.getElementById('total-amount-breakdown').textContent = '$' + totalAmount.toFixed(2);
                }
                
                // Générer le tableau
                const tableHead = document.getElementById('report-table-head');
                const tableBody = document.getElementById('report-table-body');
                const tableFooter = document.getElementById('report-table-footer');
                
                tableHead.innerHTML = `
                    <tr>
                        <th>Date</th>
                        <th>Élève</th>
                        <th>Type</th>
                        <th>Classe</th>
                        <th>Mois</th>
                        <th>Type de Frais</th>
                        <th>Montant</th>
                        <th>Méthode</th>
                        <th>Validé par</th>
                    </tr>
                `;
                
                let tableHTML = '';
                data.forEach(payment => {
                    const studentTypeText = payment.studentType === 'secondary' ? 'Secondaire' : 
                                          payment.studentType === 'primary' ? 'Primaire' : 'Maternelle';
                    
                    tableHTML += `
                        <tr>
                            <td>${formatDate(payment.validatedAt?.toDate())}</td>
                            <td>${payment.studentName}</td>
                            <td>${studentTypeText}</td>
                            <td>${payment.studentClass}</td>
                            <td>${payment.month}</td>
                            <td>${payment.paymentType}</td>
                            <td class="currency-display">$${payment.amount.toFixed(2)}</td>
                            <td>${payment.paymentMethod === 'online' ? 'En ligne' : 'Sur place'}</td>
                            <td>${currentSecretary.fullName}</td>
                        </tr>
                    `;
                });
                
                tableBody.innerHTML = tableHTML || '<tr><td colspan="9" style="text-align: center;">Aucune donnée trouvée</td></tr>';
                
                if (data.length > 0) {
                    tableFooter.innerHTML = `
                        <tr>
                            <td colspan="6"><strong>TOTAL GÉNÉRAL</strong></td>
                            <td class="currency-display"><strong>$${totalAmount.toFixed(2)}</strong></td>
                            <td colspan="2"></td>
                        </tr>
                    `;
                } else {
                    tableFooter.innerHTML = '';
                }
            }
        }

        document.getElementById('export-report-btn').addEventListener('click', () => {
            const reportContent = document.getElementById('report-content').innerHTML;
            
            // Créer une nouvelle fenêtre pour l'impression
            const printWindow = window.open('', '_blank');
            
            // HTML minimal pour l'impression
            const printHTML = `
                <!DOCTYPE html>
                <html>
                    <head>
                        <title>Rapport - hybrilinkp</title>
                        <style>
                            body { 
                                font-family: Arial, sans-serif; 
                                margin: 20px; 
                                font-size: 12px;
                            }
                            .report-card { 
                                max-width: 100%; 
                                margin: 0 auto; 
                                border: none;
                                padding: 0;
                            }
                            .report-header { 
                                display: flex; 
                                justify-content: space-between; 
                                align-items: center; 
                                margin-bottom: 20px;
                                border-bottom: 2px solid #3498db;
                                padding-bottom: 10px;
                            }
                            .report-summary { 
                                display: grid; 
                                grid-template-columns: repeat(4, 1fr); 
                                gap: 1rem; 
                                margin-bottom: 1.5rem; 
                            }
                            .fees-summary-card { 
                                background: #f8f9fa; 
                                padding: 1rem; 
                                border-radius: 8px; 
                                box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
                                text-align: center; 
                                border: 1px solid #dee2e6;
                            }
                            .fees-summary-card h4 { 
                                margin-bottom: 0.5rem; 
                                color: #2c3e50; 
                                font-size: 14px;
                            }
                            .fees-summary-card p { 
                                font-size: 18px; 
                                font-weight: bold; 
                                color: #3498db; 
                                margin: 0;
                            }
                            table { 
                                width: 100%; 
                                border-collapse: collapse; 
                                margin-top: 1rem; 
                                font-size: 11px;
                            }
                            th, td { 
                                padding: 6px 8px; 
                                text-align: left; 
                                border: 1px solid #dee2e6; 
                            }
                            th { 
                                background-color: #f8f9fa; 
                                font-weight: 600; 
                            }
                            .signature-area { 
                                margin-top: 3rem; 
                                display: flex; 
                                justify-content: space-between; 
                            }
                            .signature-box { 
                                text-align: center; 
                                width: 45%; 
                            }
                            .signature-line { 
                                border-top: 1px solid #000; 
                                margin-top: 3rem; 
                            }
                            .currency-display { 
                                font-weight: bold; 
                                color: #27ae60; 
                            }
                            @media print {
                                body { 
                                    margin: 0; 
                                    padding: 10px;
                                }
                                .report-card { 
                                    border: none; 
                                    box-shadow: none; 
                                }
                                .no-print {
                                    display: none !important;
                                }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="report-card">
                            ${reportContent}
                        </div>
                        <script>


                            window.onload = function() {
                                window.print();
                                setTimeout(function() {
                                    window.close();
                                }, 1000);
                            }
                        <\/script>
                    </body>
                </html>
            `;
            
            printWindow.document.write(printHTML);
            printWindow.document.close();
        });

        // --- Profil ---
        async function loadProfileData() {
            if (!currentSecretary) return;
            
            try {
                document.getElementById('profile-name').value = currentSecretary.fullName || '';
                document.getElementById('profile-email').value = currentSecretary.email || '';
                document.getElementById('profile-phone').value = currentSecretary.phone || '';
                document.getElementById('profile-address').value = currentSecretary.address || '';
                document.getElementById('profile-created').value = formatDate(currentSecretary.createdAt?.toDate()) || '';
                
                // Afficher la photo de profil
                const photoPreview = document.getElementById('profile-photo-preview');
                if (currentSecretary.photoURL) {
                    photoPreview.innerHTML = `<img src="${currentSecretary.photoURL}" class="photo-preview">`;
                } else {
                    photoPreview.innerHTML = '<i class="fas fa-user"></i>';
                }
            } catch (error) {
                console.error("Erreur chargement profil:", error);
            }
        }

        document.getElementById('update-profile-btn').addEventListener('click', async () => {
            if (!currentSecretary) return;
            
            const fullName = document.getElementById('profile-name').value;
            const phone = document.getElementById('profile-phone').value;
            const address = document.getElementById('profile-address').value;
            
            try {
                // Uploader la nouvelle photo si elle existe
                let photoURL = currentSecretary.photoURL;
                if (profilePhotoFile) {
                    try {
                        photoURL = await uploadToCloudinary(profilePhotoFile, `secretary/${currentSecretary.id}`);
                    } catch (uploadError) {
                        console.error("Erreur upload photo profil:", uploadError);
                    }
                }
                
                // Mettre à jour les données dans Firestore
                await updateDoc(doc(db, 'secretary', currentSecretary.id), {
                    fullName,
                    phone,
                    address,
                    photoURL,
                    updatedAt: serverTimestamp()
                });
                
                // Mettre à jour l'objet currentSecretary
                currentSecretary.fullName = fullName;
                currentSecretary.phone = phone;
                currentSecretary.address = address;
                currentSecretary.photoURL = photoURL;
                
                // Mettre à jour l'affichage
                document.getElementById('secretary-name').textContent = fullName;
                const photoContainer = document.getElementById('secretary-photo-container');
                if (photoURL) {
                    photoContainer.innerHTML = `<img src="${photoURL}" class="secretary-photo" alt="Photo de profil">`;
                } else {
                    photoContainer.innerHTML = `<div class="secretary-photo-placeholder"><i class="fas fa-user"></i></div>`;
                }
                
                showAlert('Profil mis à jour avec succès !', 'success');
                profilePhotoFile = null;
            } catch (error) {
                console.error("Erreur mise à jour profil:", error);
                showAlert('Erreur lors de la mise à jour du profil: ' + error.message, 'error');
            }
        });

        // --- Navigation ---
        document.querySelectorAll('.nav-menu a').forEach(link => {
            link.addEventListener('click', e => {
                if (link.parentElement.classList.contains('has-submenu')) {
                    return; // Ne pas changer de page pour les menus déroulants
                }
                
                e.preventDefault();
                document.querySelectorAll('.nav-menu a, .page').forEach(el => el.classList.remove('active'));
                link.classList.add('active');
                document.getElementById(link.dataset.page + '-page').classList.add('active');
                document.getElementById('page-title').textContent = link.textContent;
                
                // Recharger les données si nécessaire
                if (link.dataset.page === 'dashboard') {
                    loadDashboardStats();
                } else if (link.dataset.page === 'students-list') {
                    loadStudentsList();
                } else if (link.dataset.page === 'teachers-list') {
                    loadTeachersList();
                } else if (link.dataset.page === 'validate-payment') {
                    loadPendingPaymentsList();
                    setupPaymentForm();
                } else if (link.dataset.page === 'enroll-teacher') {
                    loadTeacherClasses();
                } else if (link.dataset.page === 'enroll-primary-teacher') {
                    loadPrimaryTeacherClasses();
                } else if (link.dataset.page === 'enroll-kindergarten-teacher') {
                    loadKindergartenTeacherClasses();
                } else if (link.dataset.page === 'manage-fees') {
                    loadFeesData();
                    loadFeesClasses();
              } else if (link.dataset.page === 'admin-reports') {
    setupReportControls();
    // Initialiser les dates pour les rapports
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('report-date').value = today;
    document.getElementById('report-year').value = new Date().getFullYear();
    // AJOUTEZ CETTE LIGNE :
    loadAllClassesForReports();
loadClassesIntoSelects();
                } else if (link.dataset.page === 'manage-classes') {
                    loadClassesList();
                } else if (link.dataset.page === 'manage-primary-classes') {
                    loadPrimaryClassesList();
                } else if (link.dataset.page === 'manage-kindergarten-classes') {
                    loadKindergartenClassesList();
                } else if (link.dataset.page === 'profile') {
                    loadProfileData();
                } else if (link.dataset.page === 'other-management') {
                    // Rien à charger
                }
                
                // Fermer le menu sur mobile
                if (window.innerWidth <= 768) {
                    document.querySelector('.sidebar').classList.add('collapsed');
                }
            });
        });

        // Onglets pour la gestion des frais
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab, .tab-content').forEach(el => el.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
            });
        });

        // --- Fonctions globales pour les boutons ---
        window.viewStudentDetails = async (studentMatricule, studentType) => {
            try {
                let docRef;
                if (studentType === 'secondary') {
                    docRef = doc(db, 'students', studentMatricule);
                } else if (studentType === 'primary') {
                    docRef = doc(db, 'primary_students', studentMatricule);
                } else {
                    docRef = doc(db, 'kindergarten_students', studentMatricule);
                }
                
                const studentSnap = await getDoc(docRef);
                
                if (!studentSnap.exists()) {
                    showAlert('Élève non trouvé.', 'error');
                    return;
                }
                
                const data = studentSnap.data();
                const modalContent = document.getElementById('student-details-content');
                
                const photoHTML = data.photoURL 
                    ? `<img src="${data.photoURL}" class="photo-preview" style="margin: 0 auto 1rem; display: block;">`
                    : '<div class="photo-placeholder" style="margin: 0 auto 1rem;"><i class="fas fa-user"></i></div>';
                
                const studentTypeText = studentType === 'secondary' ? 'Secondaire' : 
                                      studentType === 'primary' ? 'Primaire' : 'Maternelle';
                const phoneField = studentType === 'secondary' ? 
                    `<div class="detail-item">
                        <label>Téléphone</label>
                        <p>${data.phone || 'Non spécifié'}</p>
                    </div>` : '';
                
                // Récupérer les paiements de l'élève
                const paymentsSnap = await getDocs(query(collection(db, 'payments'), where('studentId', '==', studentMatricule)));
                let paymentsHTML = '<p>Aucun paiement enregistré</p>';
                let totalPaid = 0;
                
                if (!paymentsSnap.empty) {
                    paymentsHTML = '<ul style="list-style-type: none; padding: 0;">';
                    paymentsSnap.forEach(doc => {
                        const payment = doc.data();
                        totalPaid += payment.amount;
                        paymentsHTML += `
                            <li style="margin-bottom: 5px;">
                                ${payment.month} - ${payment.paymentType}: $${payment.amount.toFixed(2)}
                                <small style="color: #666;">(${formatDate(payment.validatedAt?.toDate())})</small>
                            </li>
                        `;
                    });
                    paymentsHTML += '</ul>';
                }
                
                modalContent.innerHTML = `
                    ${photoHTML}
                    <div class="student-details">
                        <div class="detail-item">
                            <label>Matricule</label>
                            <p>${data.matricule}</p>
                        </div>
                        <div class="detail-item">
                            <label>Nom complet</label>
                            <p>${data.fullName}</p>
                        </div>
                        <div class="detail-item">
                            <label>Type</label>
                            <p>${studentTypeText}</p>
                        </div>
                        <div class="detail-item">
                            <label>Date de naissance</label>
                            <p>${data.birthdate}</p>
                        </div>
                        <div class="detail-item">
                            <label>Lieu de naissance</label>
                            <p>${data.birthplace || 'Non spécifié'}</p>
                        </div>
                        <div class="detail-item">
                            <label>Sexe</label>
                            <p>${data.gender === 'M' ? 'Masculin' : data.gender === 'F' ? 'Féminin' : 'Non spécifié'}</p>
                        </div>
                        <div class="detail-item">
                            <label>Adresse</label>
                            <p>${data.address || 'Non spécifié'}</p>
                        </div>
                        ${phoneField}
                        <div class="detail-item">
                            <label>Classe</label>
                            <p>${data.class}</p>
                        </div>
                        <div class="detail-item">
                            <label>Frais d'inscription</label>
                            <p class="currency-display">$${(data.enrollmentFees || 0).toFixed(2)}</p>
                        </div>
                        <div class="detail-item">
                            <label>Statut</label>
                            <p>${data.status === 'active' ? 'Actif' : 'Inactif'}</p>
                        </div>
                        <div class="detail-item">
                            <label>Date d'inscription</label>
                            <p>${formatDate(data.createdAt?.toDate())}</p>
                        </div>
                        <div class="detail-item">
                            <label>Nom du parent</label>
                            <p>${data.parentName}</p>
                        </div>
                        <div class="detail-item">
                            <label>Téléphone du parent</label>
                            <p>${data.parentPhone}</p>
                        </div>
                        <div class="detail-item">
                            <label>Adresse du parent</label>
                            <p>${data.parentAddress || 'Non spécifié'}</p>
                        </div>
                    </div>
                    
                    <hr style="margin: 1.5rem 0;">
                    
                    <h4>Historique des Paiements</h4>
                    <div class="detail-item">
                        <label>Total payé</label>
                        <p class="currency-display"><strong>$${totalPaid.toFixed(2)}</strong></p>
                    </div>
                    <div class="detail-item">
                        <label>Détail des paiements</label>
                        <div style="max-height: 200px; overflow-y: auto; margin-top: 10px;">
                            ${paymentsHTML}
                        </div>
                    </div>
                `;
                
                document.getElementById('student-details-modal').classList.remove('hidden');
            } catch (error) {
                showAlert('Erreur: ' + error.message, 'error');
            }
        };

        window.viewTeacherDetails = async (teacherMatricule, teacherType) => {
            try {
                let docRef;
                if (teacherType === 'secondary') {
                    docRef = doc(db, 'teachers', teacherMatricule);
                } else if (teacherType === 'primary') {
                    docRef = doc(db, 'primary_teachers', teacherMatricule);
                } else {
                    docRef = doc(db, 'kindergarten_teachers', teacherMatricule);
                }
                
                const teacherSnap = await getDoc(docRef);
                
                if (!teacherSnap.exists()) {
                    showAlert('Enseignant non trouvé.', 'error');
                    return;
                }
                
                const data = teacherSnap.data();
                const modalContent = document.getElementById('teacher-details-content');
                
                const photoHTML = data.photoURL 
                    ? `<img src="${data.photoURL}" class="photo-preview" style="margin: 0 auto 1rem; display: block;">`
                    : '<div class="photo-placeholder" style="margin: 0 auto 1rem;"><i class="fas fa-user-tie"></i></div>';
                
                const teacherTypeText = teacherType === 'secondary' ? 'Secondaire' : 
                                       teacherType === 'primary' ? 'Primaire' : 'Maternelle';
                const subjectsField = teacherType === 'secondary' ? 
                    `<div class="detail-item">
                        <label>Matières</label>
                        <p>${data.subjects?.join(', ') || 'Non spécifié'}</p>
                    </div>` : '';
                
                modalContent.innerHTML = `
                    ${photoHTML}
                    <div class="student-details">
                        <div class="detail-item">
                            <label>Matricule</label>
                            <p>${data.matricule}</p>
                        </div>
                        <div class="detail-item">
                            <label>Nom complet</label>
                            <p>${data.fullName}</p>
                        </div>
                        <div class="detail-item">
                            <label>Type</label>
                            <p>${teacherTypeText}</p>
                        </div>
                        <div class="detail-item">
                            <label>Date de naissance</label>
                            <p>${data.birthdate}</p>
                        </div>
                        <div class="detail-item">
                            <label>Lieu de naissance</label>
                            <p>${data.birthplace || 'Non spécifié'}</p>
                        </div>
                        <div class="detail-item">
                            <label>Sexe</label>
                            <p>${data.gender === 'M' ? 'Masculin' : data.gender === 'F' ? 'Féminin' : 'Non spécifié'}</p>
                        </div>
                        <div class="detail-item">
                            <label>Adresse</label>
                            <p>${data.address || 'Non spécifié'}</p>
                        </div>
                        <div class="detail-item">
                            <label>Téléphone</label>
                            <p>${data.phone || 'Non spécifié'}</p>
                        </div>
                        ${subjectsField}
                        <div class="detail-item">
                            <label>Classes</label>
                            <p>${data.classes ? data.classes.join(', ') : 'Aucune'}</p>
                        </div>
                        <div class="detail-item">
                            <label>Statut</label>
                            <p>${data.status === 'active' ? 'Actif' : 'Inactif'}</p>
                        </div>
                        <div class="detail-item">
                            <label>Date d'inscription</label>
                            <p>${formatDate(data.createdAt?.toDate())}</p>
                        </div>
                    </div>
                `;
                

await loadClassesForEditModal(studentType);
                document.getElementById('teacher-details-modal').classList.remove('hidden');
            } catch (error) {
                showAlert('Erreur: ' + error.message, 'error');
            }
        };

// Ajoutez cette fonction après les fonctions d'export existantes

// Fonction pour générer et imprimer la carte d'élève
window.printStudentCard = async (studentMatricule, studentType) => {
    try {
        let docRef;
        if (studentType === 'secondary') {
            docRef = doc(db, 'students', studentMatricule);
        } else if (studentType === 'primary') {
            docRef = doc(db, 'primary_students', studentMatricule);
        } else {
            docRef = doc(db, 'kindergarten_students', studentMatricule);
        }
        
        const studentSnap = await getDoc(docRef);
        
        if (!studentSnap.exists()) {
            showAlert('Élève non trouvé.', 'error');
            return;
        }
        
        const data = studentSnap.data();
        const studentTypeText = studentType === 'secondary' ? 'Secondaire' : 
                              studentType === 'primary' ? 'Primaire' : 'Maternelle';
        
        // Récupérer l'année scolaire
        const year = new Date().getFullYear();
        const nextYear = year + 1;
        
        // Créer une nouvelle fenêtre pour l'impression
        const printWindow = window.open('', '_blank');
        
        // HTML de la carte d'élève
        const cardHTML = `
            <!DOCTYPE html>
            <html>
            <head>
                <title>Carte d'Élève - ${data.fullName}</title>
                <style>
                    body {
                        font-family: 'Arial', sans-serif;
                        margin: 5;
                        padding: 12px;
                         background-color: #f0f0f0;
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        min-height: 80vh;
                    }
                    
                    .student-card {
                        width: 100mm; /* Format carte de crédit agrandi */
                        height: 150mm;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        border-radius: 15px;
                        padding: 20px;
                        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                        position: relative;
                        overflow: hidden;
                        color: white;
                        border: 2px solid gold;
                    }
                    
                    /* Effet de fond */
                    .student-card::before {
                        content: '';
                        position: absolute;
                        top: -50%;
                        right: -50%;
                        width: 200%;
                        height: 200%;
                        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
                        transform: rotate(30deg);
                    }
                    
                    /* En-tête avec deux photos */
                    .card-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 30px;
                        position: relative;
                        z-index: 2;
                    }
                    
                    .header-photo {
                        width: 50px;
                        height: 50px;
                        border-radius: 45%;
                        overflow: hidden;
                        border: 2px solid gold;
                        background: white;
                    }
                    
                    .header-photo img {
                        width: 100%;
                        height: 100%;
                        object-fit: cover;
                    }
                    
                    .header-photo.left {
                        background: linear-gradient(135deg, #3498db, #2980b9);
                    }
                    
                    .header-photo.right {
                        background: linear-gradient(135deg, #e74c3c, #c0392b);
                    }
                    
                    /* Photo principale au milieu */
                    .main-photo-container {
                        display: flex;
                        justify-content: center;
                        margin: 20px 0;
                        position: relative;
                        z-index: 2;
                    }
                    
                    .main-photo {
                        width: 100px;
                        height: 100px;
                        border-radius: 50%;
                        overflow: hidden;
                        border: 4px solid gold;
                        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                        background: white;
                    }
                    
                    .main-photo img {
                        width: 100%;
                        height: 100%;
                        object-fit: cover;
                    }
                    
                    /* Logo de l'école */
                    .school-logo {
                        text-align: center;
                        margin: 10px 0;
                        position: relative;
                        z-index: 2;
                    }
                    
                    .school-logo h3 {
                        margin: 0;
                        font-size: 16px;
                        font-weight: bold;
                        text-transform: uppercase;
                        letter-spacing: 2px;
                    }
                    
                    .school-logo p {
                        margin: 5px 0 0;
                        font-size: 12px;
                        opacity: 0.9;
                    }
                    
                    /* Informations de l'élève */
                    .student-info {
                        margin-top: 30px;
                        position: relative;
                        z-index: 2;
                    }
                    
                    .info-row {
                        display: flex;
                        margin-bottom: 12px;
                        border-bottom: 1px solid rgba(255,255,255,0.2);
                        padding-bottom: 5px;
                    }
                    
                    .info-label {
                        width: 40%;
                        font-size: 11px;
                        font-weight: bold;
                        text-transform: uppercase;
                        opacity: 0.8;
                    }
                    
                    .info-value {
                        width: 60%;
                        font-size: 12px;
                        font-weight: 500;
                    }
                    
                    /* Matricule en bas */
                    .matricule-section {
                        margin-top: 30px;
                        text-align: center;
                        position: relative;
                        z-index: 2;
                    }
                    
                    .matricule-label {
                        font-size: 10px;
                        opacity: 0.7;
                        text-transform: uppercase;
                        letter-spacing: 1px;
                    }
                    
                    .matricule-number {
                        font-size: 16px;
                        font-weight: bold;
                        letter-spacing: 2px;
                        background: rgba(255,255,255,0.1);
                        padding: 5px;
                        border-radius: 5px;
                        margin-top: 5px;
                        font-family: 'Courier New', monospace;
                    }
                    
                    /* Année scolaire */
                    .school-year {
                        margin-top: 15px;
                        text-align: center;
                        font-size: 10px;
                        opacity: 0.6;
                        text-transform: uppercase;
                        position: relative;
                        z-index: 2;
                    }
                    
                    /* Signature */
                    .signature {
                        margin-top: 20px;
                        display: flex;
                        justify-content: space-between;
                        font-size: 9px;
                        position: relative;
                        z-index: 2;
                    }
                    
                    .signature-item {
                        text-align: center;
                    }
                    
                    .signature-line {
                        width: 80px;
                        height: 1px;
                        background: rgba(255,255,255,0.3);
                        margin-top: 5px;
                    }
                    
                    /* Hologramme (effet) */
                    .hologram {
                        position: absolute;
                        bottom: 20px;
                        right: 20px;
                        width: 30px;
                        height: 30px;
                        background: radial-gradient(circle, gold 0%, transparent 70%);
                        border-radius: 50%;
                        opacity: 0.5;
                        z-index: 1;
                    }
                    
                    @media print {
                        body {
                            background: white;
                            padding: 0;
                        }
                        .student-card {
                            box-shadow: none;
                            border: 2px solid black;
                        }
                    }
                </style>
            </head>
            <body>
                <div class="student-card">
                    <!-- En-tête avec deux photos -->
                    <div class="card-header">
                        <div class="header-photo left">
                            ${data.photoURL ? 
                              `<img src="rd.png" alt="Photo gauche">` : 
                              '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;">👤</div>'}
                        </div>
                        <div class="header-photo right">
                            ${data.photoURL ? 
                              `<img src="cs.png" alt="Photo droite">` : 
                              '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;">👤</div>'}
                        </div>
                    </div>
                    
                    <!-- Logo de l'école -->
                    <div class="school-logo">
                        <h3>hybrilink</h3>
                        <p>CARTE D'ÉLÈVE</p>
                    </div>
                    
                    <!-- Photo principale au milieu -->
                    <div class="main-photo-container">
                        <div class="main-photo">
                            ${data.photoURL ? 
                              `<img src="${data.photoURL}" alt="Photo de ${data.fullName}">` : 
                              '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:#3498db;"><i class="fas fa-user" style="font-size:40px;color:white;"></i></div>'}
                        </div>
                    </div>
                    
                    <!-- Informations de l'élève -->
                    <div class="student-info">
                        <div class="info-row">
                            <span class="info-label">Nom complet</span>
                            <span class="info-value">${data.fullName}</span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">Date naissance</span>
                            <span class="info-value">${data.birthdate}</span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">Lieu naissance</span>
                            <span class="info-value">${data.birthplace || 'Non spécifié'}</span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">Classe</span>
                            <span class="info-value">${data.class}</span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">Type</span>
                            <span class="info-value">${studentTypeText}</span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">Parent</span>
                            <span class="info-value">${data.parentName}</span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">Tél parent</span>
                            <span class="info-value">${data.parentPhone}</span>
                        </div>
                    </div>
                    
                    <!-- Matricule -->
                    <div class="matricule-section">
                        <div class="matricule-label">Matricule</div>
                        <div class="matricule-number">${data.matricule}</div>
                    </div>
                    
                    <!-- Année scolaire -->
                    <div class="school-year">
                        Année Scolaire ${year}-${nextYear}
                    </div>
                    
                    <!-- Signatures -->
                    <div class="signature">
                        <div class="signature-item">
                            <div>Le Secrétaire</div>
                            <div class="signature-line"></div>
                        </div>
                        <div class="signature-item">
                            <div>Le Directeur</div>
                            <div class="signature-line"></div>
                        </div>
                    </div>
                    
                    <!-- Hologramme (effet visuel) -->
                    <div class="hologram"></div>
                </div>
                
                <script>
                    window.onload = function() {
                        window.print();
                        setTimeout(function() {
                            window.close();
                        }, 1000);
                    }
                <\/script>
            </body>
            </html>
        `;
        
        printWindow.document.write(cardHTML);
        printWindow.document.close();
        
    } catch (error) {
        console.error("Erreur génération carte:", error);
        showAlert("Erreur lors de la génération de la carte: " + error.message, "error");
    }
};

        window.editStudent = async (studentMatricule, studentType) => {
    try {
                let collectionName, docRef;
                if (studentType === 'secondary') {
                    collectionName = 'students';
                    docRef = doc(db, collectionName, studentMatricule);
                } else if (studentType === 'primary') {
                    collectionName = 'primary_students';
                    docRef = doc(db, collectionName, studentMatricule);
                } else {
                    collectionName = 'kindergarten_students';
                    docRef = doc(db, collectionName, studentMatricule);
                }
                
                const studentSnap = await getDoc(docRef);
                
                if (!studentSnap.exists()) {
                    showAlert('Élève non trouvé.', 'error');
                    return;
                }
                
                const data = studentSnap.data();
                
                // Remplir le formulaire de modification
                document.getElementById('edit-student-id').value = studentMatricule;
                document.getElementById('edit-student-collection').value = collectionName;
                document.getElementById('edit-student-name').value = data.fullName;
                document.getElementById('edit-student-birthdate').value = data.birthdate;
                document.getElementById('edit-student-birthplace').value = data.birthplace || '';
                document.getElementById('edit-student-gender').value = data.gender || '';
                document.getElementById('edit-student-address').value = data.address || '';
                document.getElementById('edit-student-phone').value = data.phone || '';
                document.getElementById('edit-student-class').value = data.class;
                document.getElementById('edit-student-fees').value = data.enrollmentFees || 0;
                document.getElementById('edit-parent-name').value = data.parentName;
                document.getElementById('edit-parent-phone').value = data.parentPhone;
                document.getElementById('edit-parent-address').value = data.parentAddress || '';
                document.getElementById('edit-student-status').value = data.status;
                
                // Charger les classes dans le select
                const classSelect = document.getElementById('edit-student-class');
                classSelect.innerHTML = '<option value="">-- Sélectionner --</option>';
                
                let classesSnap;
                if (studentType === 'secondary') {
                    classesSnap = await getDocs(collection(db, 'classes'));
                } else if (studentType === 'primary') {
                    classesSnap = await getDocs(collection(db, 'primary_classes'));
                } else {
                    classesSnap = await getDocs(collection(db, 'kindergarten_classes'));
                }
                
                classesSnap.forEach(doc => {
                    const classData = doc.data();
                    classSelect.innerHTML += `<option value="${classData.name}">${classData.name}</option>`;
                });
                
                // Sélectionner la classe actuelle
                classSelect.value = data.class;
                
                // Afficher ou masquer le champ téléphone
                const phoneContainer = document.getElementById('edit-student-phone-container');
                if (studentType === 'secondary') {
                    phoneContainer.style.display = 'block';
                } else {
                    phoneContainer.style.display = 'none';
                }
                
                document.getElementById('edit-student-modal').classList.remove('hidden');
            } catch (error) {
                showAlert('Erreur: ' + error.message, 'error');
            }
        };

        window.editTeacher = async (teacherMatricule, teacherType) => {
            try {
                let collectionName, docRef;
                if (teacherType === 'secondary') {
                    collectionName = 'teachers';
                    docRef = doc(db, collectionName, teacherMatricule);
                } else if (teacherType === 'primary') {
                    collectionName = 'primary_teachers';
                    docRef = doc(db, collectionName, teacherMatricule);
                } else {
                    collectionName = 'kindergarten_teachers';
                    docRef = doc(db, collectionName, teacherMatricule);
                }
                
                const teacherSnap = await getDoc(docRef);
                
                if (!teacherSnap.exists()) {
                    showAlert('Enseignant non trouvé.', 'error');
                    return;
                }
                
                const data = teacherSnap.data();
                
                // Remplir le formulaire de modification
                document.getElementById('edit-teacher-id').value = teacherMatricule;
                document.getElementById('edit-teacher-collection').value = collectionName;
                document.getElementById('edit-teacher-name').value = data.fullName;
                document.getElementById('edit-teacher-birthdate').value = data.birthdate;
                document.getElementById('edit-teacher-birthplace').value = data.birthplace || '';
                document.getElementById('edit-teacher-gender').value = data.gender || '';
                document.getElementById('edit-teacher-address').value = data.address || '';
                document.getElementById('edit-teacher-phone').value = data.phone || '';
                document.getElementById('edit-teacher-subjects').value = data.subjects ? data.subjects.join(', ') : '';
                document.getElementById('edit-teacher-status').value = data.status;
                
                // Charger les classes dans le container
                const container = document.getElementById('edit-teacher-classes-container');
                container.innerHTML = '';
                
                let classesSnap;
                if (teacherType === 'secondary') {
                    classesSnap = await getDocs(collection(db, 'classes'));
                } else if (teacherType === 'primary') {
                    classesSnap = await getDocs(collection(db, 'primary_classes'));
                } else {
                    classesSnap = await getDocs(collection(db, 'kindergarten_classes'));
                }
                
                classesSnap.forEach(doc => {
                    const classData = doc.data();
                    const isChecked = data.classes && data.classes.includes(classData.name);
                    container.innerHTML += `
                        <div class="class-checkbox">
                            <input type="checkbox" id="edit-class-${doc.id}" value="${classData.name}" ${isChecked ? 'checked' : ''}>
                            <label for="edit-class-${doc.id}">${classData.name}</label>
                        </div>
                    `;
                });
                
                // Afficher ou masquer le champ matières
                const subjectsContainer = document.getElementById('edit-teacher-subjects-container');
                if (teacherType === 'secondary') {
                    subjectsContainer.style.display = 'block';
                } else {
                    subjectsContainer.style.display = 'none';
                }
                
                document.getElementById('edit-teacher-modal').classList.remove('hidden');
            } catch (error) {
                showAlert('Erreur: ' + error.message, 'error');
            }
        };

        // Gestion des formulaires de modification
        document.getElementById('edit-student-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const studentId = document.getElementById('edit-student-id').value;
            const collectionName = document.getElementById('edit-student-collection').value;
            const fullName = document.getElementById('edit-student-name').value;
            const birthdate = document.getElementById('edit-student-birthdate').value;
            const birthplace = document.getElementById('edit-student-birthplace').value;
            const gender = document.getElementById('edit-student-gender').value;
            const address = document.getElementById('edit-student-address').value;
            const phone = document.getElementById('edit-student-phone').value;
            const studentClass = document.getElementById('edit-student-class').value;
            const enrollmentFees = parseFloat(document.getElementById('edit-student-fees').value) || 0;
            const parentName = document.getElementById('edit-parent-name').value;
            const parentPhone = document.getElementById('edit-parent-phone').value;
            const parentAddress = document.getElementById('edit-parent-address').value;
            const status = document.getElementById('edit-student-status').value;
            
            try {
                const updateData = {
                    fullName,
                    birthdate,
                    birthplace,
                    gender,
                    address,
                    class: studentClass,
                    enrollmentFees,
                    parentName,
                    parentPhone,
                    parentAddress,
                    status,
                    updatedAt: serverTimestamp()
                };
                
                // Ajouter le téléphone seulement pour les élèves secondaires
                if (collectionName === 'students') {
                    updateData.phone = phone;
                }
                
                await updateDoc(doc(db, collectionName, studentId), updateData);
                
                showAlert('Élève modifié avec succès !', 'success');
                document.getElementById('edit-student-modal').classList.add('hidden');
                
                // Recharger les données
                loadStudentsList();
                loadDashboardStats();
                if (collectionName === 'students') {
                    loadClassesList();
                } else if (collectionName === 'primary_students') {
                    loadPrimaryClassesList();
                } else {
                    loadKindergartenClassesList();
                }
                
            } catch (error) {
                showAlert('Erreur lors de la modification: ' + error.message, 'error');
            }
        });

        document.getElementById('edit-teacher-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const teacherId = document.getElementById('edit-teacher-id').value;
            const collectionName = document.getElementById('edit-teacher-collection').value;
            const fullName = document.getElementById('edit-teacher-name').value;
            const birthdate = document.getElementById('edit-teacher-birthdate').value;
            const birthplace = document.getElementById('edit-teacher-birthplace').value;
            const gender = document.getElementById('edit-teacher-gender').value;
            const address = document.getElementById('edit-teacher-address').value;
            const phone = document.getElementById('edit-teacher-phone').value;
            const subjects = document.getElementById('edit-teacher-subjects').value.split(',').map(s => s.trim());
            const status = document.getElementById('edit-teacher-status').value;
            
            // Récupérer les classes sélectionnées
            const selectedClasses = [];
            document.querySelectorAll('#edit-teacher-classes-container input[type="checkbox"]:checked').forEach(checkbox => {
                selectedClasses.push(checkbox.value);
            });
            
            try {
                const updateData = {
                    fullName,
                    birthdate,
                    birthplace,
                    gender,
                    address,
                    phone,
                    classes: selectedClasses,
                    status,
                    updatedAt: serverTimestamp()
                };
                
                // Ajouter les matières seulement pour les enseignants secondaires
                if (collectionName === 'teachers') {
                    updateData.subjects = subjects;
                }
                
                await updateDoc(doc(db, collectionName, teacherId), updateData);
                
                showAlert('Enseignant modifié avec succès !', 'success');
                document.getElementById('edit-teacher-modal').classList.add('hidden');
                
                // Recharger les données
                loadTeachersList();
                loadDashboardStats();
                
            } catch (error) {
                showAlert('Erreur lors de la modification: ' + error.message, 'error');
            }
        });

        window.editClass = async (classId, classType) => {
            try {
                let classDoc;
                if (classType === 'secondary') {
                    classDoc = await getDoc(doc(db, 'classes', classId));
                } else if (classType === 'primary') {
                    classDoc = await getDoc(doc(db, 'primary_classes', classId));
                } else {
                    classDoc = await getDoc(doc(db, 'kindergarten_classes', classId));
                }
                
                if (!classDoc.exists()) {
                    showAlert('Classe non trouvée.', 'error');
                    return;
                }
                
                const data = classDoc.data();
                
                // Remplir le formulaire de modification selon le type
                if (classType === 'secondary') {
                    document.getElementById('class-name').value = data.name;
                    document.getElementById('class-level').value = data.level;
                    document.getElementById('class-capacity').value = data.capacity;
                    
                    // Mettre à jour le bouton pour modification
                    const submitBtn = document.querySelector('#class-form button[type="submit"]');
                    const originalOnClick = submitBtn.onclick;
                    
                    submitBtn.textContent = 'Modifier la Classe';
                    submitBtn.onclick = async (e) => {
                        e.preventDefault();
                        const name = document.getElementById('class-name').value;
                        const level = document.getElementById('class-level').value;
                        const capacity = document.getElementById('class-capacity').value;
                        
                        try {
                            await updateDoc(doc(db, 'classes', classId), {
                                name,
                                level,
                                capacity: parseInt(capacity),
                                updatedAt: serverTimestamp()
                            });
                            
                            showAlert('Classe secondaire modifiée avec succès !', 'success');
                            document.getElementById('class-form').reset();
                            submitBtn.textContent = 'Ajouter';
                            submitBtn.onclick = originalOnClick;
                            loadClassesList();
                            loadClassesIntoSelects();
                            loadTeacherClasses();
                        } catch (error) {
                            showAlert('Erreur lors de la modification: ' + error.message, 'error');
                        }
                    };
                } else if (classType === 'primary') {
                    document.getElementById('primary-class-name').value = data.name;
                    document.getElementById('primary-class-level').value = data.level;
                    document.getElementById('primary-class-capacity').value = data.capacity;
                    
                    // Mettre à jour le bouton pour modification
                    const submitBtn = document.querySelector('#primary-class-form button[type="submit"]');
                    const originalOnClick = submitBtn.onclick;
                    
                    submitBtn.textContent = 'Modifier la Classe';
                    submitBtn.onclick = async (e) => {
                        e.preventDefault();
                        const name = document.getElementById('primary-class-name').value;
                        const level = document.getElementById('primary-class-level').value;
                        const capacity = document.getElementById('primary-class-capacity').value;
                        
                        try {
                            await updateDoc(doc(db, 'primary_classes', classId), {
                                name,
                                level,
                                capacity: parseInt(capacity),
                                updatedAt: serverTimestamp()
                            });
                            
                            showAlert('Classe primaire modifiée avec succès !', 'success');
                            document.getElementById('primary-class-form').reset();
                            submitBtn.textContent = 'Ajouter';
                            submitBtn.onclick = originalOnClick;
                            loadPrimaryClassesList();
                            loadClassesIntoSelects();
                            loadPrimaryTeacherClasses();
                        } catch (error) {
                            showAlert('Erreur lors de la modification: ' + error.message, 'error');
                        }
                    };
                } else {
                    document.getElementById('kindergarten-class-name').value = data.name;
                    document.getElementById('kindergarten-class-level').value = data.level;
                    document.getElementById('kindergarten-class-capacity').value = data.capacity;
                    
                    // Mettre à jour le bouton pour modification
                    const submitBtn = document.querySelector('#kindergarten-class-form button[type="submit"]');
                    const originalOnClick = submitBtn.onclick;
                    
                    submitBtn.textContent = 'Modifier la Classe';
                    submitBtn.onclick = async (e) => {
                        e.preventDefault();
                        const name = document.getElementById('kindergarten-class-name').value;
                        const level = document.getElementById('kindergarten-class-level').value;
                        const capacity = document.getElementById('kindergarten-class-capacity').value;
                        
                        try {
                            await updateDoc(doc(db, 'kindergarten_classes', classId), {
                                name,
                                level,
                                capacity: parseInt(capacity),
                                updatedAt: serverTimestamp()
                            });
                            
                            showAlert('Classe maternelle modifiée avec succès !', 'success');
                            document.getElementById('kindergarten-class-form').reset();
                            submitBtn.textContent = 'Ajouter';
                            submitBtn.onclick = originalOnClick;
                            loadKindergartenClassesList();
                            loadClassesIntoSelects();
                            loadKindergartenTeacherClasses();
                        } catch (error) {
                            showAlert('Erreur lors de la modification: ' + error.message, 'error');
                        }
                    };
                }
                
            } catch (error) {
                showAlert('Erreur: ' + error.message, 'error');
            }
        };

        // FONCTION DE SUPPRESSION DES CLASSES
        window.deleteClass = async (classId, classType) => {
            if (confirm('Êtes-vous sûr de vouloir supprimer cette classe ? Cette action est irréversible.')) {
                try {
                    let classDoc, collectionName, studentCollection;
                    if (classType === 'secondary') {
                        classDoc = await getDoc(doc(db, 'classes', classId));
                        collectionName = 'classes';
                        studentCollection = 'students';
                    } else if (classType === 'primary') {
                        classDoc = await getDoc(doc(db, 'primary_classes', classId));
                        collectionName = 'primary_classes';
                        studentCollection = 'primary_students';
                    } else {
                        classDoc = await getDoc(doc(db, 'kindergarten_classes', classId));
                        collectionName = 'kindergarten_classes';
                        studentCollection = 'kindergarten_students';
                    }
                    
                    if (!classDoc.exists()) {
                        showAlert('Classe non trouvée.', 'error');
                        return;
                    }
                    
                    const classData = classDoc.data();
                    
                    // Vérifier si des étudiants sont dans cette classe
                    const studentsInClass = await getDocs(query(collection(db, studentCollection), where('class', '==', classData.name)));
                    
                    if (!studentsInClass.empty) {
                        showAlert(`Impossible de supprimer cette classe. ${studentsInClass.size} élève(s) sont encore inscrits dans cette classe.`, 'error');
                        return;
                    }
                    
                    await deleteDoc(doc(db, collectionName, classId));
                    showAlert('Classe supprimée avec succès', 'success');
                    
                    if (classType === 'secondary') {
                        loadClassesList();
                    } else if (classType === 'primary') {
                        loadPrimaryClassesList();
                    } else {
                        loadKindergartenClassesList();
                    }
                    
                    loadClassesIntoSelects();
                    loadTeacherClasses();
                    loadPrimaryTeacherClasses();
                    loadKindergartenTeacherClasses();
                } catch (error) {
                    console.error('Erreur suppression classe:', error);
                    showAlert('Erreur lors de la suppression: ' + error.message, 'error');
                }
            }
        };

        // FONCTION DE SUPPRESSION DES ÉLÈVES (COMPLÈTE)
        window.deleteStudent = async (studentMatricule, studentType) => {
            if (confirm('Êtes-vous sûr de vouloir supprimer cet élève ? Cette action est irréversible.')) {
                try {
                    let studentDoc, collectionName;
                    if (studentType === 'secondary') {
                        studentDoc = await getDoc(doc(db, 'students', studentMatricule));
                        collectionName = 'students';
                    } else if (studentType === 'primary') {
                        studentDoc = await getDoc(doc(db, 'primary_students', studentMatricule));
                        collectionName = 'primary_students';
                    } else {
                        studentDoc = await getDoc(doc(db, 'kindergarten_students', studentMatricule));
                        collectionName = 'kindergarten_students';
                    }
                    
                    if (!studentDoc.exists()) {
                        showAlert('Élève non trouvé.', 'error');
                        return;
                    }
                    
                    const studentData = studentDoc.data();
                    
                    // Marquer comme supprimé dans Firestore
                    await updateDoc(doc(db, collectionName, studentMatricule), {
                        status: 'deleted',
                        deletedAt: serverTimestamp(),
                        deletedBy: currentSecretary.uid
                    });
                    
                    showAlert('Élève marqué comme supprimé', 'success');
                    loadStudentsList();
                    loadDashboardStats();
                } catch (error) {
                    console.error('Erreur suppression élève:', error);
                    showAlert('Erreur lors de la suppression: ' + error.message, 'error');
                }
            }
        };

        // FONCTION DE SUPPRESSION DES ENSEIGNANTS (COMPLÈTE)
        window.deleteTeacher = async (teacherMatricule, teacherType) => {
            if (confirm('Êtes-vous sûr de vouloir supprimer cet enseignant ? Cette action est irréversible.')) {
                try {
                    let teacherDoc, collectionName;
                    if (teacherType === 'secondary') {
                        teacherDoc = await getDoc(doc(db, 'teachers', teacherMatricule));
                        collectionName = 'teachers';
                    } else if (teacherType === 'primary') {
                        teacherDoc = await getDoc(doc(db, 'primary_teachers', teacherMatricule));
                        collectionName = 'primary_teachers';
                    } else {
                        teacherDoc = await getDoc(doc(db, 'kindergarten_teachers', teacherMatricule));
                        collectionName = 'kindergarten_teachers';
                    }
                    
                    if (!teacherDoc.exists()) {
                        showAlert('Enseignant non trouvé.', 'error');
                        return;
                    }
                    
                    const teacherData = teacherDoc.data();
                    
                    // Marquer comme supprimé dans Firestore
                    await updateDoc(doc(db, collectionName, teacherMatricule), {
                        status: 'deleted',
                        deletedAt: serverTimestamp(),
                        deletedBy: currentSecretary.uid
                    });
                    
                    showAlert('Enseignant marqué comme supprimé', 'success');
                    loadTeachersList();
                    loadDashboardStats();
                } catch (error) {
                    console.error('Erreur suppression enseignant:', error);
                    showAlert('Erreur lors de la suppression: ' + error.message, 'error');
                }
            }
        };

        window.validatePaymentByCode = async (paymentCode) => {
            document.getElementById('payment-code-input').value = paymentCode;
            document.getElementById('find-payment-btn').click();
        };

        // Fonction pour exporter les élèves d'une classe spécifique
        window.exportClassStudents = async (className, classType) => {
            try {
                let students = [];
                
                if (classType === 'secondary') {
                    const studentsSnap = await getDocs(query(collection(db, 'students'), where('class', '==', className), where('status', '!=', 'deleted')));
                    studentsSnap.forEach(doc => {
                        const data = doc.data();
                        students.push({...data, studentType: 'secondary'});
                    });
                } else if (classType === 'primary') {
                    const studentsSnap = await getDocs(query(collection(db, 'primary_students'), where('class', '==', className), where('status', '!=', 'deleted')));
                    studentsSnap.forEach(doc => {
                        const data = doc.data();
                        students.push({...data, studentType: 'primary'});
                    });
                                } else {
                    const studentsSnap = await getDocs(query(collection(db, 'kindergarten_students'), where('class', '==', className), where('status', '!=', 'deleted')));
                    studentsSnap.forEach(doc => {
                        const data = doc.data();
                        students.push({...data, studentType: 'kindergarten'});
                    });
                }

                if (students.length === 0) {
                    showAlert("Aucun élève dans cette classe", "warning");
                    return;
                }

                // Préparer les données pour l'export
                const exportData = students.map(student => ({
                    'Matricule': student.matricule,
                    'Nom complet': student.fullName,
                    'Type': student.studentType === 'secondary' ? 'Secondaire' : 
                           student.studentType === 'primary' ? 'Primaire' : 'Maternelle',
                    'Classe': student.class,
                    'Date de naissance': student.birthdate,
                    'Lieu de naissance': student.birthplace || '',
                    'Sexe': student.gender === 'M' ? 'Masculin' : 'Féminin',
                    'Adresse': student.address || '',
                    'Téléphone': student.phone || '',
                    'Frais inscription': student.enrollmentFees || 0,
                    'Nom parent': student.parentName,
                    'Téléphone parent': student.parentPhone,
                    'Adresse parent': student.parentAddress || '',
                    'Statut': student.status === 'active' ? 'Actif' : 'Inactif',
                    'Date inscription': formatDate(student.createdAt?.toDate())
                }));

                // Exporter en Excel
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, `Élèves ${className}`);

                // Appliquer des styles
                const range = XLSX.utils.decode_range(ws['!ref']);
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const address = XLSX.utils.encode_col(C) + "1";
                    if (!ws[address]) continue;
                    ws[address].s = {
                        font: { bold: true, color: { rgb: "FFFFFF" } },
                        fill: { fgColor: { rgb: "3498DB" } },
                        alignment: { horizontal: "center" }
                    };
                }

                XLSX.writeFile(wb, `eleves_${className}_${new Date().toISOString().split('T')[0]}.xlsx`);
                showAlert(`Export réussi: ${students.length} élève(s) exporté(s)`, "success");

            } catch (error) {
                console.error("Erreur export classe:", error);
                showAlert("Erreur lors de l'export", "error");
            }
        };

        // Fonction pour exporter les enseignants d'une classe spécifique
        window.exportClassTeachers = async (className, classType) => {
            try {
                let teachers = [];

                // Rechercher tous les enseignants qui enseignent dans cette classe
                if (classType === 'secondary') {
                    const teachersSnap = await getDocs(query(collection(db, 'teachers'), where('status', '!=', 'deleted')));
                    teachersSnap.forEach(doc => {
                        const data = doc.data();
                        if (data.classes && data.classes.includes(className)) {
                            teachers.push({...data, teacherType: 'secondary'});
                        }
                    });
                } else if (classType === 'primary') {
                    const teachersSnap = await getDocs(query(collection(db, 'primary_teachers'), where('status', '!=', 'deleted')));
                    teachersSnap.forEach(doc => {
                        const data = doc.data();
                        if (data.classes && data.classes.includes(className)) {
                            teachers.push({...data, teacherType: 'primary'});
                        }
                    });
                } else {
                    const teachersSnap = await getDocs(query(collection(db, 'kindergarten_teachers'), where('status', '!=', 'deleted')));
                    teachersSnap.forEach(doc => {
                        const data = doc.data();
                        if (data.classes && data.classes.includes(className)) {
                            teachers.push({...data, teacherType: 'kindergarten'});
                        }
                    });
                }

                if (teachers.length === 0) {
                    showAlert("Aucun enseignant pour cette classe", "warning");
                    return;
                }

                // Préparer les données pour l'export
                const exportData = teachers.map(teacher => ({
                    'Matricule': teacher.matricule,
                    'Nom complet': teacher.fullName,
                    'Type': teacher.teacherType === 'secondary' ? 'Secondaire' : 
                           teacher.teacherType === 'primary' ? 'Primaire' : 'Maternelle',
                    'Téléphone': teacher.phone || '',
                    'Date de naissance': teacher.birthdate,
                    'Lieu de naissance': teacher.birthplace || '',
                    'Sexe': teacher.gender === 'M' ? 'Masculin' : 'Féminin',
                    'Adresse': teacher.address || '',
                    'Matières': teacher.subjects ? teacher.subjects.join(', ') : 'Toutes matières',
                    'Classes': teacher.classes ? teacher.classes.join(', ') : '',
                    'Statut': teacher.status === 'active' ? 'Actif' : 'Inactif',
                    'Date inscription': formatDate(teacher.createdAt?.toDate())
                }));

                // Exporter en Excel
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, `Enseignants ${className}`);

                // Appliquer des styles
                const range = XLSX.utils.decode_range(ws['!ref']);
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const address = XLSX.utils.encode_col(C) + "1";
                    if (!ws[address]) continue;
                    ws[address].s = {
                        font: { bold: true, color: { rgb: "FFFFFF" } },
                        fill: { fgColor: { rgb: "3498DB" } },
                        alignment: { horizontal: "center" }
                    };
                }

                XLSX.writeFile(wb, `enseignants_${className}_${new Date().toISOString().split('T')[0]}.xlsx`);
                showAlert(`Export réussi: ${teachers.length} enseignant(s) exporté(s)`, "success");

            } catch (error) {
                console.error("Erreur export enseignants classe:", error);
                showAlert("Erreur lors de l'export", "error");
            }
        };

        // Fonction pour afficher les détails d'une classe
        window.viewClassDetails = async (className, classType) => {
    try {
        let students = [];
        
        // NOUVELLE APPROCHE : Récupérer tous puis filtrer localement
        if (classType === 'secondary') {
            const studentsSnap = await getDocs(collection(db, 'students'));
            studentsSnap.forEach(doc => {
                const data = doc.data();
                if (data.class === className && data.status !== 'deleted') {
                    students.push(data);
                }
            });
        } else if (classType === 'primary') {
            const studentsSnap = await getDocs(collection(db, 'primary_students'));
            studentsSnap.forEach(doc => {
                const data = doc.data();
                if (data.class === className && data.status !== 'deleted') {
                    students.push(data);
                }
            });
        } else {
            const studentsSnap = await getDocs(collection(db, 'kindergarten_students'));
            studentsSnap.forEach(doc => {
                const data = doc.data();
                if (data.class === className && data.status !== 'deleted') {
                    students.push(data);
                }
            });
        }

        const modalContent = document.getElementById('student-details-content');
        const typeText = classType === 'secondary' ? 'Secondaire' : 
                       classType === 'primary' ? 'Primaire' : 'Maternelle';
        
        let studentsHTML = '';
        if (students.length > 0) {
            studentsHTML = '<div style="max-height: 300px; overflow-y: auto;">';
            students.forEach(student => {
                studentsHTML += `
                    <div style="padding: 10px; border-bottom: 1px solid #eee; margin-bottom: 5px;">
                        <strong>${student.fullName}</strong><br>
                        <small>Matricule: ${student.matricule} | Date naissance: ${student.birthdate}</small>
                    </div>
                `;
            });
            studentsHTML += '</div>';
        } else {
            studentsHTML = '<p>Aucun élève dans cette classe</p>';
        }

        modalContent.innerHTML = `
            <div class="student-details">
                <div class="detail-item">
                    <label>Classe</label>
                    <p>${className}</p>
                </div>
                <div class="detail-item">
                    <label>Type</label>
                    <p>${typeText}</p>
                </div>
                <div class="detail-item">
                    <label>Nombre d'élèves</label>
                    <p>${students.length}</p>
                </div>
                <div class="detail-item">
                    <label>Liste des élèves</label>
                    ${studentsHTML}
                </div>
            </div>
        `;

        document.getElementById('student-details-modal').classList.remove('hidden');

    } catch (error) {
        console.error("Erreur affichage détails classe:", error);
        showAlert("Erreur lors du chargement des détails", "error");
    }
};

        // Génération de reçu
        async function generateReceipt(studentName, months, amount, paymentCode, studentClass, paymentType) {
    const receiptContent = document.getElementById('receipt-content');
    
    // Adapter l'affichage pour les frais d'inscription
    const monthsDisplay = paymentType === 'Frais d\'inscription' ? 'Inscription' : months.join(', ');
    
    const receiptHTML = `
        <div class="receipt">
            <div class="receipt-header">
                <div class="receipt-logo">
                    <img src="R.png" alt="Logo hybrilink" style="max-width: 150px;">
                </div>
                <div class="receipt-title">REÇU DE PAIEMENT</div>
                <div>hybrilink</div>
                <div>Code: ${paymentCode}</div>
            </div>
            
            <div class="receipt-details">
                <div class="receipt-row">
                    <span>Élève:</span>
                    <span>${studentName}</span>
                </div>
                <div class="receipt-row">
                    <span>Classe:</span>
                    <span>${studentClass}</span>
                </div>
                <div class="receipt-row">
                    <span>Type de frais:</span>
                    <span>${paymentType || 'Frais scolaires'}</span>
                </div>
                <div class="receipt-row">
                    <span>Période:</span>
                    <span>${monthsDisplay}</span>
                </div>
                <div class="receipt-row">
                    <span>Montant:</span>
                    <span class="currency-display">$${amount.toFixed(2)}</span>
                </div>
                <div class="receipt-divider"></div>
                <div class="receipt-row">
                    <span>Date:</span>
                    <span>${new Date().toLocaleDateString('fr-FR')}</span>
                </div>
                <div class="receipt-row">
                    <span>Validé par:</span>
                    <span>${currentSecretary.fullName}</span>
                </div>
            </div>
            
            <div class="signature-area">
                <div class="signature-box">
                    <p>Le Secrétaire</p>
                    <div class="signature-line"></div>
                </div>
                <div class="signature-box">
                    <p>Le Directeur</p>
                    <div class="signature-line"></div>
                </div>
            </div>
            
            <div class="receipt-footer">
                <p>Merci pour votre confiance</p>
                <p>hybrilink</p>
            </div>
        </div>
    `;
    
    receiptContent.innerHTML = receiptHTML;
    document.getElementById('receipt-modal').classList.remove('hidden');
}

        // Impression du reçu
        document.getElementById('print-receipt-btn').addEventListener('click', () => {
            const receiptContent = document.getElementById('receipt-content').innerHTML;
            const printWindow = window.open('', '_blank');
            
            const printHTML = `
                <!DOCTYPE html>
                <html>
                    <head>
                        <title>Reçu de paiement - hybrilink</title>
                        <style>
                            body { 
                                font-family: Arial, sans-serif; 
                                margin: 20px; 
                                font-size: 12px;
                            }
                            .receipt { 
                                max-width: 600px; 
                                margin: 0 auto; 
                                border: 1px solid #ddd; 
                                padding: 20px; 
                            }
                            .receipt-header { 
                                text-align: center; 
                                margin-bottom: 20px; 
                                border-bottom: 2px solid #3498db; 
                                padding-bottom: 1rem; 
                            }
                            .receipt-title { 
                                font-size: 18px; 
                                font-weight: bold; 
                                margin: 10px 0; 
                                color: #3498db; 
                            }
                            .receipt-row { 
                                display: flex; 
                                justify-content: space-between; 
                                margin-bottom: 8px; 
                            }
                            .receipt-divider { 
                                border-top: 1px solid #ddd; 
                                margin: 15px 0; 
                            }
                            .signature-area { 
                                margin-top: 3rem; 
                                display: flex; 
                                justify-content: space-between; 
                            }
                            .signature-box { 
                                text-align: center; 
                                width: 45%; 
                            }
                            .signature-line { 
                                border-top: 1px solid #000; 
                                margin-top: 3rem; 
                            }
                            .receipt-footer { 
                                text-align: center; 
                                margin-top: 20px; 
                                font-size: 11px; 
                                color: #666; 
                                border-top: 1px solid #eee; 
                                padding-top: 1rem; 
                            }
                            .currency-display { 
                                font-weight: bold; 
                                color: #27ae60; 
                            }
                            @media print {
                                body { 
                                    margin: 0; 
                                    padding: 10px;
                                }
                                .receipt { 
                                    border: none; 
                                    box-shadow: none; 
                                }
                                .no-print {
                                    display: none !important;
                                }
                            }
                        </style>
                    </head>
                    <body>
                        ${receiptContent}
                        <script>
                            window.onload = function() {
                                window.print();
                                setTimeout(function() {
                                    window.close();
                                }, 1000);
                            }
                        <\/script>
                    </body>
                </html>
            `;
            
            printWindow.document.write(printHTML);
            printWindow.document.close();
        });

        // Impression du bordereau d'inscription
        window.printEnrollmentForm = async (studentType) => {
            try {
                if (!lastEnrolledStudent) {
                    showAlert("Aucun élève n'a été inscrit récemment.", "error");
                    return;
                }
                
                const studentData = lastEnrolledStudent;
                const enrollmentSlipContent = document.getElementById('enrollment-slip-content');
                
                const studentTypeText = studentType === 'secondary' ? 'Secondaire' : 
                                      studentType === 'primary' ? 'Primaire' : 'Maternelle';
                
                const enrollmentSlipHTML = `
                    <div class="receipt">
                        <div class="receipt-header">
                            <div class="receipt-logo">
                                <img src="R.png" alt="Logo CS la Colombe" style="max-width: 150px;">
                            </div>
                            <div class="receipt-title">BORDEREAU D'INSCRIPTION</div>
                            <div>hybrilink</div>
                            <div>Année scolaire: ${new Date().getFullYear()}-${new Date().getFullYear() + 1}</div>
                        </div>
                        
                        <div class="receipt-details">
                            <div class="receipt-row">
                                <span>Matricule:</span>
                                <span><strong>${studentData.matricule}</strong></span>
                            </div>
                            <div class="receipt-row">
                                <span>Nom complet:</span>
                                <span>${studentData.fullName}</span>
                            </div>
                            <div class="receipt-row">
                                <span>Type:</span>
                                <span>${studentTypeText}</span>
                            </div>
                            <div class="receipt-row">
                                <span>Classe:</span>
                                <span>${studentData.class}</span>
                            </div>
                            <div class="receipt-row">
                                <span>Date de naissance:</span>
                                <span>${studentData.birthdate}</span>
                            </div>
                            <div class="receipt-row">
                                <span>Lieu de naissance:</span>
                                <span>${studentData.birthplace || 'Non spécifié'}</span>
                            </div>
                            <div class="receipt-row">
                                <span>Sexe:</span>
                                <span>${studentData.gender === 'M' ? 'Masculin' : 'Féminin'}</span>
                            </div>
                            <div class="receipt-row">
                                <span>Adresse:</span>
                                <span>${studentData.address}</span>
                            </div>
                            ${studentType === 'secondary' ? `
                            <div class="receipt-row">
                                <span>Téléphone:</span>
                                <span>${studentData.phone || 'Non spécifié'}</span>
                            </div>` : ''}
                            <div class="receipt-divider"></div>
                            <div class="receipt-row">
                                <span>Nom du parent:</span>
                                <span>${studentData.parentName}</span>
                            </div>
                            <div class="receipt-row">
                                <span>Téléphone du parent:</span>
                                <span>${studentData.parentPhone}</span>
                            </div>
                            <div class="receipt-row">
                                <span>Adresse du parent:</span>
                                <span>${studentData.parentAddress || 'Non spécifié'}</span>
                            </div>
                            <div class="receipt-divider"></div>
                            <div class="receipt-row">
                                <span>Frais d'inscription:</span>
                                <span class="currency-display"><strong>$${(studentData.enrollmentFees || 0).toFixed(2)}</strong></span>
                            </div>
                            <div class="receipt-row">
                                <span>Date d'inscription:</span>
                                <span>${new Date().toLocaleDateString('fr-FR')}</span>
                            </div>
                            <div class="receipt-row">
                                <span>Inscrit par:</span>
                                <span>${currentSecretary.fullName}</span>
                            </div>
                        </div>
                        
                        <div class="signature-area">
                            <div class="signature-box">
                                <p>Le Secrétaire</p>
                                <div class="signature-line"></div>
                            </div>
                            <div class="signature-box">
                                <p>Le Directeur</p>
                                <div class="signature-line"></div>
                            </div>
                        </div>
                        
                        <div class="receipt-footer">
                            <p><strong>Important:</strong> Conservez ce bordereau pour toute référence future.</p>
                            <p>Merci pour votre confiance - hybrilink</p>
                        </div>
                    </div>
                `;
                
                enrollmentSlipContent.innerHTML = enrollmentSlipHTML;
                document.getElementById('enrollment-slip-modal').classList.remove('hidden');
                
            } catch (error) {
                console.error("Erreur génération bordereau:", error);
                showAlert("Erreur lors de la génération du bordereau", "error");
            }
        };

        // Bouton impression du bordereau
        document.getElementById('print-enrollment-slip-btn').addEventListener('click', () => {
            const enrollmentSlipContent = document.getElementById('enrollment-slip-content').innerHTML;
            const printWindow = window.open('', '_blank');
            
            const printHTML = `
                <!DOCTYPE html>
                <html>
                    <head>
                        <title>Bordereau d'inscription - hybrilink</title>
                        <style>
                            body { 
                                font-family: Arial, sans-serif; 
                                margin: 20px; 
                                font-size: 12px;
                            }
                            .receipt { 
                                max-width: 600px; 
                                margin: 0 auto; 
                                border: 1px solid #ddd; 
                                padding: 20px; 
                            }
                            .receipt-header { 
                                text-align: center; 
                                margin-bottom: 20px; 
                                border-bottom: 2px solid #3498db; 
                                padding-bottom: 1rem; 
                            }
                            .receipt-title { 
                                font-size: 18px; 
                                font-weight: bold; 
                                margin: 10px 0; 
                                color: #3498db; 
                            }
                            .receipt-row { 
                                display: flex; 
                                justify-content: space-between; 
                                margin-bottom: 8px; 
                            }
                            .receipt-divider { 
                                border-top: 1px solid #ddd; 
                                margin: 15px 0; 
                            }
                            .signature-area { 
                                margin-top: 3rem; 
                                display: flex; 
                                justify-content: space-between; 
                            }
                            .signature-box { 
                                text-align: center; 
                                width: 45%; 
                            }
                            .signature-line { 
                                border-top: 1px solid #000; 
                                margin-top: 3rem; 
                            }
                            .receipt-footer { 
                                text-align: center; 
                                margin-top: 20px; 
                                font-size: 11px; 
                                color: #666; 
                                border-top: 1px solid #eee; 
                                padding-top: 1rem; 
                            }
                            .currency-display { 
                                font-weight: bold; 
                                color: #27ae60; 
                            }
                            @media print {
                                body { 
                                    margin: 0; 
                                    padding: 10px;
                                }
                                .receipt { 
                                    border: none; 
                                    box-shadow: none; 
                                }
                                .no-print {
                                    display: none !important;
                                }
                            }
                        </style>
                    </head>
                    <body>
                        ${enrollmentSlipContent}
                        <script>
                            window.onload = function() {
                                window.print();
                                setTimeout(function() {
                                    window.close();
                                }, 1000);
                            }
                        <\/script>
                    </body>
                </html>
            `;
            
            printWindow.document.write(printHTML);
            printWindow.document.close();
        });

        // Bouton retour pour le bordereau
        document.getElementById('back-enrollment-slip-btn').addEventListener('click', () => {
            document.getElementById('enrollment-slip-modal').classList.add('hidden');
        });

        // Bouton retour pour le reçu
        document.getElementById('back-receipt-btn').addEventListener('click', () => {
            document.getElementById('receipt-modal').classList.add('hidden');
        });

        // Export Excel des élèves
        document.getElementById('export-students-excel-btn').addEventListener('click', async () => {
            try {
                let students = [];
                
                // Récupérer tous les élèves
                const secondarySnap = await getDocs(query(collection(db, 'students'), where('status', '!=', 'deleted')));
                secondarySnap.forEach(doc => {
                    const data = doc.data();
                    students.push({...data, studentType: 'secondary'});
                });
                
                const primarySnap = await getDocs(query(collection(db, 'primary_students'), where('status', '!=', 'deleted')));
                primarySnap.forEach(doc => {
                    const data = doc.data();
                    students.push({...data, studentType: 'primary'});
                });
                
                const kindergartenSnap = await getDocs(query(collection(db, 'kindergarten_students'), where('status', '!=', 'deleted')));
                kindergartenSnap.forEach(doc => {
                    const data = doc.data();
                    students.push({...data, studentType: 'kindergarten'});
                });
                
                if (students.length === 0) {
                    showAlert("Aucun élève à exporter", "warning");
                    return;
                }
                
                // Préparer les données pour l'export
                const exportData = students.map(student => ({
                    'Matricule': student.matricule,
                    'Nom complet': student.fullName,
                    'Type': student.studentType === 'secondary' ? 'Secondaire' : 
                           student.studentType === 'primary' ? 'Primaire' : 'Maternelle',
                    'Classe': student.class,
                    'Date de naissance': student.birthdate,
                    'Lieu de naissance': student.birthplace || '',
                    'Sexe': student.gender === 'M' ? 'Masculin' : 'Féminin',
                    'Adresse': student.address || '',
                    'Téléphone': student.phone || '',
                    'Frais inscription': student.enrollmentFees || 0,
                    'Nom parent': student.parentName,
                    'Téléphone parent': student.parentPhone,
                    'Adresse parent': student.parentAddress || '',
                    'Statut': student.status === 'active' ? 'Actif' : 'Inactif',
                    'Date inscription': formatDate(student.createdAt?.toDate())
                }));
                
                // Créer le fichier Excel avec mise en forme
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Élèves CS la Colombe");
                
                // Appliquer des styles aux en-têtes
                const range = XLSX.utils.decode_range(ws['!ref']);
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const address = XLSX.utils.encode_col(C) + "1";
                    if (!ws[address]) continue;
                    ws[address].s = {
                        font: { bold: true, color: { rgb: "FFFFFF" } },
                        fill: { fgColor: { rgb: "3498DB" } },
                        alignment: { horizontal: "center" }
                    };
                }
                
                // Ajuster les largeurs de colonnes
                const colWidths = [];
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    let maxLength = 0;
                    for (let R = range.s.r; R <= range.e.r; ++R) {
                        const cellAddress = XLSX.utils.encode_cell({c: C, r: R});
                        if (ws[cellAddress]) {
                            const cellValue = ws[cellAddress].v;
                            if (cellValue) {
                                const length = cellValue.toString().length;
                                if (length > maxLength) maxLength = length;
                            }
                        }
                    }
                    colWidths.push({wch: Math.min(Math.max(maxLength, 10), 50)});
                }
                ws['!cols'] = colWidths;
                
                // Ajouter un pied de page
                const lastRow = range.e.r + 2;
                const footerCell = XLSX.utils.encode_cell({c: 0, r: lastRow});
                if (!ws[footerCell]) ws[footerCell] = {};
                ws[footerCell].v = `Export généré le ${new Date().toLocaleDateString('fr-FR')} par ${currentSecretary.fullName}`;
                ws[footerCell].s = {
                    font: { italic: true, color: { rgb: "666666" } }
                };
                
                XLSX.writeFile(wb, `eleves_cs_lacolombe_complet_${new Date().toISOString().split('T')[0]}.xlsx`);
                showAlert(`Export Excel réussi: ${students.length} élève(s) exporté(s)`, "success");
                
            } catch (error) {
                console.error("Erreur export Excel élèves:", error);
                showAlert("Erreur lors de l'export Excel", "error");
            }
        });

        // Export Excel des enseignants
        document.getElementById('export-teachers-excel-btn').addEventListener('click', async () => {
            try {
                let teachers = [];
                
                // Récupérer tous les enseignants
                const secondarySnap = await getDocs(query(collection(db, 'teachers'), where('status', '!=', 'deleted')));
                secondarySnap.forEach(doc => {
                    const data = doc.data();
                    teachers.push({...data, teacherType: 'secondary'});
                });
                
                const primarySnap = await getDocs(query(collection(db, 'primary_teachers'), where('status', '!=', 'deleted')));
                primarySnap.forEach(doc => {
                    const data = doc.data();
                    teachers.push({...data, teacherType: 'primary'});
                });
                
                const kindergartenSnap = await getDocs(query(collection(db, 'kindergarten_teachers'), where('status', '!=', 'deleted')));
                kindergartenSnap.forEach(doc => {
                    const data = doc.data();
                    teachers.push({...data, teacherType: 'kindergarten'});
                });
                
                if (teachers.length === 0) {
                    showAlert("Aucun enseignant à exporter", "warning");
                    return;
                }
                
                // Préparer les données pour l'export
                const exportData = teachers.map(teacher => ({
                    'Matricule': teacher.matricule,
                    'Nom complet': teacher.fullName,
                    'Type': teacher.teacherType === 'secondary' ? 'Secondaire' : 
                           teacher.teacherType === 'primary' ? 'Primaire' : 'Maternelle',
                    'Téléphone': teacher.phone || '',
                    'Date de naissance': teacher.birthdate,
                    'Lieu de naissance': teacher.birthplace || '',
                    'Sexe': teacher.gender === 'M' ? 'Masculin' : 'Féminin',
                    'Adresse': teacher.address || '',
                    'Matières': teacher.subjects ? teacher.subjects.join(', ') : 'Toutes matières',
                    'Classes': teacher.classes ? teacher.classes.join(', ') : '',
                    'Statut': teacher.status === 'active' ? 'Actif' : 'Inactif',
                    'Date inscription': formatDate(teacher.createdAt?.toDate())
                }));
                
                // Créer le fichier Excel avec mise en forme
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Enseignants CS la Colombe");
                
                // Appliquer des styles aux en-têtes
                const range = XLSX.utils.decode_range(ws['!ref']);
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const address = XLSX.utils.encode_col(C) + "1";
                    if (!ws[address]) continue;
                    ws[address].s = {
                        font: { bold: true, color: { rgb: "FFFFFF" } },
                        fill: { fgColor: { rgb: "3498DB" } },
                        alignment: { horizontal: "center" }
                    };
                }
                
                // Ajuster les largeurs de colonnes
                const colWidths = [];
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    let maxLength = 0;
                    for (let R = range.s.r; R <= range.e.r; ++R) {
                        const cellAddress = XLSX.utils.encode_cell({c: C, r: R});
                        if (ws[cellAddress]) {
                            const cellValue = ws[cellAddress].v;
                            if (cellValue) {
                                const length = cellValue.toString().length;
                                if (length > maxLength) maxLength = length;
                            }
                        }
                    }
                    colWidths.push({wch: Math.min(Math.max(maxLength, 10), 50)});
                }
                ws['!cols'] = colWidths;
                
                // Ajouter un pied de page
                const lastRow = range.e.r + 2;
                const footerCell = XLSX.utils.encode_cell({c: 0, r: lastRow});
                if (!ws[footerCell]) ws[footerCell] = {};
                ws[footerCell].v = `Export généré le ${new Date().toLocaleDateString('fr-FR')} par ${currentSecretary.fullName}`;
                ws[footerCell].s = {
                    font: { italic: true, color: { rgb: "666666" } }
                };
                
                XLSX.writeFile(wb, `enseignants_cs_lacolombe_complet_${new Date().toISOString().split('T')[0]}.xlsx`);
                showAlert(`Export Excel réussi: ${teachers.length} enseignant(s) exporté(s)`, "success");
                
            } catch (error) {
                console.error("Erreur export Excel enseignants:", error);
                showAlert("Erreur lors de l'export Excel", "error");
            }
        });

        // Fermer les modals
        document.querySelectorAll('.close-modal').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.modal').forEach(modal => modal.classList.add('hidden'));
            });
        });

        // Fermer les modals en cliquant à l'extérieur
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                }
            });
        });

        // Gestion du menu burger
        document.getElementById('menu-toggle').addEventListener('click', () => {
            document.querySelector('.sidebar').classList.toggle('collapsed');
        });

        // Fermer le menu en cliquant à l'extérieur sur mobile
        document.addEventListener('click', (e) => {
            const sidebar = document.querySelector('.sidebar');
            const menuToggle = document.getElementById('menu-toggle');
            
            if (window.innerWidth <= 768 && 
                !sidebar.contains(e.target) && 
                !menuToggle.contains(e.target) &&
                !sidebar.classList.contains('collapsed')) {
                sidebar.classList.add('collapsed');
            }
        });

        // Initialisation au chargement
        document.addEventListener('DOMContentLoaded', function() {
            // Initialiser la date du rapport à aujourd'hui
            const today = new Date().toISOString().split('T')[0];
            if (document.getElementById('report-date')) {
                document.getElementById('report-date').value = today;
            }
            
            // Initialiser l'année du rapport
            if (document.getElementById('report-year')) {
                document.getElementById('report-year').value = new Date().getFullYear();
            }
            
            // Initialiser le mois du rapport au mois courant
            const monthNames = {
                0: 'janvier', 1: 'février', 2: 'mars', 3: 'avril', 4: 'mai', 5: 'juin',
                6: 'juillet', 7: 'août', 8: 'septembre', 9: 'octobre', 10: 'novembre', 11: 'décembre'
            };
            const currentMonth = monthNames[new Date().getMonth()];
            if (document.getElementById('report-month')) {
                document.getElementById('report-month').value = currentMonth;
            }
            
            console.log("Portail Secrétariat initialisé avec succès");
        });
    </script>

<!-- Scripts de mise à jour -->


<script>
// Initialisation immédiate
(function() {
  // Vérifier si Service Worker est supporté
  if ('serviceWorker' in navigator) {
    // Enregistrer le Service Worker immédiatement
    window.addEventListener('load', async () => {
      try {
        const registration = await navigator.serviceWorker.register('sw.js');
        console.log('✅ Service Worker enregistré avec succès');
        
        // Vérifier les mises à jour toutes les 15 minutes
        setInterval(() => {
          registration.update();
        }, 15 * 60 * 1000);
        
        // Vérifier maintenant
        setTimeout(() => {
          registration.update();
        }, 10000);
        
      } catch (error) {
        console.error('❌ Erreur Service Worker:', error);
      }
    });
  }
  
  // Afficher la version dans la console
  console.log('%c🚀 hybrilink - Espace Parent', 'color: #3498db; font-size: 16px; font-weight: bold;');
  console.log('%cSystème de mise à jour en temps réel activé', 'color: #2ecc71;');
  
})();

// Fonctions utilitaires
window.reloadApp = function() {
  window.location.reload();
};

window.clearAppCache = function() {
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(registrations => {
      registrations.forEach(registration => {
        registration.unregister();
      });
    });
  }
  
  caches.keys().then(cacheNames => {
    cacheNames.forEach(cacheName => {
      caches.delete(cacheName);
    });
  });
  
  localStorage.clear();
  sessionStorage.clear();
  
  setTimeout(() => {
    window.location.reload();
  }, 1000);
};
</script>

<script>
<script>
// Initialisation immédiate
(function() {
  // Vérifier si Service Worker est supporté
  if ('serviceWorker' in navigator) {
    // Enregistrer le Service Worker immédiatement
    window.addEventListener('load', async () => {
      try {
        const registration = await navigator.serviceWorker.register('sw.js');
        console.log('✅ Service Worker enregistré avec succès');
        
        // Vérifier les mises à jour toutes les 15 minutes
        setInterval(() => {
          registration.update();
        }, 15 * 60 * 1000);
        
        // Vérifier maintenant
        setTimeout(() => {
          registration.update();
        }, 10000);
        
      } catch (error) {
        console.error('❌ Erreur Service Worker:', error);
      }
    });
  }
  
  // Afficher la version dans la console
  console.log('%c🚀 hybrilink - Espace Parent', 'color: #3498db; font-size: 16px; font-weight: bold;');
  console.log('%cSystème de mise à jour en temps réel activé', 'color: #2ecc71;');
  
})();

// Fonctions utilitaires
window.reloadApp = function() {
  window.location.reload();
};

window.clearAppCache = function() {
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(registrations => {
      registrations.forEach(registration => {
        registration.unregister();
      });
    });
  }
  
  caches.keys().then(cacheNames => {
    cacheNames.forEach(cacheName => {
      caches.delete(cacheName);
    });
  });
  
  localStorage.clear();
  sessionStorage.clear();
  
  setTimeout(() => {
    window.location.reload();
  }, 1000);
};

</script>

<script>

 Afficher une notification de mise à jour
function showUpdateNotification(newVersion, previousVersion) {
  const updateToast = document.createElement('div');
  updateToast.className = 'notification-toast success';
  updateToast.innerHTML = `
    <div class="notification-header">
      <div class="notification-title">
        <i class="fas fa-sync-alt"></i> Mise à jour disponible
      </div>
      <button class="notification-close">&times;</button>
    </div>
    <div class="notification-body">
      <p>Une nouvelle version (${newVersion}) de l'application est disponible !</p>
      <p><small>Version précédente: ${previousVersion || 'inconnue'}</small></p>
      <div class="notification-actions" style="margin-top: 10px;">
        <button class="btn btn-primary btn-sm" id="update-app-btn">
          <i class="fas fa-redo"></i> Mettre à jour
        </button>
        <button class="btn btn-secondary btn-sm" id="later-update-btn">
          Plus tard
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(updateToast);
  
  setTimeout(() => {
    updateToast.classList.add('show');
  }, 1000);
  
  // Gérer le bouton de mise à jour
  document.getElementById('update-app-btn').addEventListener('click', () => {
    updateToast.classList.remove('show');
    setTimeout(() => updateToast.remove(), 300);
    
    // Recharger la page pour activer la nouvelle version
    window.location.reload();
  });
  
  // Gérer le bouton "Plus tard"
  document.getElementById('later-update-btn').addEventListener('click', () => {
    updateToast.classList.remove('show');
    setTimeout(() => updateToast.remove(), 300);
  });
  
  // Fermer le toast
  updateToast.querySelector('.notification-close').addEventListener('click', () => {
    updateToast.classList.remove('show');
    setTimeout(() => updateToast.remove(), 300);
  });
}

// Afficher une notification de mise à jour obligatoire
function showMandatoryUpdateNotification(newVersion, currentVersion, updateUrl) {
  const mandatoryToast = document.createElement('div');
  mandatoryToast.className = 'notification-toast danger';
  mandatoryToast.style.zIndex = '99999'; // Assurez-vous qu'il est au-dessus de tout
  mandatoryToast.innerHTML = `
    <div class="notification-header">
      <div class="notification-title">
        <i class="fas fa-exclamation-triangle"></i> Mise à jour REQUISE
      </div>
      <button class="notification-close" disabled>&times;</button>
    </div>
    <div class="notification-body">
      <p><strong>Mise à jour obligatoire !</strong></p>
      <p>La version ${newVersion} est requise pour continuer à utiliser l'application.</p>
      <p><small>Votre version actuelle: ${currentVersion}</small></p>
      <div class="notification-actions" style="margin-top: 10px;">
        <button class="btn btn-warning btn-sm" id="mandatory-update-btn">
          <i class="fas fa-download"></i> Mettre à jour maintenant
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(mandatoryToast);
  
  setTimeout(() => {
    mandatoryToast.classList.add('show');
    
    // Bloquer l'interface utilisateur
    const overlay = document.createElement('div');
    overlay.style.position = 'fixed';
    overlay.style.top = '0';
    overlay.style.left = '0';
    overlay.style.width = '100%';
    overlay.style.height = '100%';
    overlay.style.backgroundColor = 'rgba(0,0,0,0.7)';
    overlay.style.zIndex = '99998';
    overlay.id = 'update-overlay';
    document.body.appendChild(overlay);
  }, 500);
  
  // Gérer le bouton de mise à jour obligatoire
  document.getElementById('mandatory-update-btn').addEventListener('click', () => {
    // Rediriger vers l'URL de mise à jour
    window.location.href = updateUrl;
  });
  
  // Empêcher la fermeture
  mandatoryToast.querySelector('.notification-close').addEventListener('click', (e) => {
    e.preventDefault();
    showToast('Cette mise à jour est obligatoire pour continuer à utiliser l\'application', 'warning');
  });
}

// Vérifier les mises à jour manuellement
async function checkForUpdates() {
  try {
    const response = await fetch(`/version-check.json?t=${Date.now()}`);
    const data = await response.json();
    
    // Vérifier la version actuelle depuis le service worker
    if (navigator.serviceWorker.controller) {
      navigator.serviceWorker.controller.postMessage({
        type: 'GET_VERSION'
      });
    }
    
    // Comparer avec la version stockée localement
    const currentVersion = localStorage.getItem('app_version');
    
    if (currentVersion !== data.version) {
      // Nouvelle version disponible
      showUpdateNotification(data.version, currentVersion);
      localStorage.setItem('app_version', data.version);
      
      // Si la mise à jour est obligatoire
      if (data.mandatory === true) {
        showMandatoryUpdateNotification(data.version, currentVersion, data.updateUrl);
      }
    }
    
  } catch (error) {
    console.error('Erreur lors de la vérification des mises à jour:', error);
  }
}

// Vérifier la version au chargement
window.addEventListener('load', () => {
  // Stocker la version actuelle
  if (!localStorage.getItem('app_version')) {
    localStorage.setItem('app_version', '1.0.0');
  }
  
  // Vérifier les mises à jour après 5 secondes
  setTimeout(() => {
    checkForUpdates();
  }, 5000);
});

// Écouter les événements de mise à jour du service worker
let refreshing = false;
navigator.serviceWorker.addEventListener('controllerchange', () => {
  if (!refreshing) {
    refreshing = true;
    window.location.reload();
  }
});
</script>
<script>
// FORCE UPDATE SCRIPT
(function() {
  // Vérifier si un force update est demandé
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.has('forceUpdate')) {
    console.log('🔄 Force update activé');
    
    // Vider tous les caches
    if ('caches' in window) {
      caches.keys().then(names => {
        names.forEach(name => caches.delete(name));
      });
    }
    
    // Rediriger sans le paramètre
    setTimeout(() => {
      window.location.href = window.location.href.split('?')[0];
    }, 100);
  }
  
  // Écouter les messages du SW pour redémarrer
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.addEventListener('message', event => {
      if (event.data && event.data.type === 'RELOAD_PAGE') {
        console.log('🔄 Redémarrage demandé par SW');
        window.location.reload();
      }
    });
  }
})();
</script>

</body>
</html>

 
